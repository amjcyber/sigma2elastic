{"id":"b1c50487-1967-4315-a026-6491686d860e","created_by":"frack113","name":"Dump Office Macro Files from Commandline","tags":["attack.initial_access","attack.t1566.001"],"interval":"5m","description":"A office file with macro is created from a commandline or a script","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(file.path:(/.*\\.[Dd][Oo][Cc][Mm]/ OR /.*\\.[Dd][Oo][Tt][Mm]/ OR /.*\\.[Xx][Ll][Ss][Mm]/ OR /.*\\.[Xx][Ll][Tt][Mm]/ OR /.*\\.[Pp][Oo][Tt][Mm]/ OR /.*\\.[Pp][Pp][Tt][Mm]/ OR /.*\\.[Pp][Pp][Tt][Xx]/) AND (process.executable:(/.*\\\\[Cc][Mm][Dd]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee]/) OR process.parent.executable:(/.*\\\\[Cc][Mm][Dd]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee]/)))","rule_id":"b1c50487-1967-4315-a026-6491686d860e","timestamp_override":"event.ingested","references":["https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1566.001/T1566.001.md","https://docs.microsoft.com/en-us/deployoffice/compat/office-file-format-reference"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(file.path:(*.docm OR *.dotm OR *.xlsm OR *.xltm OR *.potm OR *.pptm OR *.pptx) AND (process.executable:(*\\\\cmd.exe OR *\\\\powershell.exe OR *\\\\pwsh.exe) OR process.parent.executable:(*\\\\cmd.exe OR *\\\\powershell.exe OR *\\\\pwsh.exe)))`"}
