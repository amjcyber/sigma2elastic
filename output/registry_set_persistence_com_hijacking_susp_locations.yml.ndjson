{"id":"3d968d17-ffa4-4bc0-bfdc-f139de76ce77","created_by":"Nasreddine Bencherchali","name":"COM Hijacking For Persistence With Suspicious Locations","tags":["attack.persistence","attack.t1546.015"],"interval":"5m","description":"Detects potential COM object hijacking where the \"Server\" (In/Out) is pointing to a supsicious or unsuale location","risk_score":73,"enabled":true,"severity":"high","false_positives":["Probable legitimate applications. If you find these please add them to an exclusion list"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:(/[Hh][Kk][Cc][Rr]\\\\[Cc][Ll][Ss][Ii][Dd]\\\\.*/ OR /[Hh][Kk][Ee][Yy]_[Cc][Ll][Aa][Ss][Ss][Ee][Ss]_[Rr][Oo][Oo][Tt]\\\\[Cc][Ll][Ss][Ii][Dd]\\\\.*/ OR /[Hh][Kk][Cc][Uu]\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Cc][Ll][Ss][Ii][Dd]\\\\.*/ OR /[Hh][Kk][Ee][Yy]_[Cc][Uu][Rr][Rr][Ee][Nn][Tt]_[Uu][Ss][Ee][Rr]\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Cc][Ll][Ss][Ii][Dd]\\\\.*/) AND registry.path:(/.*\\\\[Ii][Nn][Pp][Rr][Oo][Cc][Ss][Ee][Rr][Vv][Ee][Rr]32\\\\\\([Dd][Ee][Ff][Aa][Uu][Ll][Tt]\\)/ OR /.*\\\\[Ll][Oo][Cc][Aa][Ll][Ss][Ee][Rr][Vv][Ee][Rr]32\\\\\\([Dd][Ee][Ff][Aa][Uu][Ll][Tt]\\)/) AND winlog.event_data.Details:(/.*\\\\[Uu][Ss][Ee][Rr][Ss]\\\\[Pp][Uu][Bb][Ll][Ii][Cc]\\\\.*/ OR /.*\\\\[Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\\\.*/ OR /.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\[Tt][Ee][Mm][Pp]\\\\.*/ OR /.*\\\\[Dd][Oo][Ww][Nn][Ll][Oo][Aa][Dd][Ss]\\\\.*/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp]\\\\.*/ OR /.*\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Tt][Aa][Rr][Tt]\\ [Mm][Ee][Nn][Uu]\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Ss]\\\\[Ss][Tt][Aa][Rr][Tt][Uu][Pp]\\\\.*/ OR /.*\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ss][Pp][Oo][Oo][Ll]\\\\[Dd][Rr][Ii][Vv][Ee][Rr][Ss]\\\\[Cc][Oo][Ll][Oo][Rr]\\\\.*/ OR /.*%[Tt][Ee][Mm][Pp]%.*/ OR /.*%[Aa][Pp][Pp][Dd][Aa][Tt][Aa]%.*/))","rule_id":"3d968d17-ffa4-4bc0-bfdc-f139de76ce77","timestamp_override":"event.ingested","references":["https://www.microsoft.com/security/blog/2022/07/27/untangling-knotweed-european-private-sector-offensive-actor-using-0-day-exploits/ (idea)"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(winlog.event_data.EventType:SetValue AND registry.path:(HKCR\\\\CLSID\\\\* OR HKEY_CLASSES_ROOT\\\\CLSID\\\\* OR HKCU\\\\Software\\\\Classes\\\\CLSID\\\\* OR HKEY_CURRENT_USER\\\\Software\\\\Classes\\\\CLSID\\\\*) AND registry.path:(*\\\\InprocServer32\\\\\\(Default\\) OR *\\\\LocalServer32\\\\\\(Default\\)) AND winlog.event_data.Details:(*\\\\Users\\\\Public\\\\* OR *\\\\Desktop\\\\* OR *\\\\AppData\\\\Local\\\\Temp\\\\* OR *\\\\Downloads\\\\* OR *\\\\Windows\\\\Temp\\\\* OR *\\\\Microsoft\\\\Windows\\\\Start\\ Menu\\\\Programs\\\\Startup\\\\* OR *\\\\System32\\\\spool\\\\drivers\\\\color\\\\* OR *%temp%* OR *%appdata%*))`"}
