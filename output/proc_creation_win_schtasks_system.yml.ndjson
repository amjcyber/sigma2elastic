{"id":"89ca78fd-b37c-4310-b3d3-81a023f83936","created_by":"Nasreddine Bencherchali","name":"Schtasks Creation Or Modification With SYSTEM Privileges","tags":["attack.execution","attack.persistence","attack.t1053.005"],"interval":"5m","description":"Detects the creation or update of a scheduled task to run with \"NT AUTHORITY\\SYSTEM\" privileges","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.executable:/.*\\\\[Ss][Cc][Hh][Tt][Aa][Ss][Kk][Ss]\\.[Ee][Xx][Ee]/ AND process.command_line:(/.*\\ \\/[Cc][Hh][Aa][Nn][Gg][Ee]\\ .*/ OR /.*\\ \\/[Cc][Rr][Ee][Aa][Tt][Ee]\\ .*/) AND process.command_line:/.*\\/[Rr][Uu]\\ .*/ AND process.command_line:(/.*[Nn][Tt]\\ [Aa][Uu][Tt].*/ OR /.*\\ [Ss][Yy][Ss][Tt][Ee][Mm]\\ .*/)) AND (NOT (process.parent.executable:/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\[Tt][Ee][Mm][Pp]\\\\.*/ AND process.parent.executable:/.*[Tt][Ee][Aa][Mm][Vv][Ii][Ee][Ww][Ee][Rr]_\\.[Ee][Xx][Ee].*/ AND process.executable:/.*\\\\[Ss][Cc][Hh][Tt][Aa][Ss][Kk][Ss]\\.[Ee][Xx][Ee]/ AND process.command_line:/.*\\/[Tt][Nn]\\ [Tt][Vv][Ii][Nn][Ss][Tt][Aa][Ll][Ll][Rr][Ee][Ss][Tt][Oo][Rr][Ee].*/)))","rule_id":"89ca78fd-b37c-4310-b3d3-81a023f83936","timestamp_override":"event.ingested","references":["https://www.elastic.co/security-labs/exploring-the-qbot-attack-pattern","https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.executable:*\\\\schtasks.exe AND process.command_line:(*\\ \\/change\\ * OR *\\ \\/create\\ *) AND process.command_line:*\\/ru\\ * AND process.command_line:(*NT\\ AUT* OR *\\ SYSTEM\\ *)) AND (NOT (process.parent.executable:*\\\\AppData\\\\Local\\\\Temp\\\\* AND process.parent.executable:*TeamViewer_.exe* AND process.executable:*\\\\schtasks.exe AND process.command_line:*\\/TN\\ TVInstallRestore*)))`"}
