{"id":"d813d662-785b-42ca-8b4a-f7457d78d5a9","created_by":"frack113","name":"Suspicious Load of Advapi31.dll","tags":["attack.defense_evasion","attack.t1070"],"interval":"5m","description":"Detects the load of advapi31.dll by a process running in an uncommon folder","risk_score":73,"enabled":true,"severity":"informational","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(file.path:/.*\\\\[Aa][Dd][Vv][Aa][Pp][Ii]32\\.[Dd][Ll][Ll]/ AND (NOT ((process.executable:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\ \\([Xx]86\\)\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\.*/)) OR (process.executable:/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Dd][Aa][Tt][Aa]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Dd][Ee][Ff][Ee][Nn][Dd][Ee][Rr]\\\\[Pp][Ll][Aa][Tt][Ff][Oo][Rr][Mm]\\\\.*/ AND process.executable:/.*\\\\[Mm][Pp][Cc][Mm][Dd][Rr][Uu][Nn]\\.[Ee][Xx][Ee]/) OR (process.executable:/[Cc]\\:\\\\[Uu][Ss][Ee][Rr][Ss]\\\\.*/ AND process.executable:/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Oo][Nn][Ee][Dd][Rr][Ii][Vv][Ee]\\\\.*/ AND process.executable:/.*[Ff][Ii][Ll][Ee][Cc][Oo][Aa][Uu][Tt][Hh]\\.[Ee][Xx][Ee]/))))","rule_id":"d813d662-785b-42ca-8b4a-f7457d78d5a9","timestamp_override":"event.ingested","references":["https://github.com/hlldz/Phant0m"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(file.path:*\\\\advapi32.dll AND (NOT ((process.executable:(C\\:\\\\Windows\\\\* OR C\\:\\\\Program\\ Files\\ \\(x86\\)\\\\* OR C\\:\\\\Program\\ Files\\\\*)) OR (process.executable:C\\:\\\\ProgramData\\\\Microsoft\\\\Windows\\ Defender\\\\platform\\\\* AND process.executable:*\\\\MpCmdRun.exe) OR (process.executable:C\\:\\\\Users\\\\* AND process.executable:*\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\* AND process.executable:*FileCoAuth.exe))))`"}
