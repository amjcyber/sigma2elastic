{"id":"312d0384-401c-4b8b-abdf-685ffba9a332","created_by":"Nasreddine Bencherchali (rule),  Azure-Sentinel (idea)","name":"Email Exifiltration Via Powershell","tags":["attack.exfiltration"],"interval":"5m","description":"Detects email exfiltration via powershell cmdlets","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(process.executable:(/.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee]/) AND process.command_line:/.*[Aa][Dd][Dd]\\-[Pp][Ss][Ss][Nn][Aa][Pp][Ii][Nn].*/ AND process.command_line:/.*[Gg][Ee][Tt]\\-[Rr][Ee][Cc][Ii][Pp][Ii][Ee][Nn][Tt].*/ AND process.command_line:/.*\\-[Ee][Xx][Pp][Aa][Nn][Dd][Pp][Rr][Oo][Pp][Ee][Rr][Tt][Yy].*/ AND process.command_line:/.*[Ee][Mm][Aa][Ii][Ll][Aa][Dd][Dd][Rr][Ee][Ss][Ss][Ee][Ss].*/ AND process.command_line:/.*[Ss][Mm][Tt][Pp][Aa][Dd][Dd][Rr][Ee][Ss][Ss].*/ AND process.command_line:/.*\\-[Hh][Ii][Dd][Ee][Tt][Aa][Bb][Ll][Ee][Hh][Ee][Aa][Dd][Ee][Rr][Ss].*/)","rule_id":"312d0384-401c-4b8b-abdf-685ffba9a332","timestamp_override":"event.ingested","references":["https://www.microsoft.com/security/blog/2022/09/07/profiling-dev-0270-phosphorus-ransomware-operations/","https://github.com/Azure/Azure-Sentinel/blob/7e6aa438e254d468feec061618a7877aa528ee9f/Hunting%20Queries/Microsoft%20365%20Defender/Ransomware/DEV-0270/Email%20data%20exfiltration%20via%20PowerShell.yaml"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(process.executable:(*\\\\powershell.exe OR *\\\\pwsh.exe) AND process.command_line:*Add\\-PSSnapin* AND process.command_line:*Get\\-Recipient* AND process.command_line:*\\-ExpandProperty* AND process.command_line:*EmailAddresses* AND process.command_line:*SmtpAddress* AND process.command_line:*\\-hidetableheaders*)`"}
