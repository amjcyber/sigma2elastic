{"id":"85c312b7-f44d-4a51-a024-d671c40b49fc","created_by":"Nasreddine Bencherchali","name":"Sc Or Set-Service Cmdlet Execution to Disable Services","tags":["attack.execution","attack.defense_evasion","attack.t1562.001"],"interval":"5m","description":"Detects when attackers use \"sc.exe\" or the powershell \"Set-Service\" cmdlet to change the startup type of a service to \"disabled\"","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Administrators settings a service to disable via script or cli for testing purposes"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(((process.executable:/.*\\\\[Ss][Cc]\\.[Ee][Xx][Ee]/ OR process.pe.original_file_name:/[Ss][Cc]\\.[Ee][Xx][Ee]/) AND (process.command_line:/.*\\ [Cc][Oo][Nn][Ff][Ii][Gg]\\ .*/ AND process.command_line:/.*[Ss][Tt][Aa][Rr][Tt].*/ AND process.command_line:(/.*[Dd][Ii][Ss][Aa][Bb][Ll][Ee][Dd].*/ OR /.*[Dd][Ee][Mm][Aa][Nn][Dd].*/))) OR (process.command_line:/.*[Ss][Ee][Tt]\\-[Ss][Ee][Rr][Vv][Ii][Cc][Ee].*/ AND process.command_line:/.*\\-[Ss][Tt][Aa][Rr][Tt][Uu][Pp][Tt][Yy][Pp][Ee].*/ AND process.command_line:(/.*[Dd][Ii][Ss][Aa][Bb][Ll][Ee][Dd].*/ OR /.*[Mm][Aa][Nn][Uu][Aa][Ll].*/)))","rule_id":"85c312b7-f44d-4a51-a024-d671c40b49fc","timestamp_override":"event.ingested","references":["https://www.virustotal.com/gui/file/38283b775552da8981452941ea74191aa0d203edd3f61fb2dee7b0aea3514955"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(((process.executable:*\\\\sc.exe OR process.pe.original_file_name:sc.exe) AND (process.command_line:*\\ config\\ * AND process.command_line:*start* AND process.command_line:(*disabled* OR *demand*))) OR (process.command_line:*Set\\-Service* AND process.command_line:*\\-StartupType* AND process.command_line:(*Disabled* OR *Manual*)))`"}
