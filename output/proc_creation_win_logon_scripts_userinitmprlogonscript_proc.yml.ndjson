{"id":"0a98a10c-685d-4ab0-bddc-b6bdd1d48458","created_by":"Tom Ueltschi (@c_APT_ure), Tim Shelton","name":"Logon Scripts (UserInitMprLogonScript)","tags":["attack.t1037.001","attack.persistence"],"interval":"5m","description":"Detects creation or execution of UserInitMprLogonScript persistence method","risk_score":73,"enabled":true,"severity":"high","false_positives":["Exclude legitimate logon scripts"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.parent.executable:/.*\\\\[Uu][Ss][Ee][Rr][Ii][Nn][Ii][Tt]\\.[Ee][Xx][Ee]/ AND (NOT ((process.executable:(/.*[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Rr][Oo][Qq][Uu][Oo][Tt][Aa]\\.[Ee][Xx][Ee]/)) OR (process.command_line:(/.*[Nn][Ee][Tt][Ll][Oo][Gg][Oo][Nn].*\\.[Bb][Aa][Tt].*/ OR /.*[Uu][Ss][Rr][Ll][Oo][Gg][Oo][Nn]\\.[Cc][Mm][Dd].*/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\.[Ee][Xx][Ee].*/)) OR (process.executable:/.*\\\\[Cc][Ii][Tt][Rr][Ii][Xx]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ii][Cc][Aa][Ss][Tt]\\.[Ee][Xx][Ee]/)))) OR process.command_line:/.*[Uu][Ss][Ee][Rr][Ii][Nn][Ii][Tt][Mm][Pp][Rr][Ll][Oo][Gg][Oo][Nn][Ss][Cc][Rr][Ii][Pp][Tt].*/)","rule_id":"0a98a10c-685d-4ab0-bddc-b6bdd1d48458","timestamp_override":"event.ingested","references":["https://attack.mitre.org/techniques/T1037/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.parent.executable:*\\\\userinit.exe AND (NOT ((process.executable:(*explorer.exe OR *\\\\proquota.exe)) OR (process.command_line:(*netlogon*.bat* OR *UsrLogon.cmd* OR *C\\:\\\\WINDOWS\\\\Explorer.EXE*)) OR (process.executable:*\\\\Citrix\\\\System32\\\\icast.exe)))) OR process.command_line:*UserInitMprLogonScript*)`"}
