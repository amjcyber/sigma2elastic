{"id":"671bb7e3-a020-4824-a00e-2ee5b55f385e","created_by":"Roberto Rodriguez @Cyb3rWard0g","name":"WMI Modules Loaded","tags":["attack.execution","attack.t1047"],"interval":"5m","description":"Detects non wmiprvse loading WMI modules","risk_score":73,"enabled":true,"severity":"informational","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((file.path:(/.*\\\\[Ww][Mm][Ii][Cc][Ll][Nn][Tt]\\.[Dd][Ll][Ll]/ OR /.*\\\\[Ww][Mm][Ii][Aa][Pp][Rr][Pp][Ll]\\.[Dd][Ll][Ll]/ OR /.*\\\\[Ww][Mm][Ii][Pp][Rr][Oo][Vv]\\.[Dd][Ll][Ll]/ OR /.*\\\\[Ww][Mm][Ii][Uu][Tt][Ii][Ll][Ss]\\.[Dd][Ll][Ll]/ OR /.*\\\\[Ww][Bb][Ee][Mm][Cc][Oo][Mm][Nn]\\.[Dd][Ll][Ll]/ OR /.*\\\\[Ww][Bb][Ee][Mm][Pp][Rr][Oo][Xx]\\.[Dd][Ll][Ll]/ OR /.*\\\\[Ww][Mm][Ii][Nn][Ee][Tt]_[Uu][Tt][Ii][Ll][Ss]\\.[Dd][Ll][Ll]/ OR /.*\\\\[Ww][Bb][Ee][Mm][Ss][Vv][Cc]\\.[Dd][Ll][Ll]/ OR /.*\\\\[Ff][Aa][Ss][Tt][Pp][Rr][Oo][Xx]\\.[Dd][Ll][Ll]/) AND (NOT (process.executable:(/.*\\\\[Ww][Mm][Ii][Pp][Rr][Vv][Ss][Ee]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Mm][Ii][Aa][Pp][Ss][Rr][Vv]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Vv][Cc][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Dd][Ee][Vv][Ii][Cc][Ee][Cc][Ee][Nn][Ss][Uu][Ss]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Oo][Mm][Pp][Aa][Tt][Tt][Ee][Ll][Rr][Uu][Nn][Nn][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Dd][Ii][Aa][Gg][Nn][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Ii][Hh][Cc][Ll][Ii][Ee][Nn][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Nn][Gg][Ee][Nn][Tt][Aa][Ss][Kk]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Tt][Aa][Ss][Kk][Hh][Oo][Ss][Tt][Ww]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Mm][Oo][Uu][Ss][Oo][Cc][Oo][Rr][Ee][Ww][Oo][Rr][Kk][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ww][Bb][Ee][Mm]\\\\[Ww][Mm][Ii][Aa][Dd][Aa][Pp]\\.[Ee][Xx][Ee]/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Mm][Oo][Nn]64\\.[Ee][Xx][Ee]/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Mm][Oo][Nn]\\.[Ee][Xx][Ee]/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ww][Bb][Ee][Mm]\\\\[Uu][Nn][Ss][Ee][Cc][Aa][Pp][Pp]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ll][Oo][Gg][Mm][Aa][Nn]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Yy][Ss][Tt][Ee][Mm][Ii][Nn][Ff][Oo]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Nn][Vv][Cc][Oo][Nn][Tt][Aa][Ii][Nn][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ww][Bb][Ee][Mm]\\\\[Ww][Mm][Ii][Cc]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Oo][Pp][Ee][Rr][Aa]_[Aa][Uu][Tt][Oo][Uu][Pp][Dd][Aa][Tt][Ee]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Ss][Mm][Pp][Ee][Nn][Gg]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Tt][Hh][Oo][Rr]64\\.[Ee][Xx][Ee]/ OR /.*\\\\[Tt][Hh][Oo][Rr]\\.[Ee][Xx][Ee]/)))) AND (NOT (process.executable:(/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\ \\([Xx]86\\)\\\\.*/))))","rule_id":"671bb7e3-a020-4824-a00e-2ee5b55f385e","timestamp_override":"event.ingested","references":["https://threathunterplaybook.com/notebooks/windows/02_execution/WIN-190811201010.html"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((file.path:(*\\\\wmiclnt.dll OR *\\\\WmiApRpl.dll OR *\\\\wmiprov.dll OR *\\\\wmiutils.dll OR *\\\\wbemcomn.dll OR *\\\\wbemprox.dll OR *\\\\WMINet_Utils.dll OR *\\\\wbemsvc.dll OR *\\\\fastprox.dll) AND (NOT (process.executable:(*\\\\WmiPrvSE.exe OR *\\\\WmiApSrv.exe OR *\\\\svchost.exe OR *\\\\DeviceCensus.exe OR *\\\\CompatTelRunner.exe OR *\\\\sdiagnhost.exe OR *\\\\SIHClient.exe OR *\\\\ngentask.exe OR *\\\\windows\\\\system32\\\\taskhostw.exe OR *\\\\windows\\\\system32\\\\MoUsoCoreWorker.exe OR *\\\\windows\\\\system32\\\\wbem\\\\WMIADAP.exe OR *C\\:\\\\Windows\\\\Sysmon64.exe OR *C\\:\\\\Windows\\\\Sysmon.exe OR *C\\:\\\\Windows\\\\System32\\\\wbem\\\\unsecapp.exe OR *\\\\logman.exe OR *\\\\systeminfo.exe OR *\\\\nvcontainer.exe OR *C\\:\\\\Windows\\\\System32\\\\wbem\\\\WMIC.exe OR *\\\\explorer.exe OR *\\\\opera_autoupdate.exe OR *\\\\MsMpEng.exe OR *\\\\thor64.exe OR *\\\\thor.exe)))) AND (NOT (process.executable:(C\\:\\\\Program\\ Files\\\\* OR C\\:\\\\Program\\ Files\\ \\(x86\\)\\\\*))))`"}
