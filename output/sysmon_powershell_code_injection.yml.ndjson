{"id":"eeb2e3dc-c1f4-40dd-9bd5-149ee465ad50","created_by":"Nikita Nazarov, oscd.community","name":"Accessing WinAPI in PowerShell. Code Injection","tags":["attack.execution","attack.t1059.001"],"interval":"5m","description":"Detects the creation of a remote thread from a Powershell process to another process","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(process.executable:(/.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee]/) AND (NOT ((SourceParentImage:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Cc][Oo][Mm][Pp][Aa][Tt][Tt][Ee][Ll][Rr][Uu][Nn][Nn][Ee][Rr]\\.[Ee][Xx][Ee]/))))","rule_id":"eeb2e3dc-c1f4-40dd-9bd5-149ee465ad50","timestamp_override":"event.ingested","references":["https://speakerdeck.com/heirhabarov/hunting-for-powershell-abuse"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(process.executable:(*\\\\powershell.exe OR *\\\\pwsh.exe) AND (NOT ((SourceParentImage:C\\:\\\\Windows\\\\System32\\\\CompatTelRunner.exe))))`"}
