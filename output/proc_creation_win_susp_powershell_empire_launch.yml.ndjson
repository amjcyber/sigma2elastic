{"id":"79f4ede3-402e-41c8-bc3e-ebbf5f162581","created_by":"Florian Roth","name":"Empire PowerShell Launch Parameters","tags":["attack.execution","attack.t1059.001"],"interval":"5m","description":"Detects suspicious powershell command line parameters used in Empire","risk_score":73,"enabled":true,"severity":"high","false_positives":["Other tools that incidentally use the same command line parameters"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"process.command_line:(/.*\\ \\-[Nn][Oo][Pp]\\ \\-[Ss][Tt][Aa]\\ \\-[Nn][Oo][Nn][Ii]\\ \\-[Ww]\\ [Hh][Ii][Dd][Dd][Ee][Nn]\\ \\-[Ee][Nn][Cc]\\ .*/ OR /.*\\ \\-[Nn][Oo][Pp]\\ \\-[Ss][Tt][Aa]\\ \\-[Ww]\\ 1\\ \\-[Ee][Nn][Cc]\\ .*/ OR /.*\\ \\-[Nn][Oo][Pp]\\ \\-[Nn][Oo][Nn][Ii]\\ \\-[Ww]\\ [Hh][Ii][Dd][Dd][Ee][Nn]\\ \\-[Ee][Nn][Cc]\\ .*/ OR /.*\\ \\-[Nn][Oo][Pp]\\ \\-[Ss][Tt][Aa]\\ \\-[Ww]\\ 1\\ \\-[Ee][Nn][Cc].*/ OR /.*\\ \\-[Ee][Nn][Cc]\\ \\ [Ss][Qq][Bb].*/ OR /.*\\ \\-[Nn][Oo][Pp]\\ \\-[Ee][Xx][Ee][Cc]\\ [Bb][Yy][Pp][Aa][Ss][Ss]\\ \\-[Ee][Nn][Cc][Oo][Dd][Ee][Dd][Cc][Oo][Mm][Mm][Aa][Nn][Dd]\\ .*/)","rule_id":"79f4ede3-402e-41c8-bc3e-ebbf5f162581","timestamp_override":"event.ingested","references":["https://github.com/EmpireProject/Empire/blob/c2ba61ca8d2031dad0cfc1d5770ba723e8b710db/lib/common/helpers.py#L165","https://github.com/EmpireProject/Empire/blob/e37fb2eef8ff8f5a0a689f1589f424906fe13055/lib/modules/powershell/persistence/powerbreach/deaduser.py#L191","https://github.com/EmpireProject/Empire/blob/e37fb2eef8ff8f5a0a689f1589f424906fe13055/lib/modules/powershell/persistence/powerbreach/resolver.py#L178","https://github.com/EmpireProject/Empire/blob/e37fb2eef8ff8f5a0a689f1589f424906fe13055/data/module_source/privesc/Invoke-EventVwrBypass.ps1#L64"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`process.command_line:(*\\ \\-NoP\\ \\-sta\\ \\-NonI\\ \\-W\\ Hidden\\ \\-Enc\\ * OR *\\ \\-noP\\ \\-sta\\ \\-w\\ 1\\ \\-enc\\ * OR *\\ \\-NoP\\ \\-NonI\\ \\-W\\ Hidden\\ \\-enc\\ * OR *\\ \\-noP\\ \\-sta\\ \\-w\\ 1\\ \\-enc* OR *\\ \\-enc\\ \\ SQB* OR *\\ \\-nop\\ \\-exec\\ bypass\\ \\-EncodedCommand\\ *)`"}
