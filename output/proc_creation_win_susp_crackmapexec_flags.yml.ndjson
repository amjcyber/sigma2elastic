{"id":"42a993dd-bb3e-48c8-b372-4d6684c4106c","created_by":"Florian Roth","name":"CrackMapExec Command Line Flags","tags":null,"interval":"5m","description":"This rule detect common flag combinations used by CrackMapExec in order to detect its use even if the binary has been replaced.","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.command_line:/.*\\ \\-[Mm]\\ [Pp][Ee]_[Ii][Nn][Jj][Ee][Cc][Tt]\\ .*/ OR (process.command_line:/.*\\ \\-\\-[Ll][Oo][Cc][Aa][Ll]\\-[Aa][Uu][Tt][Hh].*/ AND process.command_line:/.*\\ \\-[Uu]\\ .*/ AND process.command_line:/.*\\ \\-[Xx]\\ .*/) OR (process.command_line:/.*\\ \\-\\-[Ll][Oo][Cc][Aa][Ll]\\-[Aa][Uu][Tt][Hh].*/ AND process.command_line:/.*\\ \\-[Uu]\\ .*/ AND process.command_line:/.*\\ \\-[Pp]\\ .*/ AND process.command_line:/.*\\ \\-[Hh]\\ '[Nn][Tt][Hh][Aa][Ss][Hh]'.*/) OR (process.command_line:/.*\\ [Mm][Ss][Ss][Qq][Ll]\\ .*/ AND process.command_line:/.*\\ \\-[Uu]\\ .*/ AND process.command_line:/.*\\ \\-[Pp]\\ .*/ AND process.command_line:/.*\\ \\-[Mm]\\ .*/ AND process.command_line:/.*\\ \\-[Dd]\\ .*/) OR (process.command_line:/.*\\ [Ss][Mm][Bb]\\ .*/ AND process.command_line:/.*\\ \\-[Uu]\\ .*/ AND process.command_line:/.*\\ \\-[Hh]\\ .*/ AND process.command_line:/.*\\ \\-[Mm]\\ .*/ AND process.command_line:/.*\\ \\-[Oo]\\ .*/) OR (process.command_line:/.*\\ [Ss][Mm][Bb]\\ .*/ AND process.command_line:/.*\\ \\-[Uu]\\ .*/ AND process.command_line:/.*\\ \\-[Pp]\\ .*/ AND process.command_line:/.*\\ \\-\\-[Ll][Oo][Cc][Aa][Ll]\\-[Aa][Uu][Tt][Hh].*/)) OR (process.command_line:/.*\\ \\-\\-[Ll][Oo][Cc][Aa][Ll]\\-[Aa][Uu][Tt][Hh].*/ AND process.command_line:/.*\\ \\-[Uu]\\ .*/ AND process.command_line:/.*\\ \\-[Pp]\\ .*/ AND process.command_line:/.*\\ 10\\..*/ AND process.command_line:/.*\\ 192\\.168\\..*/ AND process.command_line:/.*\\/24\\ .*/))","rule_id":"42a993dd-bb3e-48c8-b372-4d6684c4106c","timestamp_override":"event.ingested","references":["https://mpgn.gitbook.io/crackmapexec/smb-protocol/authentication/checking-credentials-local","https://www.mandiant.com/resources/telegram-malware-iranian-espionage","https://www.infosecmatter.com/crackmapexec-module-library/?cmem=mssql-mimikatz","https://www.infosecmatter.com/crackmapexec-module-library/?cmem=smb-pe_inject"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.command_line:*\\ \\-M\\ pe_inject\\ * OR (process.command_line:*\\ \\-\\-local\\-auth* AND process.command_line:*\\ \\-u\\ * AND process.command_line:*\\ \\-x\\ *) OR (process.command_line:*\\ \\-\\-local\\-auth* AND process.command_line:*\\ \\-u\\ * AND process.command_line:*\\ \\-p\\ * AND process.command_line:*\\ \\-H\\ 'NTHASH'*) OR (process.command_line:*\\ mssql\\ * AND process.command_line:*\\ \\-u\\ * AND process.command_line:*\\ \\-p\\ * AND process.command_line:*\\ \\-M\\ * AND process.command_line:*\\ \\-d\\ *) OR (process.command_line:*\\ smb\\ * AND process.command_line:*\\ \\-u\\ * AND process.command_line:*\\ \\-H\\ * AND process.command_line:*\\ \\-M\\ * AND process.command_line:*\\ \\-o\\ *) OR (process.command_line:*\\ smb\\ * AND process.command_line:*\\ \\-u\\ * AND process.command_line:*\\ \\-p\\ * AND process.command_line:*\\ \\-\\-local\\-auth*)) OR (process.command_line:*\\ \\-\\-local\\-auth* AND process.command_line:*\\ \\-u\\ * AND process.command_line:*\\ \\-p\\ * AND process.command_line:*\\ 10.* AND process.command_line:*\\ 192.168.* AND process.command_line:*\\/24\\ *))`"}
