{"id":"1e53dd56-8d83-4eb4-a43e-b790a05510aa","created_by":"Teymur Kheirkhabarov (idea), Mangatas Tondang (rule), oscd.community","name":"Always Install Elevated MSI Spawned Cmd And Powershell","tags":["attack.privilege_escalation","attack.t1548.002"],"interval":"5m","description":"This rule looks for Windows Installer service (msiexec.exe) spawned command line and/or powershell","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(process.executable:(/.*\\\\[Cc][Mm][Dd]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee]/) AND process.parent.executable:/.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ii][Nn][Ss][Tt][Aa][Ll][Ll][Ee][Rr]\\\\.*/ AND process.parent.executable:/.*[Mm][Ss][Ii].*/ AND process.parent.executable:/.*[Tt][Mm][Pp]/)","rule_id":"1e53dd56-8d83-4eb4-a43e-b790a05510aa","timestamp_override":"event.ingested","references":["https://image.slidesharecdn.com/kheirkhabarovoffzonefinal-181117201458/95/hunting-for-privilege-escalation-in-windows-environment-50-638.jpg"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(process.executable:(*\\\\cmd.exe OR *\\\\powershell.exe OR *\\\\pwsh.exe) AND process.parent.executable:*\\\\Windows\\\\Installer\\\\* AND process.parent.executable:*msi* AND process.parent.executable:*tmp)`"}
