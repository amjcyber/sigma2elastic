{"id":"92772523-d9c1-4c93-9547-b0ca500baba3","created_by":"Nasreddine Bencherchali","name":"Persistence Via Mpnotify","tags":["attack.persistence"],"interval":"5m","description":"Detects when an attacker register a new SIP provider for persistence and defense evasion","risk_score":73,"enabled":true,"severity":"high","false_positives":["Might trigger if a legitimate new SIP provider is registered. But this is not a common occurrence in an environment and should be investigated either way"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:/.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Nn][Tt]\\\\[Cc][Uu][Rr][Rr][Ee][Nn][Tt][Vv][Ee][Rr][Ss][Ii][Oo][Nn]\\\\[Ww][Ii][Nn][Ll][Oo][Gg][Oo][Nn]\\\\[Mm][Pp][Nn][Oo][Tt][Ii][Ff][Yy].*/)","rule_id":"92772523-d9c1-4c93-9547-b0ca500baba3","timestamp_override":"event.ingested","references":["https://persistence-info.github.io/Data/mpnotify.html","https://www.youtube.com/watch?v=ggY3srD9dYs&ab_channel=GrzegorzTworek"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(winlog.event_data.EventType:SetValue AND registry.path:*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\ NT\\\\CurrentVersion\\\\Winlogon\\\\mpnotify*)`"}
