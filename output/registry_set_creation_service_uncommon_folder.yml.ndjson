{"id":"277dc340-0540-42e7-8efb-5ff460045e07","created_by":"Florian Roth","name":"Service Binary in Uncommon Folder","tags":["attack.defense_evasion","attack.t1112"],"interval":"5m","description":"Detect the creation of a service with a service binary located in a uncommon directory","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:/[Hh][Kk][Ll][Mm]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]\\\\[Cc][Uu][Rr][Rr][Ee][Nn][Tt][Cc][Oo][Nn][Tt][Rr][Oo][Ll][Ss][Ee][Tt]\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\.*/ AND registry.path:/.*\\\\[Ss][Tt][Aa][Rr][Tt]/ AND process.executable:(/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\.*/ OR /.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Rr][Oo][Aa][Mm][Ii][Nn][Gg]\\\\.*/) AND winlog.event_data.Details:(/[Dd][Ww][Oo][Rr][Dd]\\ \\(0[Xx]00000000\\)/ OR /[Dd][Ww][Oo][Rr][Dd]\\ \\(0[Xx]00000001\\)/ OR /[Dd][Ww][Oo][Rr][Dd]\\ \\(0[Xx]00000002\\)/)) OR (winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:/[Hh][Kk][Ll][Mm]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]\\\\[Cc][Uu][Rr][Rr][Ee][Nn][Tt][Cc][Oo][Nn][Tt][Rr][Oo][Ll][Ss][Ee][Tt]\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\.*/ AND registry.path:/.*\\\\[Ii][Mm][Aa][Gg][Ee][Pp][Aa][Tt][Hh]/ AND winlog.event_data.Details:(/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\.*/ OR /.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Rr][Oo][Aa][Mm][Ii][Nn][Gg]\\\\.*/))) AND (NOT (process.executable:(/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Rr][Oo][Aa][Mm][Ii][Nn][Gg]\\\\[Zz][Oo][Oo][Mm].*/ OR /.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\[Zz][Oo][Oo][Mm].*/) OR winlog.event_data.Details:(/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Rr][Oo][Aa][Mm][Ii][Nn][Gg]\\\\[Zz][Oo][Oo][Mm].*/ OR /.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\[Zz][Oo][Oo][Mm].*/))))","rule_id":"277dc340-0540-42e7-8efb-5ff460045e07","timestamp_override":"event.ingested","references":["https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(((winlog.event_data.EventType:SetValue AND registry.path:HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\* AND registry.path:*\\\\Start AND process.executable:(*\\\\AppData\\\\Local\\\\* OR *\\\\AppData\\\\Roaming\\\\*) AND winlog.event_data.Details:(DWORD\\ \\(0x00000000\\) OR DWORD\\ \\(0x00000001\\) OR DWORD\\ \\(0x00000002\\))) OR (winlog.event_data.EventType:SetValue AND registry.path:HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\* AND registry.path:*\\\\ImagePath AND winlog.event_data.Details:(*\\\\AppData\\\\Local\\\\* OR *\\\\AppData\\\\Roaming\\\\*))) AND (NOT (process.executable:(*\\\\AppData\\\\Roaming\\\\Zoom* OR *\\\\AppData\\\\Local\\\\Zoom*) OR winlog.event_data.Details:(*\\\\AppData\\\\Roaming\\\\Zoom* OR *\\\\AppData\\\\Local\\\\Zoom*))))`"}
