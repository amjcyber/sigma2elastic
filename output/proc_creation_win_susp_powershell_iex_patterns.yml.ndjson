{"id":"09576804-7a05-458e-a817-eb718ca91f54","created_by":"Florian Roth","name":"Suspicious PowerShell IEX Execution Patterns","tags":null,"interval":"5m","description":"Detects suspicious ways to run Invoke-Execution using IEX acronym","risk_score":73,"enabled":true,"severity":"high","false_positives":["Legitimate scripts that use IEX"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.executable:(/.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee]/) AND process.command_line:/.*\\-'\\ |\\ [Ii][Ee][Xx];'\\ \\-'\\ |\\ [Ii][Ee][Xx]\\ '\\ \\-'\\ |\\ [Ii][Ee][Xx]\\}'\\ \\-'\\ |\\ [Ii][Ee][Xx];'\\ \\-'\\ |\\ [Ii][Ee][Xx]\\ ;'\\ \\-'\\ |\\ [Ii][Ee][Xx]\\ \\-[Ee][Rr][Rr][Oo][Rr]'\\ \\-'\\ |\\ [Ii][Ee][Xx]\\ \\([Nn][Ee][Ww]'\\ \\-'\\ |\\ [Ii][Ee][Xx]\\ \\([Nn][Ee][Ww]'\\ \\-'\\);[Ii][Ee][Xx]\\ '.*/ AND process.command_line:(/.*\\:\\:[Ff][Rr][Oo][Mm][Bb][Aa][Ss][Ee]64[Ss][Tt][Rr][Ii][Nn][Gg].*/ OR /.*\\.[Gg][Ee][Tt][Ss][Tt][Rr][Ii][Nn][Gg]\\(\\[[Ss][Yy][Ss][Tt][Ee][Mm]\\.[Cc][Oo][Nn][Vv][Ee][Rr][Tt]\\]\\:\\:.*/)) OR process.command_line:/.*\\-'\\)|[Ii][Ee][Xx];$'\\ \\-'\\)|[Ii][Ee][Xx];$'\\ \\-'\\);[Ii][Ee][Xx]\\($'\\ \\-'\\);[Ii][Ee][Xx]\\ $'\\ \\-'\\ |\\ [Ii][Ee][Xx]\\ |\\ '.*/)","rule_id":"09576804-7a05-458e-a817-eb718ca91f54","timestamp_override":"event.ingested","references":["https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7.2"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.executable:(*\\\\powershell.exe OR *\\\\pwsh.exe) AND process.command_line:*\\-'\\ |\\ iex;'\\ \\-'\\ |\\ iex\\ '\\ \\-'\\ |\\ iex\\}'\\ \\-'\\ |\\ IEX;'\\ \\-'\\ |\\ IEX\\ ;'\\ \\-'\\ |\\ IEX\\ \\-Error'\\ \\-'\\ |\\ IEX\\ \\(new'\\ \\-'\\ |\\ IEX\\ \\(New'\\ \\-'\\);IEX\\ '* AND process.command_line:(*\\:\\:FromBase64String* OR *.GetString\\(\\[System.Convert\\]\\:\\:*)) OR process.command_line:*\\-'\\)|iex;$'\\ \\-'\\)|IEX;$'\\ \\-'\\);iex\\($'\\ \\-'\\);iex\\ $'\\ \\-'\\ |\\ IEX\\ |\\ '*)`"}
