{"id":"08200f85-2678-463e-9c32-88dce2f073d1","created_by":"Nasreddine Bencherchali","name":"MSSQL Add Account To Sysadmin Role","tags":["attack.persistence"],"interval":"5m","description":"Detects when an attacker tries to backdoor the MSSQL server by adding a backdoor account to the sysadmin fixed server role","risk_score":73,"enabled":true,"severity":"high","false_positives":["Rare legitimate administrative activity"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(winlog.channel:Application AND winlog.provider_name:/[Mm][Ss][Ss][Qq][Ll][Ss][Ee][Rr][Vv][Ee][Rr]/ AND event.code:33205 AND Data:/.*[Oo][Bb][Jj][Ee][Cc][Tt]_[Nn][Aa][Mm][Ee]\\:[Ss][Yy][Ss][Aa][Dd][Mm][Ii][Nn].*/ AND Data:/.*[Ss][Tt][Aa][Tt][Ee][Mm][Ee][Nn][Tt]\\:[Aa][Ll][Tt][Ee][Rr]\\ [Ss][Ee][Rr][Vv][Ee][Rr]\\ [Rr][Oo][Ll][Ee]\\ \\[[Ss][Yy][Ss][Aa][Dd][Mm][Ii][Nn]\\]\\ [Aa][Dd][Dd]\\ [Mm][Ee][Mm][Bb][Ee][Rr]\\ .*/)","rule_id":"08200f85-2678-463e-9c32-88dce2f073d1","timestamp_override":"event.ingested","references":["https://www.netspi.com/blog/technical/network-penetration-testing/sql-server-persistence-part-1-startup-stored-procedures/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(winlog.channel:Application AND winlog.provider_name:MSSQLSERVER AND event.code:33205 AND Data:*object_name\\:sysadmin* AND Data:*statement\\:alter\\ server\\ role\\ \\[sysadmin\\]\\ add\\ member\\ *)`"}
