{"id":"749c9f5e-b353-4b90-a9c1-05243357ca4b","created_by":"@SBousseaden, Florian Roth","name":"KrbRelayUp Attack Pattern","tags":["attack.privilege_escalation","attack.credential_access"],"interval":"5m","description":"Detects logon events that have characteristics of events generated during an attack with KrbRelayUp and the like","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(winlog.channel:Security AND event.code:4624 AND winlog.event_data.LogonType:3 AND winlog.event_data.AuthenticationPackageName:/[Kk][Ee][Rr][Bb][Ee][Rr][Oo][Ss]/ AND source.ip:127.0.0.1 AND winlog.event_data.TargetUserSid:/[Ss]\\-1\\-5\\-21\\-.*/ AND winlog.event_data.TargetUserSid:/.*\\-500/)","rule_id":"749c9f5e-b353-4b90-a9c1-05243357ca4b","timestamp_override":"event.ingested","references":["https://twitter.com/sbousseaden/status/1518976397364056071?s=12&t=qKO5eKHvWhAP19a50FTZ7g","https://github.com/elastic/detection-rules/blob/fb6ee2c69864ffdfe347bf3b050cb931f53067a6/rules/windows/privilege_escalation_krbrelayup_suspicious_logon.toml"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(winlog.channel:Security AND event.code:4624 AND winlog.event_data.LogonType:3 AND winlog.event_data.AuthenticationPackageName:Kerberos AND source.ip:127.0.0.1 AND winlog.event_data.TargetUserSid:S\\-1\\-5\\-21\\-* AND winlog.event_data.TargetUserSid:*\\-500)`"}
