{"id":"cdc8da7d-c303-42f8-b08c-b4ab47230263","created_by":"Florian Roth","name":"Rundll32 Internet Connection","tags":["attack.defense_evasion","attack.t1218.011","attack.execution"],"interval":"5m","description":"Detects a rundll32 that communicates with public IP addresses","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Communication to other corporate systems that use IP addresses from public address spaces"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.executable:/.*\\\\[Rr][Uu][Nn][Dd][Ll][Ll]32\\.[Ee][Xx][Ee]/ AND network.direction:/[Tt][Rr][Uu][Ee]/) AND (NOT ((destination.ip:(/10\\..*/ OR /192\\.168\\..*/ OR /172\\.16\\..*/ OR /172\\.17\\..*/ OR /172\\.18\\..*/ OR /172\\.19\\..*/ OR /172\\.20\\..*/ OR /172\\.21\\..*/ OR /172\\.22\\..*/ OR /172\\.23\\..*/ OR /172\\.24\\..*/ OR /172\\.25\\..*/ OR /172\\.26\\..*/ OR /172\\.27\\..*/ OR /172\\.28\\..*/ OR /172\\.29\\..*/ OR /172\\.30\\..*/ OR /172\\.31\\..*/ OR /127\\..*/ OR /20\\..*/) OR process.command_line:/.*[Pp][Cc][Aa][Ss][Vv][Cc]\\.[Dd][Ll][Ll],[Pp][Cc][Aa][Pp][Aa][Tt][Cc][Hh][Ss][Dd][Bb][Tt][Aa][Ss][Kk].*/) OR (process.parent.executable:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ss][Vv][Cc][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ AND RemoteAddress:/.*\\:443/))))","rule_id":"cdc8da7d-c303-42f8-b08c-b4ab47230263","timestamp_override":"event.ingested","references":["https://www.hybrid-analysis.com/sample/759fb4c0091a78c5ee035715afe3084686a8493f39014aea72dae36869de9ff6?environmentId=100"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.executable:*\\\\rundll32.exe AND network.direction:true) AND (NOT ((destination.ip:(10.* OR 192.168.* OR 172.16.* OR 172.17.* OR 172.18.* OR 172.19.* OR 172.20.* OR 172.21.* OR 172.22.* OR 172.23.* OR 172.24.* OR 172.25.* OR 172.26.* OR 172.27.* OR 172.28.* OR 172.29.* OR 172.30.* OR 172.31.* OR 127.* OR 20.*) OR process.command_line:*PcaSvc.dll,PcaPatchSdbTask*) OR (process.parent.executable:C\\:\\\\Windows\\\\System32\\\\svchost.exe AND RemoteAddress:*\\:443))))`"}
