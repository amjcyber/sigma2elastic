{"id":"7530b96f-ad8e-431d-a04d-ac85cc461fdc","created_by":"CD_R0M_","name":"Custom File Open Handler Executes PowerShell","tags":["attack.defense_evasion","attack.t1202"],"interval":"5m","description":"Detects the abuse of custom file open handler, executing powershell","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(registry.path:/.*[Ss][Hh][Ee][Ll][Ll]\\\\[Oo][Pp][Ee][Nn]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd]\\\\.*/ AND winlog.event_data.Details:/.*[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll].*/ AND winlog.event_data.Details:/.*\\-[Cc][Oo][Mm][Mm][Aa][Nn][Dd].*/ AND winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/)","rule_id":"7530b96f-ad8e-431d-a04d-ac85cc461fdc","timestamp_override":"event.ingested","references":["https://news.sophos.com/en-us/2022/02/01/solarmarker-campaign-used-novel-registry-changes-to-establish-persistence/?cmp=30728"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(registry.path:*shell\\\\open\\\\command\\\\* AND winlog.event_data.Details:*powershell* AND winlog.event_data.Details:*\\-command* AND winlog.event_data.EventType:SetValue)`"}
