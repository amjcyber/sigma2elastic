{"id":"4a1b6da0-d94f-4fc3-98fc-2d9cb9e5ee76","created_by":"Roberto Rodriguez, Teymur Kheirkhabarov, Dimitrios Slamaris, Mark Russinovich, Aleksey Potapov, oscd.community (update)","name":"Generic Password Dumper Activity on LSASS","tags":["attack.credential_access","car.2019-04-004","attack.t1003.001"],"interval":"5m","description":"Detects process handle on LSASS process with certain access mask","risk_score":73,"enabled":true,"severity":"high","false_positives":["Legitimate software accessing LSASS process for legitimate reason; update the whitelist with it"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(winlog.channel:Security AND ((event.code:4656 AND winlog.event_data.ObjectName:/.*\\\\[Ll][Ss][Aa][Ss][Ss]\\.[Ee][Xx][Ee]/ AND winlog.event_data.AccessMask:(/.*0[Xx]40.*/ OR /.*0[Xx]1400.*/ OR /.*0[Xx]100000.*/ OR /.*0[Xx]1410.*/ OR /.*0[Xx]1010.*/ OR /.*0[Xx]1438.*/ OR /.*0[Xx]143[Aa].*/ OR /.*0[Xx]1418.*/ OR /.*0[Xx]1[Ff]0[Ff][Ff][Ff].*/ OR /.*0[Xx]1[Ff]1[Ff][Ff][Ff].*/ OR /.*0[Xx]1[Ff]2[Ff][Ff][Ff].*/ OR /.*0[Xx]1[Ff]3[Ff][Ff][Ff].*/)) OR (event.code:4663 AND winlog.event_data.ObjectName:/.*\\\\[Ll][Ss][Aa][Ss][Ss]\\.[Ee][Xx][Ee]/ AND winlog.event_data.AccessList:(/.*4484.*/ OR /.*4416.*/))) AND (NOT ((process.executable:(/.*\\\\[Ww][Mm][Ii][Pp][Rr][Vv][Ss][Ee]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Tt][Aa][Ss][Kk][Mm][Gg][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Rr][Oo][Cc][Ee][Xx][Pp]64\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Rr][Oo][Cc][Ee][Xx][Pp]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ll][Ss][Mm]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Ss][Rr][Ss][Ss]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ii][Nn][Ii][Nn][Ii][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Vv][Mm][Tt][Oo][Oo][Ll][Ss][Dd]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Ii][Nn][Ii][Oo][Nn][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Vv][Ss][Tt][Ss][Kk][Mm][Gg][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Tt][Hh][Oo][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Tt][Hh][Oo][Rr]64\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt][Ee][Dd][Gg][Ee][Uu][Pp][Dd][Aa][Tt][Ee]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Gg][Aa][Mm][Ii][Nn][Gg][Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Vv][Cc][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Ss][Mm][Pp][Ee][Nn][Gg]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Rr][Tt]\\.[Ee][Xx][Ee]/ OR /.*[Rr][Tt][Kk][Aa][Uu][Dd][Uu][Ss][Ee][Rr][Vv][Ii][Cc][Ee]64/) AND process.executable:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Ww][Oo][Ww]64\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Nn][Aa][Tt][Ii][Vv][Ee]\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp]\\\\[Aa][Ss][Gg][Aa][Rr][Dd]2\\-[Aa][Gg][Ee][Nn][Tt]\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Dd][Aa][Tt][Aa]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Dd][Ee][Ff][Ee][Nn][Dd][Ee][Rr]\\\\[Pp][Ll][Aa][Tt][Ff][Oo][Rr][Mm]\\\\.*/)) OR (process.executable:/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss].*/) OR (process.executable:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Cc][Cc][Mm]\\\\[Cc][Cc][Mm][Ee][Xx][Ee][Cc]\\.[Ee][Xx][Ee]/))))","rule_id":"4a1b6da0-d94f-4fc3-98fc-2d9cb9e5ee76","timestamp_override":"event.ingested","references":["https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for_22.html","https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(winlog.channel:Security AND ((event.code:4656 AND winlog.event_data.ObjectName:*\\\\lsass.exe AND winlog.event_data.AccessMask:(*0x40* OR *0x1400* OR *0x100000* OR *0x1410* OR *0x1010* OR *0x1438* OR *0x143a* OR *0x1418* OR *0x1f0fff* OR *0x1f1fff* OR *0x1f2fff* OR *0x1f3fff*)) OR (event.code:4663 AND winlog.event_data.ObjectName:*\\\\lsass.exe AND winlog.event_data.AccessList:(*4484* OR *4416*))) AND (NOT ((process.executable:(*\\\\wmiprvse.exe OR *\\\\taskmgr.exe OR *\\\\procexp64.exe OR *\\\\procexp.exe OR *\\\\lsm.exe OR *\\\\csrss.exe OR *\\\\wininit.exe OR *\\\\vmtoolsd.exe OR *\\\\minionhost.exe OR *\\\\VsTskMgr.exe OR *\\\\thor.exe OR *\\\\thor64.exe OR *\\\\MicrosoftEdgeUpdate.exe OR *\\\\GamingServices.exe OR *\\\\svchost.exe OR *\\\\MsMpEng.exe OR *\\\\MRT.exe OR *RtkAudUService64) AND process.executable:(C\\:\\\\Windows\\\\System32\\\\* OR C\\:\\\\Windows\\\\SysWow64\\\\* OR C\\:\\\\Windows\\\\SysNative\\\\* OR C\\:\\\\Program\\ Files\\\\* OR C\\:\\\\Windows\\\\Temp\\\\asgard2\\-agent\\\\* OR C\\:\\\\ProgramData\\\\Microsoft\\\\Windows\\ Defender\\\\Platform\\\\*)) OR (process.executable:C\\:\\\\Program\\ Files*) OR (process.executable:C\\:\\\\Windows\\\\CCM\\\\CcmExec.exe))))`"}
