{"id":"152f3630-77c1-4284-bcc0-4cc68ab2f6e7","created_by":"Christian Burkard","name":"Shell Open Registry Keys Manipulation","tags":["attack.defense_evasion","attack.privilege_escalation","attack.t1548.002","attack.t1546.001"],"interval":"5m","description":"Detects the shell open key manipulation (exefile and ms-settings) used for persistence and the pattern of UAC Bypass using fodhelper.exe, computerdefaults.exe, slui.exe via registry keys (e.g. UACMe 33 or 62)","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:/.*[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Mm][Ss]\\-[Ss][Ee][Tt][Tt][Ii][Nn][Gg][Ss]\\\\[Ss][Hh][Ee][Ll][Ll]\\\\[Oo][Pp][Ee][Nn]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd]\\\\[Ss][Yy][Mm][Bb][Oo][Ll][Ii][Cc][Ll][Ii][Nn][Kk][Vv][Aa][Ll][Uu][Ee]/ AND winlog.event_data.Details:/.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\\\{.*/) OR registry.path:/.*[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Mm][Ss]\\-[Ss][Ee][Tt][Tt][Ii][Nn][Gg][Ss]\\\\[Ss][Hh][Ee][Ll][Ll]\\\\[Oo][Pp][Ee][Nn]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd]\\\\[Dd][Ee][Ll][Ee][Gg][Aa][Tt][Ee][Ee][Xx][Ee][Cc][Uu][Tt][Ee]/) OR ((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:(/.*[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Mm][Ss]\\-[Ss][Ee][Tt][Tt][Ii][Nn][Gg][Ss]\\\\[Ss][Hh][Ee][Ll][Ll]\\\\[Oo][Pp][Ee][Nn]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd]\\\\\\([Dd][Ee][Ff][Aa][Uu][Ll][Tt]\\)/ OR /.*[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Ee][Xx][Ee][Ff][Ii][Ll][Ee]\\\\[Ss][Hh][Ee][Ll][Ll]\\\\[Oo][Pp][Ee][Nn]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd]\\\\\\([Dd][Ee][Ff][Aa][Uu][Ll][Tt]\\)/)) AND (NOT (winlog.event_data.Details:/\\([Ee][Mm][Pp][Tt][Yy]\\)/))))","rule_id":"152f3630-77c1-4284-bcc0-4cc68ab2f6e7","timestamp_override":"event.ingested","references":["https://github.com/hfiref0x/UACME","https://winscripting.blog/2017/05/12/first-entry-welcome-and-uac-bypass/","https://github.com/RhinoSecurityLabs/Aggressor-Scripts/tree/master/UACBypass","https://tria.ge/211119-gs7rtshcfr/behavioral2 [Lokibot sample from Nov 2021]"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(((winlog.event_data.EventType:SetValue AND registry.path:*Classes\\\\ms\\-settings\\\\shell\\\\open\\\\command\\\\SymbolicLinkValue AND winlog.event_data.Details:*\\\\Software\\\\Classes\\\\\\{*) OR registry.path:*Classes\\\\ms\\-settings\\\\shell\\\\open\\\\command\\\\DelegateExecute) OR ((winlog.event_data.EventType:SetValue AND registry.path:(*Classes\\\\ms\\-settings\\\\shell\\\\open\\\\command\\\\\\(Default\\) OR *Classes\\\\exefile\\\\shell\\\\open\\\\command\\\\\\(Default\\))) AND (NOT (winlog.event_data.Details:\\(Empty\\)))))`"}
