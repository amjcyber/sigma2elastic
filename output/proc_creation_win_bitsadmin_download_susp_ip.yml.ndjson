{"id":"99c840f2-2012-46fd-9141-c761987550ef","created_by":"Florian Roth","name":"Bitsadmin Download File from IP","tags":["attack.defense_evasion","attack.persistence","attack.t1197","attack.s0190","attack.t1036.003"],"interval":"5m","description":"Detects usage of bitsadmin downloading a file using an URL that contains an IP","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(process.executable:/.*\\\\[Bb][Ii][Tt][Ss][Aa][Dd][Mm][Ii][Nn]\\.[Ee][Xx][Ee]/ AND process.command_line:(/.*\\ \\/[Tt][Rr][Aa][Nn][Ss][Ff][Ee][Rr]\\ .*/ OR /.*\\ \\/[Cc][Rr][Ee][Aa][Tt][Ee]\\ .*/ OR /.*\\ \\/[Aa][Dd][Dd][Ff][Ii][Ll][Ee]\\ .*/) AND process.command_line:(/.*[Hh][Tt][Tt][Pp]\\:\\/\\/1.*/ OR /.*[Hh][Tt][Tt][Pp]\\:\\/\\/2.*/ OR /.*[Hh][Tt][Tt][Pp]\\:\\/\\/3.*/ OR /.*[Hh][Tt][Tt][Pp]\\:\\/\\/4.*/ OR /.*[Hh][Tt][Tt][Pp]\\:\\/\\/5.*/ OR /.*[Hh][Tt][Tt][Pp]\\:\\/\\/6.*/ OR /.*[Hh][Tt][Tt][Pp]\\:\\/\\/7.*/ OR /.*[Hh][Tt][Tt][Pp]\\:\\/\\/8.*/ OR /.*[Hh][Tt][Tt][Pp]\\:\\/\\/9.*/ OR /.*[Hh][Tt][Tt][Pp][Ss]\\:\\/\\/1.*/ OR /.*[Hh][Tt][Tt][Pp][Ss]\\:\\/\\/2.*/ OR /.*[Hh][Tt][Tt][Pp][Ss]\\:\\/\\/3.*/ OR /.*[Hh][Tt][Tt][Pp][Ss]\\:\\/\\/4.*/ OR /.*[Hh][Tt][Tt][Pp][Ss]\\:\\/\\/5.*/ OR /.*[Hh][Tt][Tt][Pp][Ss]\\:\\/\\/6.*/ OR /.*[Hh][Tt][Tt][Pp][Ss]\\:\\/\\/7.*/ OR /.*[Hh][Tt][Tt][Pp][Ss]\\:\\/\\/8.*/ OR /.*[Hh][Tt][Tt][Pp][Ss]\\:\\/\\/9.*/))","rule_id":"99c840f2-2012-46fd-9141-c761987550ef","timestamp_override":"event.ingested","references":["https://blog.netspi.com/15-ways-to-download-a-file/#bitsadmin","https://isc.sans.edu/diary/22264","https://lolbas-project.github.io/lolbas/Binaries/Bitsadmin/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(process.executable:*\\\\bitsadmin.exe AND process.command_line:(*\\ \\/transfer\\ * OR *\\ \\/create\\ * OR *\\ \\/addfile\\ *) AND process.command_line:(*http\\:\\/\\/1* OR *http\\:\\/\\/2* OR *http\\:\\/\\/3* OR *http\\:\\/\\/4* OR *http\\:\\/\\/5* OR *http\\:\\/\\/6* OR *http\\:\\/\\/7* OR *http\\:\\/\\/8* OR *http\\:\\/\\/9* OR *https\\:\\/\\/1* OR *https\\:\\/\\/2* OR *https\\:\\/\\/3* OR *https\\:\\/\\/4* OR *https\\:\\/\\/5* OR *https\\:\\/\\/6* OR *https\\:\\/\\/7* OR *https\\:\\/\\/8* OR *https\\:\\/\\/9*))`"}
