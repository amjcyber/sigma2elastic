{"id":"e4a6b256-3e47-40fc-89d2-7a477edd6915","created_by":"Florian Roth, Patrick Bareiss, Anton Kutepov, oscd.community, Nasreddine Bencherchali","name":"System File Execution Location Anomaly","tags":["attack.defense_evasion","attack.t1036"],"interval":"5m","description":"Detects a Windows program executable started from a suspicious folder","risk_score":73,"enabled":true,"severity":"high","false_positives":["Exotic software"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(process.executable:(/.*\\\\[Ss][Vv][Cc][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Rr][Uu][Nn][Dd][Ll][Ll]32\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]_[Ii][Ss][Ee]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Rr][Ee][Gg][Ss][Vv][Rr]32\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Pp][Oo][Oo][Ll][Ss][Vv]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ll][Ss][Aa][Ss][Ss]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Mm][Ss][Ss]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Ss][Rr][Ss][Ss]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Oo][Nn][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ii][Nn][Ii][Nn][Ii][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ll][Ss][Mm]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ii][Nn][Ll][Oo][Gg][Oo][Nn]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Tt][Aa][Ss][Kk][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Tt][Aa][Ss][Kk][Mm][Gg][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Ii][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Rr][Uu][Nn][Tt][Ii][Mm][Ee][Bb][Rr][Oo][Kk][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Mm][Aa][Rr][Tt][Ss][Cc][Rr][Ee][Ee][Nn]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Dd][Ll][Ll][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Aa][Uu][Dd][Ii][Oo][Dd][Gg]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ll][Aa][Nn][Ee][Xx][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Dd][Aa][Ss][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Cc][Hh][Tt][Aa][Ss][Kk][Ss]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Ss][Cc][Rr][Ii][Pp][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ss][Cc][Rr][Ii][Pp][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ss][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Bb][Ii][Tt][Ss][Aa][Dd][Mm][Ii][Nn]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Aa][Tt][Bb][Rr][Oo][Kk][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Bb][Cc][Dd][Ee][Dd][Ii][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Ee][Rr][Tt][Uu][Tt][Ii][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Ee][Rr][Tt][Rr][Ee][Qq]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Mm][Ss][Tt][Pp]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Oo][Nn][Ss][Ee][Nn][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Dd][Ee][Ff][Rr][Aa][Gg]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Dd][Ii][Ss][Mm]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Dd][Ll][Ll][Hh][Ss][Tt]3[Gg]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ee][Vv][Ee][Nn][Tt][Vv][Ww][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Ss][Ii][Ee][Xx][Ee][Cc]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Rr][Uu][Nn][Oo][Nn][Cc][Ee]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ii][Nn][Vv][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ll][Oo][Gg][Oo][Nn][Uu][Ii]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Uu][Ss][Ee][Rr][Ii][Nn][Ii][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Dd][Ww][Mm]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ll][Ss][Aa][Ii][Ss][Oo]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Nn][Tt][Oo][Ss][Kk][Rr][Nn][Ll]\\.[Ee][Xx][Ee]/) AND (NOT (process.executable:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Ww][Oo][Ww]64\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ww][Ii][Nn][Ss][Xx][Ss]\\\\.*/) OR process.executable:/.*\\\\[Ss][Yy][Ss][Tt][Ee][Mm][Rr][Oo][Oo][Tt]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\.*/ OR process.executable:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\.[Ee][Xx][Ee]/)))","rule_id":"e4a6b256-3e47-40fc-89d2-7a477edd6915","timestamp_override":"event.ingested","references":["https://twitter.com/GelosSnake/status/934900723426439170"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(process.executable:(*\\\\svchost.exe OR *\\\\rundll32.exe OR *\\\\services.exe OR *\\\\powershell.exe OR *\\\\powershell_ise.exe OR *\\\\pwsh.exe OR *\\\\regsvr32.exe OR *\\\\spoolsv.exe OR *\\\\lsass.exe OR *\\\\smss.exe OR *\\\\csrss.exe OR *\\\\conhost.exe OR *\\\\wininit.exe OR *\\\\lsm.exe OR *\\\\winlogon.exe OR *\\\\explorer.exe OR *\\\\taskhost.exe OR *\\\\Taskmgr.exe OR *\\\\sihost.exe OR *\\\\RuntimeBroker.exe OR *\\\\smartscreen.exe OR *\\\\dllhost.exe OR *\\\\audiodg.exe OR *\\\\wlanext.exe OR *\\\\dashost.exe OR *\\\\schtasks.exe OR *\\\\cscript.exe OR *\\\\wscript.exe OR *\\\\wsl.exe OR *\\\\bitsadmin.exe OR *\\\\atbroker.exe OR *\\\\bcdedit.exe OR *\\\\certutil.exe OR *\\\\certreq.exe OR *\\\\cmstp.exe OR *\\\\consent.exe OR *\\\\defrag.exe OR *\\\\dism.exe OR *\\\\dllhst3g.exe OR *\\\\eventvwr.exe OR *\\\\msiexec.exe OR *\\\\runonce.exe OR *\\\\winver.exe OR *\\\\logonui.exe OR *\\\\userinit.exe OR *\\\\dwm.exe OR *\\\\LsaIso.exe OR *\\\\ntoskrnl.exe) AND (NOT (process.executable:(C\\:\\\\Windows\\\\System32\\\\* OR C\\:\\\\Windows\\\\SysWOW64\\\\* OR C\\:\\\\Windows\\\\WinSxS\\\\*) OR process.executable:*\\\\SystemRoot\\\\System32\\\\* OR process.executable:C\\:\\\\Windows\\\\explorer.exe)))`"}
