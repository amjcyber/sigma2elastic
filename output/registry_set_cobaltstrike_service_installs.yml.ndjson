{"id":"61a7697c-cb79-42a8-a2ff-5f0cdfae0130","created_by":"Wojciech Lesicki","name":"CobaltStrike Service Installations in Registry","tags":["attack.execution","attack.privilege_escalation","attack.lateral_movement","attack.t1021.002","attack.t1543.003","attack.t1569.002"],"interval":"5m","description":"Detects known malicious service installs that appear in cases in which a Cobalt Strike beacon elevates privileges or lateral movement. We can also catch this by system log 7045 (https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/win_cobaltstrike_service_installs.yml) In some SIEM you can catch those events also in HKLM\\System\\ControlSet001\\Services or HKLM\\System\\ControlSet002\\Services, however, this rule is based on a regular sysmon's events.","risk_score":99,"enabled":true,"severity":"critical","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:/.*[Hh][Kk][Ll][Mm]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]\\\\[Cc][Uu][Rr][Rr][Ee][Nn][Tt][Cc][Oo][Nn][Tt][Rr][Oo][Ll][Ss][Ee][Tt]\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss].*/) AND ((winlog.event_data.Details:/.*[Aa][Dd][Mm][Ii][Nn]$.*/ AND winlog.event_data.Details:/.*\\.[Ee][Xx][Ee].*/) OR (winlog.event_data.Details:/.*%[Cc][Oo][Mm][Ss][Pp][Ee][Cc]%.*/ AND winlog.event_data.Details:/.*[Ss][Tt][Aa][Rr][Tt].*/ AND winlog.event_data.Details:/.*[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll].*/)))","rule_id":"61a7697c-cb79-42a8-a2ff-5f0cdfae0130","timestamp_override":"event.ingested","references":["https://www.sans.org/webcasts/tech-tuesday-workshop-cobalt-strike-detection-log-analysis-119395"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((winlog.event_data.EventType:SetValue AND registry.path:*HKLM\\\\System\\\\CurrentControlSet\\\\Services*) AND ((winlog.event_data.Details:*ADMIN$* AND winlog.event_data.Details:*.exe*) OR (winlog.event_data.Details:*%COMSPEC%* AND winlog.event_data.Details:*start* AND winlog.event_data.Details:*powershell*)))`"}
