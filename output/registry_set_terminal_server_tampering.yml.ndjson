{"id":"3f6b7b62-61aa-45db-96bd-9c31b36b653c","created_by":"Samir Bousseaden, David ANDRE, Roberto Rodriguez @Cyb3rWard0g, Nasreddine Bencherchali","name":"RDP Sensitive Settings Changed","tags":["attack.defense_evasion","attack.persistence","attack.t1112"],"interval":"5m","description":"Detects tampering to RDP Terminal Service/Server sensitive settings. Such as allowing unauthorized users access to a system via the 'fAllowUnsolicited' or enabling RDP via 'fDenyTSConnections'...etc","risk_score":73,"enabled":true,"severity":"high","false_positives":["Some of the keys mentioned here could be modified by an administrator while setting group policy (it should be investigated either way)"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:(/.*[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Pp][Oo][Ll][Ii][Cc][Ii][Ee][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Nn][Tt]\\\\[Tt][Ee][Rr][Mm][Ii][Nn][Aa][Ll]\\ [Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\.*/ OR /.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\\\[Tt][Ee][Rr][Mm][Ii][Nn][Aa][Ll]\\ [Ss][Ee][Rr][Vv][Ee][Rr]\\\\.*/) AND registry.path:/.*\\\\[Ss][Hh][Aa][Dd][Oo][Ww]/ AND winlog.event_data.Details:(/[Dd][Ww][Oo][Rr][Dd]\\ \\(0[Xx]00000001\\)/ OR /[Dd][Ww][Oo][Rr][Dd]\\ \\(0[Xx]00000002\\)/ OR /[Dd][Ww][Oo][Rr][Dd]\\ \\(0[Xx]00000003\\)/ OR /[Dd][Ww][Oo][Rr][Dd]\\ \\(0[Xx]00000004\\)/)) OR ((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:(/.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\\\[Tt][Ee][Rr][Mm][Ii][Nn][Aa][Ll]\\ [Ss][Ee][Rr][Vv][Ee][Rr]\\\\.*/ OR /.*[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Pp][Oo][Ll][Ii][Cc][Ii][Ee][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Nn][Tt]\\\\[Tt][Ee][Rr][Mm][Ii][Nn][Aa][Ll]\\ [Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\.*/)) AND ((registry.path:(/.*\\\\[Ff][Dd][Ee][Nn][Yy][Tt][Ss][Cc][Oo][Nn][Nn][Ee][Cc][Tt][Ii][Oo][Nn][Ss]/ OR /.*\\\\[Ff][Ss][Ii][Nn][Gg][Ll][Ee][Ss][Ee][Ss][Ss][Ii][Oo][Nn][Pp][Ee][Rr][Uu][Ss][Ee][Rr]/ OR /.*\\\\[Uu][Ss][Ee][Rr][Aa][Uu][Tt][Hh][Ee][Nn][Tt][Ii][Cc][Aa][Tt][Ii][Oo][Nn]/) AND winlog.event_data.Details:/[Dd][Ww][Oo][Rr][Dd]\\ \\(0[Xx]00000000\\)/) OR (registry.path:(/.*\\\\[Ff][Aa][Ll][Ll][Oo][Ww][Uu][Nn][Ss][Oo][Ll][Ii][Cc][Ii][Tt][Ee][Dd]/ OR /.*\\\\[Ff][Aa][Ll][Ll][Oo][Ww][Uu][Nn][Ss][Oo][Ll][Ii][Cc][Ii][Tt][Ee][Dd][Ff][Uu][Ll][Ll][Cc][Oo][Nn][Tt][Rr][Oo][Ll]/) AND winlog.event_data.Details:/[Dd][Ww][Oo][Rr][Dd]\\ \\(0[Xx]00000001\\)/)))) OR (winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:(/.*\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\[Tt][Ee][Rr][Mm][Ss][Ee][Rr][Vv][Ii][Cc][Ee]\\\\[Pp][Aa][Rr][Aa][Mm][Ee][Tt][Ee][Rr][Ss]\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Dd][Ll][Ll].*/ OR /.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\\\[Tt][Ee][Rr][Mm][Ii][Nn][Aa][Ll]\\ [Ss][Ee][Rr][Vv][Ee][Rr]\\\\[Ww][Ii][Nn][Ss][Tt][Aa][Tt][Ii][Oo][Nn][Ss]\\\\[Rr][Dd][Pp]\\-[Tt][Cc][Pp]\\\\[Ii][Nn][Ii][Tt][Ii][Aa][Ll][Pp][Rr][Oo][Gg][Rr][Aa][Mm].*/ OR /.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\\\[Tt][Ee][Rr][Mm][Ii][Nn][Aa][Ll]\\ [Ss][Ee][Rr][Vv][Ee][Rr]\\\\[Ii][Nn][Ii][Tt][Ii][Aa][Ll][Pp][Rr][Oo][Gg][Rr][Aa][Mm].*/ OR /.*[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Pp][Oo][Ll][Ii][Cc][Ii][Ee][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Nn][Tt]\\\\[Tt][Ee][Rr][Mm][Ii][Nn][Aa][Ll]\\ [Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\[Ii][Nn][Ii][Tt][Ii][Aa][Ll][Pp][Rr][Oo][Gg][Rr][Aa][Mm].*/)))","rule_id":"3f6b7b62-61aa-45db-96bd-9c31b36b653c","timestamp_override":"event.ingested","references":["https://blog.menasec.net/2019/02/threat-hunting-rdp-hijacking-via.html","http://woshub.com/rds-shadow-how-to-connect-to-a-user-session-in-windows-server-2012-r2/","https://twitter.com/SagieSec/status/1469001618863624194?t=HRf0eA0W1YYzkTSHb-Ky1A&s=03","https://threathunterplaybook.com/notebooks/windows/05_defense_evasion/WIN-190407183310.html","https://bazaar.abuse.ch/sample/6f3aa9362d72e806490a8abce245331030d1ab5ac77e400dd475748236a6cc81/","http://etutorials.org/Microsoft+Products/microsoft+windows+server+2003+terminal+services/Chapter+6+Registry/Registry+Keys+for+Terminal+Services/","https://admx.help/HKLM/SOFTWARE/Policies/Microsoft/Windows%20NT/Terminal%20Services"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(((winlog.event_data.EventType:SetValue AND registry.path:(*SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\ NT\\\\Terminal\\ Services\\\\* OR *\\\\Control\\\\Terminal\\ Server\\\\*) AND registry.path:*\\\\Shadow AND winlog.event_data.Details:(DWORD\\ \\(0x00000001\\) OR DWORD\\ \\(0x00000002\\) OR DWORD\\ \\(0x00000003\\) OR DWORD\\ \\(0x00000004\\))) OR ((winlog.event_data.EventType:SetValue AND registry.path:(*\\\\Control\\\\Terminal\\ Server\\\\* OR *SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\ NT\\\\Terminal\\ Services\\\\*)) AND ((registry.path:(*\\\\fDenyTSConnections OR *\\\\fSingleSessionPerUser OR *\\\\UserAuthentication) AND winlog.event_data.Details:DWORD\\ \\(0x00000000\\)) OR (registry.path:(*\\\\fAllowUnsolicited OR *\\\\fAllowUnsolicitedFullControl) AND winlog.event_data.Details:DWORD\\ \\(0x00000001\\))))) OR (winlog.event_data.EventType:SetValue AND registry.path:(*\\\\services\\\\TermService\\\\Parameters\\\\ServiceDll* OR *\\\\Control\\\\Terminal\\ Server\\\\WinStations\\\\RDP\\-Tcp\\\\InitialProgram* OR *\\\\Control\\\\Terminal\\ Server\\\\InitialProgram* OR *SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\ NT\\\\Terminal\\ Services\\\\InitialProgram*)))`"}
