{"id":"3bad990e-4848-4a78-9530-b427d854aac0","created_by":"E.M. Anhaus (originally from Atomic Blue Detections, Tony Lambert), oscd.community, omkar72","name":"Domain Trust Discovery","tags":["attack.discovery","attack.t1482"],"interval":"5m","description":"Identifies execution of nltest.exe and dsquery.exe for domain trust discovery. This technique is used by attackers to enumerate Active Directory trusts.","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Legitimate use of the utilities by legitimate user for legitimate reason"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.executable:/.*\\\\[Nn][Ll][Tt][Ee][Ss][Tt]\\.[Ee][Xx][Ee]/ AND process.command_line:(/.*[Dd][Oo][Mm][Aa][Ii][Nn]_[Tt][Rr][Uu][Ss][Tt][Ss].*/ OR /.*[Aa][Ll][Ll]_[Tt][Rr][Uu][Ss][Tt][Ss].*/ OR /.*\\/[Tt][Rr][Uu][Ss][Tt][Ee][Dd]_[Dd][Oo][Mm][Aa][Ii][Nn][Ss].*/ OR /.*\\/[Dd][Cc][Ll][Ii][Ss][Tt].*/)) OR (process.executable:/.*\\\\[Dd][Ss][Qq][Uu][Ee][Rr][Yy]\\.[Ee][Xx][Ee]/ AND process.command_line:/.*[Tt][Rr][Uu][Ss][Tt][Ee][Dd][Dd][Oo][Mm][Aa][Ii][Nn].*/) OR (process.executable:/.*\\\\[Dd][Ss][Qq][Uu][Ee][Rr][Yy]\\.[Ee][Xx][Ee]/ AND process.command_line:/.*\\-[Ff][Ii][Ll][Tt][Ee][Rr].*/ AND process.command_line:/.*[Tt][Rr][Uu][Ss][Tt][Ee][Dd][Dd][Oo][Mm][Aa][Ii][Nn].*/))","rule_id":"3bad990e-4848-4a78-9530-b427d854aac0","timestamp_override":"event.ingested","references":["https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1482/T1482.md","https://eqllib.readthedocs.io/en/latest/analytics/03e231a6-74bc-467a-acb1-e5676b0fb55e.html","https://thedfirreport.com/2020/10/18/ryuk-in-5-hours/","https://redcanary.com/blog/how-one-hospital-thwarted-a-ryuk-ransomware-outbreak/","https://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.executable:*\\\\nltest.exe AND process.command_line:(*domain_trusts* OR *all_trusts* OR *\\/trusted_domains* OR *\\/dclist*)) OR (process.executable:*\\\\dsquery.exe AND process.command_line:*trustedDomain*) OR (process.executable:*\\\\dsquery.exe AND process.command_line:*\\-filter* AND process.command_line:*trustedDomain*))`"}
