{"id":"c947b146-0abc-4c87-9c64-b17e9d7274a2","created_by":"Florian Roth, Michael Haag, Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community, Andreas Hunkeler (@Karneades)","name":"Shadow Copies Deletion Using Operating Systems Utilities","tags":["attack.defense_evasion","attack.impact","attack.t1070","attack.t1490"],"interval":"5m","description":"Shadow Copies deletion using operating systems utilities","risk_score":73,"enabled":true,"severity":"high","false_positives":["Legitimate Administrator deletes Shadow Copies using operating systems utilities for legitimate reason","LANDesk LDClient Ivanti-PSModule (PS EncodedCommand)"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((((process.executable:(/.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Mm][Ii][Cc]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Vv][Ss][Ss][Aa][Dd][Mm][Ii][Nn]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Dd][Ii][Ss][Kk][Ss][Hh][Aa][Dd][Oo][Ww]\\.[Ee][Xx][Ee]/) OR process.pe.original_file_name:(/[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /[Pp][Ww][Ss][Hh]\\.[Dd][Ll][Ll]/ OR /[Ww][Mm][Ii][Cc]\\.[Ee][Xx][Ee]/ OR /[Vv][Ss][Ss][Aa][Dd][Mm][Ii][Nn]\\.[Ee][Xx][Ee]/ OR /[Dd][Ii][Ss][Kk][Ss][Hh][Aa][Dd][Oo][Ww]\\.[Ee][Xx][Ee]/)) AND (process.command_line:/.*[Ss][Hh][Aa][Dd][Oo][Ww].*/ AND process.command_line:/.*[Dd][Ee][Ll][Ee][Tt][Ee].*/)) OR ((process.executable:/.*\\\\[Ww][Bb][Aa][Dd][Mm][Ii][Nn]\\.[Ee][Xx][Ee]/ OR process.pe.original_file_name:/[Ww][Bb][Aa][Dd][Mm][Ii][Nn]\\.[Ee][Xx][Ee]/) AND (process.command_line:/.*[Dd][Ee][Ll][Ee][Tt][Ee].*/ AND process.command_line:/.*[Cc][Aa][Tt][Aa][Ll][Oo][Gg].*/ AND process.command_line:/.*[Qq][Uu][Ii][Ee][Tt].*/))) OR ((process.executable:/.*\\\\[Vv][Ss][Ss][Aa][Dd][Mm][Ii][Nn]\\.[Ee][Xx][Ee]/ OR process.pe.original_file_name:/[Vv][Ss][Ss][Aa][Dd][Mm][Ii][Nn]\\.[Ee][Xx][Ee]/) AND (process.command_line:/.*[Rr][Ee][Ss][Ii][Zz][Ee].*/ AND process.command_line:/.*[Ss][Hh][Aa][Dd][Oo][Ww][Ss][Tt][Oo][Rr][Aa][Gg][Ee].*/ AND process.command_line:/.*[Uu][Nn][Bb][Oo][Uu][Nn][Dd][Ee][Dd].*/)))","rule_id":"c947b146-0abc-4c87-9c64-b17e9d7274a2","timestamp_override":"event.ingested","references":["https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment","https://blog.talosintelligence.com/2017/05/wannacry.html","https://securingtomorrow.mcafee.com/other-blogs/mcafee-labs/new-teslacrypt-ransomware-arrives-via-spam/","https://www.bleepingcomputer.com/news/security/why-everyone-should-disable-vssadmin-exe-now/","https://www.hybrid-analysis.com/sample/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa?environmentId=100","https://github.com/Neo23x0/Raccine#the-process","https://github.com/Neo23x0/Raccine/blob/20a569fa21625086433dcce8bb2765d0ea08dcb6/yara/gen_ransomware_command_lines.yar","https://redcanary.com/blog/intelligence-insights-october-2021/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((((process.executable:(*\\\\powershell.exe OR *\\\\pwsh.exe OR *\\\\wmic.exe OR *\\\\vssadmin.exe OR *\\\\diskshadow.exe) OR process.pe.original_file_name:(PowerShell.EXE OR pwsh.dll OR wmic.exe OR VSSADMIN.EXE OR diskshadow.exe)) AND (process.command_line:*shadow* AND process.command_line:*delete*)) OR ((process.executable:*\\\\wbadmin.exe OR process.pe.original_file_name:WBADMIN.EXE) AND (process.command_line:*delete* AND process.command_line:*catalog* AND process.command_line:*quiet*))) OR ((process.executable:*\\\\vssadmin.exe OR process.pe.original_file_name:VSSADMIN.EXE) AND (process.command_line:*resize* AND process.command_line:*shadowstorage* AND process.command_line:*unbounded*)))`"}
