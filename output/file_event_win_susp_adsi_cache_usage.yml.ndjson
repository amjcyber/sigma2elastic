{"id":"75bf09fa-1dd7-4d18-9af9-dd9e492562eb","created_by":"xknow @xknow_infosec, Tim Shelton","name":"Suspicious ADSI-Cache Usage By Unknown Tool","tags":["attack.t1001.003","attack.command_and_control"],"interval":"5m","description":"Detects the usage of ADSI (LDAP) operations by tools. This may also detect tools like LDAPFragger.","risk_score":73,"enabled":true,"severity":"high","false_positives":["Other legimate tools, which do ADSI (LDAP) operations, e.g. any remoting activity by MMC, Powershell, Windows etc."],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((file.path:/.*\\\\[Ll][Oo][Cc][Aa][Ll]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Cc][Hh][Cc][Aa][Cc][Hh][Ee]\\\\.*/ AND file.path:/.*\\.[Ss][Cc][Hh]/) AND (NOT ((process.executable:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ss][Vv][Cc][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Dd][Ll][Ll][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Mm][Mm][Cc]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss][Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\\\[Vv]1\\.0\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Cc][Cc][Mm]\\\\[Cc][Cc][Mm][Ee][Xx][Ee][Cc]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Cc][Yy][Ll][Aa][Nn][Cc][Ee]\\\\[Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\\\[Cc][Yy][Ll][Aa][Nn][Cc][Ee][Ss][Vv][Cc]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ww][Bb][Ee][Mm]\\\\[Ww][Mm][Ii][Pp][Rr][Vv][Ss][Ee]\\.[Ee][Xx][Ee]/)) OR (process.executable:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Cc][Cc][Mm][Ss][Ee][Tt][Uu][Pp]\\\\[Aa][Uu][Tt][Oo][Uu][Pp][Gg][Rr][Aa][Dd][Ee]\\\\[Cc][Cc][Mm][Ss][Ee][Tt][Uu][Pp].*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Ss][Ee][Nn][Tt][Ii][Nn][Ee][Ll][Oo][Nn][Ee]\\\\[Ss][Ee][Nn][Tt][Ii][Nn][Ee][Ll]\\ [Aa][Gg][Ee][Nn][Tt].*/)) OR (process.executable:/.*\\\\[Ll][Aa][Nn][Dd][Ee][Ss][Kk]\\\\[Ll][Dd][Cc][Ll][Ii][Ee][Nn][Tt]\\\\[Ll][Dd][Aa][Pp][Ww][Hh][Oo][Aa][Mm][Ii]\\.[Ee][Xx][Ee]/) OR (process.executable:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ee][Ff][Ss][Uu][Ii]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Dd][Ss][Aa][Cc]\\.[Ee][Xx][Ee]/)))))","rule_id":"75bf09fa-1dd7-4d18-9af9-dd9e492562eb","timestamp_override":"event.ingested","references":["https://medium.com/@ivecodoe/detecting-ldapfragger-a-newly-released-cobalt-strike-beacon-using-ldap-for-c2-communication-c274a7f00961","https://blog.fox-it.com/2020/03/19/ldapfragger-command-and-control-over-ldap-attributes/","https://github.com/fox-it/LDAPFragger"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((file.path:*\\\\Local\\\\Microsoft\\\\Windows\\\\SchCache\\\\* AND file.path:*.sch) AND (NOT ((process.executable:(C\\:\\\\windows\\\\system32\\\\svchost.exe OR C\\:\\\\windows\\\\system32\\\\dllhost.exe OR C\\:\\\\windows\\\\system32\\\\mmc.exe OR C\\:\\\\windows\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe OR C\\:\\\\Windows\\\\CCM\\\\CcmExec.exe OR C\\:\\\\Program\\ Files\\\\Cylance\\\\Desktop\\\\CylanceSvc.exe OR C\\:\\\\Windows\\\\System32\\\\wbem\\\\WmiPrvSE.exe)) OR (process.executable:(C\\:\\\\Windows\\\\ccmsetup\\\\autoupgrade\\\\ccmsetup* OR C\\:\\\\Program\\ Files\\\\SentinelOne\\\\Sentinel\\ Agent*)) OR (process.executable:*\\\\LANDesk\\\\LDCLient\\\\ldapwhoami.exe) OR (process.executable:(C\\:\\\\Windows\\\\system32\\\\efsui.exe OR C\\:\\\\Windows\\\\system32\\\\dsac.exe)))))`"}
