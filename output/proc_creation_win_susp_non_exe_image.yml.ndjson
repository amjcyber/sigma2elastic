{"id":"c09dad97-1c78-4f71-b127-7edb2b8e491a","created_by":"Max Altgelt","name":"Execution of Suspicious File Type Extension","tags":["attack.defense_evasion"],"interval":"5m","description":"Checks whether the image specified in a process creation event doesn't refer to an .exe file (caused by process ghosting or other unorthodox methods to start a process)","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((NOT (process.executable:(/.*\\.[Ee][Xx][Ee]/ OR /.*\\.[Tt][Mm][Pp]/))) AND (NOT ((NOT _exists_:process.executable) OR (process.executable:(/[Rr][Ee][Gg][Ii][Ss][Tt][Rr][Yy]/ OR /[Mm][Ee][Mm][Cc][Oo][Mm][Pp][Rr][Ee][Ss][Ss][Ii][Oo][Nn]/)) OR (process.executable:(\\- OR \"\")) OR (process.executable:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ii][Nn][Ss][Tt][Aa][Ll][Ll][Ee][Rr]\\\\[Mm][Ss][Ii].*/) OR (process.parent.executable:(/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Dd][Aa][Tt][Aa]\\\\[Aa][Vv][Ii][Rr][Aa]\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Dd][Rr][Ii][Vv][Ee][Rr][Ss][Tt][Oo][Rr][Ee]\\\\[Ff][Ii][Ll][Ee][Rr][Ee][Pp][Oo][Ss][Ii][Tt][Oo][Rr][Yy]\\\\.*/)) OR (process.executable:/.*\\.[Ss][Cc][Rr]/) OR (process.executable:/.*[Nn][Vv][Ii][Dd][Ii][Aa]\\\\[Nn][Vv][Bb][Aa][Cc][Kk][Ee][Nn][Dd]\\\\.*/ AND process.executable:/.*\\.[Dd][Aa][Tt]/) OR (process.executable:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Ww][Oo][Ww]64\\\\.*/) AND process.executable:/.*\\.[Cc][Oo][Mm]/) OR (process.executable:/.*\\\\[Ww][Ii][Nn][Ss][Cc][Pp]\\.[Cc][Oo][Mm]/) OR (process.executable:/.*[Cc]\\:\\\\[Uu][Ss][Ee][Rr][Ss]\\\\.*/ AND process.executable:/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\.*/ AND process.executable:/.*\\.[Tt][Mm][Pp].*/ AND process.executable:/.*[Cc][Oo][Dd][Ee][Ss][Ee][Tt][Uu][Pp].*/) OR (process.executable:/.*\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\\\[Ss][Oo][Ff][Ff][Ii][Cc][Ee]\\.[Bb][Ii][Nn]/) OR (process.executable:(/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Ee][Mm][Cc]\\ [Nn][Ee][Tt][Ww][Oo][Rr][Kk][Ee][Rr]\\\\[Mm][Aa][Nn][Aa][Gg][Ee][Mm][Ee][Nn][Tt]\\\\[Gg][Ss][Tt]\\\\[Aa][Pp][Aa][Cc][Hh][Ee]\\\\[Cc][Gg][Ii]\\-[Bb][Ii][Nn]\\\\[Uu][Pp][Dd][Aa][Tt][Ee]_[Jj][Nn][Ll][Pp]\\.[Cc][Gg][Ii]/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\ \\([Xx]86\\)\\\\[Ee][Mm][Cc]\\ [Nn][Ee][Tt][Ww][Oo][Rr][Kk][Ee][Rr]\\\\[Mm][Aa][Nn][Aa][Gg][Ee][Mm][Ee][Nn][Tt]\\\\[Gg][Ss][Tt]\\\\[Aa][Pp][Aa][Cc][Hh][Ee]\\\\[Cc][Gg][Ii]\\-[Bb][Ii][Nn]\\\\[Uu][Pp][Dd][Aa][Tt][Ee]_[Jj][Nn][Ll][Pp]\\.[Cc][Gg][Ii]/)) OR (process.executable:(/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\ \\([Xx]86\\)\\\\[Ww][Ii][Nn][Pp][Aa][Kk][Pp][Rr][Oo]\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Ww][Ii][Nn][Pp][Aa][Kk][Pp][Rr][Oo]\\\\.*/) AND process.executable:/.*\\.[Nn][Gg][Nn]/) OR (process.executable:(/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\ \\([Xx]86\\)\\\\[Mm][Yy][Qq]\\\\[Ss][Ee][Rr][Vv][Ee][Rr]\\\\[Pp][Cc][Ll][Tt][Oo][Oo][Ll]\\.[Dd][Ll][Ll]/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Mm][Yy][Qq]\\\\[Ss][Ee][Rr][Vv][Ee][Rr]\\\\[Pp][Cc][Ll][Tt][Oo][Oo][Ll]\\.[Dd][Ll][Ll]/)) OR (process.executable:(/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Vv][Ii][Ss][Uu][Aa][Ll]\\ [Ss][Tt][Uu][Dd][Ii][Oo]\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\ \\([Xx]86\\)\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Vv][Ii][Ss][Uu][Aa][Ll]\\ [Ss][Tt][Uu][Dd][Ii][Oo].*/) AND process.executable:/.*\\.[Cc][Oo][Mm]/) OR (process.executable:/[Cc]\\:\\\\[Cc][Oo][Nn][Ff][Ii][Gg]\\.[Mm][Ss][Ii]\\\\.*/ AND process.executable:(/.*\\.[Rr][Bb][Ff]/ OR /.*\\.[Rr][Bb][Ss]/)) OR (process.executable:/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\[Pp][Aa][Cc][Kk][Aa][Gg][Ee][Ss]\\\\.*/ AND process.executable:/.*\\\\[Ll][Oo][Cc][Aa][Ll][Ss][Tt][Aa][Tt][Ee]\\\\[Rr][Oo][Oo][Tt][Ff][Ss]\\\\.*/) OR (process.executable:/.*\\\\[Ll][Zz][Mm][Aa]_[Ee][Xx][Ee]/))))","rule_id":"c09dad97-1c78-4f71-b127-7edb2b8e491a","timestamp_override":"event.ingested","references":["https://pentestlaboratories.com/2021/12/08/process-ghosting/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((NOT (process.executable:(*.exe OR *.tmp))) AND (NOT ((NOT _exists_:process.executable) OR (process.executable:(Registry OR MemCompression)) OR (process.executable:(\\- OR \"\")) OR (process.executable:C\\:\\\\Windows\\\\Installer\\\\MSI*) OR (process.parent.executable:(C\\:\\\\ProgramData\\\\Avira\\\\* OR C\\:\\\\Windows\\\\System32\\\\DriverStore\\\\FileRepository\\\\*)) OR (process.executable:*.scr) OR (process.executable:*NVIDIA\\\\NvBackend\\\\* AND process.executable:*.dat) OR (process.executable:(C\\:\\\\Windows\\\\System32\\\\* OR C\\:\\\\Windows\\\\SysWOW64\\\\*) AND process.executable:*.com) OR (process.executable:*\\\\WinSCP.com) OR (process.executable:*C\\:\\\\Users\\\\* AND process.executable:*\\\\AppData\\\\* AND process.executable:*.tmp* AND process.executable:*CodeSetup*) OR (process.executable:*\\\\program\\\\soffice.bin) OR (process.executable:(C\\:\\\\Program\\ Files\\\\EMC\\ NetWorker\\\\Management\\\\GST\\\\apache\\\\cgi\\-bin\\\\update_jnlp.cgi OR C\\:\\\\Program\\ Files\\ \\(x86\\)\\\\EMC\\ NetWorker\\\\Management\\\\GST\\\\apache\\\\cgi\\-bin\\\\update_jnlp.cgi)) OR (process.executable:(C\\:\\\\Program\\ Files\\ \\(x86\\)\\\\WINPAKPRO\\\\* OR C\\:\\\\Program\\ Files\\\\WINPAKPRO\\\\*) AND process.executable:*.ngn) OR (process.executable:(C\\:\\\\Program\\ Files\\ \\(x86\\)\\\\MyQ\\\\Server\\\\pcltool.dll OR C\\:\\\\Program\\ Files\\\\MyQ\\\\Server\\\\pcltool.dll)) OR (process.executable:(C\\:\\\\Program\\ Files\\\\Microsoft\\ Visual\\ Studio\\\\* OR C\\:\\\\Program\\ Files\\ \\(x86\\)\\\\Microsoft\\ Visual\\ Studio*) AND process.executable:*.com) OR (process.executable:C\\:\\\\Config.Msi\\\\* AND process.executable:(*.rbf OR *.rbs)) OR (process.executable:*\\\\AppData\\\\Local\\\\Packages\\\\* AND process.executable:*\\\\LocalState\\\\rootfs\\\\*) OR (process.executable:*\\\\LZMA_EXE))))`"}
