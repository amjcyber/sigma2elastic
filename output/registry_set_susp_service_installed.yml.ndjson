{"id":"f2485272-a156-4773-82d7-1d178bc4905b","created_by":"xknow (@xknow_infosec), xorxes (@xor_xes)","name":"Suspicious Service Installed","tags":["attack.t1562.001","attack.defense_evasion"],"interval":"5m","description":"Detects installation of NalDrv or PROCEXP152 services via registry-keys to non-system32 folders. Both services are used in the tool Ghost-In-The-Logs (https://github.com/bats3c/Ghost-In-The-Logs), which uses KDU (https://github.com/hfiref0x/KDU)","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Other legimate tools using this service names and drivers. Note - clever attackers may easily bypass this detection by just renaming the services. Therefore just Medium-level and don't rely on it."],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:(/[Hh][Kk][Ll][Mm]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]\\\\[Cc][Uu][Rr][Rr][Ee][Nn][Tt][Cc][Oo][Nn][Tt][Rr][Oo][Ll][Ss][Ee][Tt]\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\[Nn][Aa][Ll][Dd][Rr][Vv]\\\\[Ii][Mm][Aa][Gg][Ee][Pp][Aa][Tt][Hh]/ OR /[Hh][Kk][Ll][Mm]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]\\\\[Cc][Uu][Rr][Rr][Ee][Nn][Tt][Cc][Oo][Nn][Tt][Rr][Oo][Ll][Ss][Ee][Tt]\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\[Pp][Rr][Oo][Cc][Ee][Xx][Pp]152\\\\[Ii][Mm][Aa][Gg][Ee][Pp][Aa][Tt][Hh]/)) AND (NOT (process.executable:(/.*\\\\[Pp][Rr][Oo][Cc][Ee][Xx][Pp]64\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Rr][Oo][Cc][Ee][Xx][Pp]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Rr][Oo][Cc][Mm][Oo][Nn]64\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Rr][Oo][Cc][Mm][Oo][Nn]\\.[Ee][Xx][Ee]/)))) AND (NOT (winlog.event_data.Details:/.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Dd][Rr][Ii][Vv][Ee][Rr][Ss]\\\\[Pp][Rr][Oo][Cc][Ee][Xx][Pp]152\\.[Ss][Yy][Ss].*/)))","rule_id":"f2485272-a156-4773-82d7-1d178bc4905b","timestamp_override":"event.ingested","references":["https://blog.dylan.codes/evading-sysmon-and-windows-event-logging/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(((winlog.event_data.EventType:SetValue AND registry.path:(HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\NalDrv\\\\ImagePath OR HKLM\\\\System\\\\CurrentControlSet\\\\Services\\\\PROCEXP152\\\\ImagePath)) AND (NOT (process.executable:(*\\\\procexp64.exe OR *\\\\procexp.exe OR *\\\\procmon64.exe OR *\\\\procmon.exe)))) AND (NOT (winlog.event_data.Details:*\\\\WINDOWS\\\\system32\\\\Drivers\\\\PROCEXP152.SYS*)))`"}
