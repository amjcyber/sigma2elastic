{"id":"40b6e656-4e11-4c0c-8772-c1cc6dae34ce","created_by":"Jose Luis Sanchez Martinez (@Joseliyo_Jstnk)","name":"ScreenSaver Registry Key Set","tags":["attack.defense_evasion","attack.t1218.011"],"interval":"5m","description":"Detects registry key established after masqueraded .scr file execution using Rundll32 through desk.cpl","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Legitimate use of screen saver"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND process.executable:/.*\\\\[Rr][Uu][Nn][Dd][Ll][Ll]32\\.[Ee][Xx][Ee]/ AND registry.path:/.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\ [Pp][Aa][Nn][Ee][Ll]\\\\[Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\\\[Ss][Cc][Rr][Nn][Ss][Aa][Vv][Ee]\\.[Ee][Xx][Ee].*/ AND winlog.event_data.Details:/.*\\.[Ss][Cc][Rr]/) AND (NOT (winlog.event_data.Details:(/.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\.*/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Ww][Oo][Ww]64\\\\.*/))))","rule_id":"40b6e656-4e11-4c0c-8772-c1cc6dae34ce","timestamp_override":"event.ingested","references":["https://twitter.com/VakninHai/status/1517027824984547329","https://twitter.com/pabraeken/status/998627081360695297","https://jstnk9.github.io/jstnk9/research/InstallScreenSaver-SCR-files"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((winlog.event_data.EventType:SetValue AND process.executable:*\\\\rundll32.exe AND registry.path:*\\\\Control\\ Panel\\\\Desktop\\\\SCRNSAVE.EXE* AND winlog.event_data.Details:*.scr) AND (NOT (winlog.event_data.Details:(*C\\:\\\\Windows\\\\System32\\\\* OR *C\\:\\\\Windows\\\\SysWOW64\\\\*))))`"}
