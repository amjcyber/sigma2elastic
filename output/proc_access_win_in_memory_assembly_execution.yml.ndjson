{"id":"5f113a8f-8b61-41ca-b90f-d374fa7e4a39","created_by":"Perez Diego (@darkquassar), oscd.community, Jonhnathan Ribeiro","name":"Suspicious In-Memory Module Execution","tags":["attack.privilege_escalation","attack.defense_evasion","attack.t1055.001","attack.t1055.002"],"interval":"5m","description":"Detects the access to processes by other suspicious processes which have reflectively loaded libraries in their memory space. An example is SilentTrinity C2 behaviour. Generally speaking, when Sysmon EventID 10 cannot reference a stack call to a dll loaded from disk (the standard way), it will display \"UNKNOWN\" as the module name. Usually this means the stack call points to a module that was reflectively loaded in memory. Adding to this, it is not common to see such few calls in the stack (ntdll.dll --> kernelbase.dll --> unknown) which essentially means that most of the functions required by the process to execute certain routines are already present in memory, not requiring any calls to external libraries. The latter should also be considered suspicious.","risk_score":21,"enabled":true,"severity":"low","false_positives":["SysInternals Process Explorer"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((((winlog.event_data.CallTrace:/.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Nn][Tt][Dd][Ll][Ll]\\.[Dd][Ll][Ll]\\+.*/ AND winlog.event_data.CallTrace:/.*|[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Kk][Ee][Rr][Nn][Ee][Ll][Bb][Aa][Ss][Ee]\\.[Dd][Ll][Ll]\\+.*/ AND winlog.event_data.CallTrace:/.*|[Uu][Nn][Kk][Nn][Oo][Ww][Nn]\\(.*/ AND winlog.event_data.CallTrace:/.*\\).*/) OR (winlog.event_data.CallTrace:/.*[Uu][Nn][Kk][Nn][Oo][Ww][Nn]\\(.*/ AND winlog.event_data.CallTrace:/.*\\)|[Uu][Nn][Kk][Nn][Oo][Ww][Nn]\\(.*/ AND winlog.event_data.CallTrace:/.*\\)/)) OR (winlog.event_data.CallTrace:/.*[Uu][Nn][Kk][Nn][Oo][Ww][Nn].*/ AND winlog.event_data.GrantedAccess:(/0[Xx]1[Ff]0[Ff][Ff][Ff]/ OR /0[Xx]1[Ff]1[Ff][Ff][Ff]/ OR /0[Xx]143[Aa]/ OR /0[Xx]1410/ OR /0[Xx]1010/ OR /0[Xx]1[Ff]2[Ff][Ff][Ff]/ OR /0[Xx]1[Ff]3[Ff][Ff][Ff]/ OR /0[Xx]1[Ff][Ff][Ff][Ff][Ff]/))) AND (NOT ((process.executable:(/.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ss][Dd][Ii][Aa][Gg][Nn][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Rr][Oo][Cc][Ee][Xx][Pp]64\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Rr][Oo][Cc][Ee][Xx][Pp]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Vv][Ss]\\ [Cc][Oo][Dd][Ee]\\\\[Cc][Oo][Dd][Ee]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Aa][Uu][Rr][Oo][Rr][Aa]\\-[Aa][Gg][Ee][Nn][Tt]\\-64\\.[Ee][Xx][Ee]/ OR /.*\\\\[Aa][Uu][Rr][Oo][Rr][Aa]\\-[Aa][Gg][Ee][Nn][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Gg][Ii][Tt]\\\\[Uu][Ss][Rr]\\\\[Bb][Ii][Nn]\\\\[Ss][Hh]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ii][Dd][Ee]\\\\[Dd][Ee][Vv][Ee][Nn][Vv]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Gg][Ii][Tt][Hh][Uu][Bb][Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\\\[Uu][Pp][Dd][Aa][Tt][Ee]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Rr][Uu][Nn][Tt][Ii][Mm][Ee][Bb][Rr][Oo][Kk][Ee][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Bb][Aa][Cc][Kk][Gg][Rr][Oo][Uu][Nn][Dd][Tt][Aa][Ss][Kk][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Gg][Ii][Tt][Hh][Uu][Bb][Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\.[Ee][Xx][Ee]/) OR process.executable:(/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\ \\([Xx]86\\)\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\.[Nn][Ee][Tt]\\\\[Ff][Rr][Aa][Mm][Ee][Ww][Oo][Rr][Kk]\\\\.*\\\\[Nn][Gg][Ee][Nn][Tt][Aa][Ss][Kk]\\.[Ee][Xx][Ee].*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\ \\([Xx]86\\)\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Vv][Ii][Ss][Uu][Aa][Ll]\\ [Ss][Tt][Uu][Dd][Ii][Oo]\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Vv][Ii][Ss][Uu][Aa][Ll]\\ [Ss][Tt][Uu][Dd][Ii][Oo]\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\.[Nn][Ee][Tt]\\\\[Ff][Rr][Aa][Mm][Ee][Ww][Oo][Rr][Kk].*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Dd][Rr][Ii][Vv][Ee][Rr][Ss][Tt][Oo][Rr][Ee]\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss][Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\\\.*/) OR process.executable:(/[Cc]\\:\\\\[Uu][Ss][Ee][Rr][Ss]\\\\.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Vv][Ss]\\ [Cc][Oo][Dd][Ee]\\\\[Cc][Oo][Dd][Ee]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Tt][Aa][Ss][Kk][Hh][Oo][Ss][Tt][Ww]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Cc][Tt][Ff][Mm][Oo][Nn]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Nn][Hh][Nn][Oo][Tt][Ii][Ff][Ss][Yy][Ss]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ii][Mm][Mm][Ee][Rr][Ss][Ii][Vv][Ee][Cc][Oo][Nn][Tt][Rr][Oo][Ll][Pp][Aa][Nn][Ee][Ll]\\\\[Ss][Yy][Ss][Tt][Ee][Mm][Ss][Ee][Tt][Tt][Ii][Nn][Gg][Ss]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\.[Ee][Xx][Ee]/) OR winlog.event_data.TargetImage:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Rr][Uu][Nn][Tt][Ii][Mm][Ee][Bb][Rr][Oo][Kk][Ee][Rr]\\.[Ee][Xx][Ee]/ OR winlog.event_data.TargetImage:/.*\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Vv][Ss]\\ [Cc][Oo][Dd][Ee]\\\\[Cc][Oo][Dd][Ee]\\.[Ee][Xx][Ee]/ OR winlog.event_data.CallTrace:/.*|[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Rr][Pp][Cc][Rr][Tt]4\\.[Dd][Ll][Ll]\\+.*/) OR (process.executable:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\.[Ee][Xx][Ee]/ AND winlog.event_data.TargetImage:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Bb][Aa][Cc][Kk][Gg][Rr][Oo][Uu][Nn][Dd][Tt][Aa][Ss][Kk][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\.[Ee][Xx][Ee]/)) OR (process.executable:/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Dd][Aa][Tt][Aa]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Dd][Ee][Ff][Ee][Nn][Dd][Ee][Rr]\\\\[Pp][Ll][Aa][Tt][Ff][Oo][Rr][Mm]\\\\.*/ AND process.executable:/.*\\\\[Mm][Ss][Mm][Pp][Ee][Nn][Gg]\\.[Ee][Xx][Ee]/) OR (process.executable:/.*\\\\[Ee][Cc][Ll][Ii][Pp][Ss][Ee]\\.[Ee][Xx][Ee]/ AND winlog.event_data.CallTrace:(/.*\\\\[Jj][Rr][Ee]\\\\[Bb][Ii][Nn]\\\\[Jj][Aa][Vv][Aa]\\.[Dd][Ll][Ll].*/ OR /.*|[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\.[Ss][Tt][Oo][Rr][Aa][Gg][Ee]\\.[Dd][Ll][Ll]\\+.*/ OR /.*\\\\[Cc][Oo][Nn][Ff][Ii][Gg][Uu][Rr][Aa][Tt][Ii][Oo][Nn]\\\\[Oo][Rr][Gg]\\.[Ee][Cc][Ll][Ii][Pp][Ss][Ee]\\.[Oo][Ss][Gg][Ii]\\\\.*/)) OR (process.executable:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Oo][Pp][Ee][Nn][Ww][Ii][Tt][Hh]\\.[Ee][Xx][Ee]/ AND winlog.event_data.TargetImage:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\.[Ee][Xx][Ee]/))))","rule_id":"5f113a8f-8b61-41ca-b90f-d374fa7e4a39","timestamp_override":"event.ingested","references":["https://azure.microsoft.com/en-ca/blog/detecting-in-memory-attacks-with-sysmon-and-azure-security-center/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((((winlog.event_data.CallTrace:*C\\:\\\\WINDOWS\\\\SYSTEM32\\\\ntdll.dll\\+* AND winlog.event_data.CallTrace:*|C\\:\\\\WINDOWS\\\\System32\\\\KERNELBASE.dll\\+* AND winlog.event_data.CallTrace:*|UNKNOWN\\(* AND winlog.event_data.CallTrace:*\\)*) OR (winlog.event_data.CallTrace:*UNKNOWN\\(* AND winlog.event_data.CallTrace:*\\)|UNKNOWN\\(* AND winlog.event_data.CallTrace:*\\))) OR (winlog.event_data.CallTrace:*UNKNOWN* AND winlog.event_data.GrantedAccess:(0x1F0FFF OR 0x1F1FFF OR 0x143A OR 0x1410 OR 0x1010 OR 0x1F2FFF OR 0x1F3FFF OR 0x1FFFFF))) AND (NOT ((process.executable:(*\\\\Windows\\\\System32\\\\sdiagnhost.exe OR *\\\\procexp64.exe OR *\\\\procexp.exe OR *\\\\Microsoft\\ VS\\ Code\\\\Code.exe OR *\\\\aurora\\-agent\\-64.exe OR *\\\\aurora\\-agent.exe OR *\\\\git\\\\usr\\\\bin\\\\sh.exe OR *\\\\IDE\\\\devenv.exe OR *\\\\GitHubDesktop\\\\Update.exe OR *\\\\RuntimeBroker.exe OR *\\\\backgroundTaskHost.exe OR *\\\\GitHubDesktop.exe) OR process.executable:(C\\:\\\\Program\\ Files\\ \\(x86\\)\\\\* OR C\\:\\\\Program\\ Files\\\\* OR C\\:\\\\Windows\\\\Microsoft.NET\\\\Framework\\\\*\\\\NGenTask.exe* OR C\\:\\\\Program\\ Files\\ \\(x86\\)\\\\Microsoft\\ Visual\\ Studio\\\\* OR C\\:\\\\Program\\ Files\\\\Microsoft\\ Visual\\ Studio\\\\* OR C\\:\\\\Windows\\\\Microsoft.NET\\\\Framework* OR C\\:\\\\WINDOWS\\\\System32\\\\DriverStore\\\\* OR C\\:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\*) OR process.executable:(C\\:\\\\Users\\\\*\\\\AppData\\\\Local\\\\Programs\\\\Microsoft\\ VS\\ Code\\\\Code.exe OR C\\:\\\\WINDOWS\\\\system32\\\\taskhostw.exe OR C\\:\\\\WINDOWS\\\\system32\\\\ctfmon.exe OR C\\:\\\\WINDOWS\\\\system32\\\\NhNotifSys.exe OR C\\:\\\\Windows\\\\ImmersiveControlPanel\\\\SystemSettings.exe OR C\\:\\\\Windows\\\\explorer.exe) OR winlog.event_data.TargetImage:C\\:\\\\Windows\\\\System32\\\\RuntimeBroker.exe OR winlog.event_data.TargetImage:*\\\\Microsoft\\ VS\\ Code\\\\Code.exe OR winlog.event_data.CallTrace:*|C\\:\\\\WINDOWS\\\\System32\\\\RPCRT4.dll\\+*) OR (process.executable:C\\:\\\\WINDOWS\\\\Explorer.EXE AND winlog.event_data.TargetImage:(C\\:\\\\WINDOWS\\\\system32\\\\backgroundTaskHost.exe OR C\\:\\\\WINDOWS\\\\explorer.exe)) OR (process.executable:C\\:\\\\ProgramData\\\\Microsoft\\\\Windows\\ Defender\\\\Platform\\\\* AND process.executable:*\\\\MsMpEng.exe) OR (process.executable:*\\\\eclipse.exe AND winlog.event_data.CallTrace:(*\\\\jre\\\\bin\\\\java.dll* OR *|C\\:\\\\Windows\\\\SYSTEM32\\\\windows.storage.dll\\+* OR *\\\\configuration\\\\org.eclipse.osgi\\\\*)) OR (process.executable:C\\:\\\\Windows\\\\system32\\\\OpenWith.exe AND winlog.event_data.TargetImage:C\\:\\\\Windows\\\\Explorer.EXE))))`"}
