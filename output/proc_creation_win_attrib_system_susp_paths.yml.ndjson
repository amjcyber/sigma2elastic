{"id":"efec536f-72e8-4656-8960-5e85d091345b","created_by":"Nasreddine Bencherchali","name":"Set Suspicious Files as System Files Using Attrib","tags":["attack.defense_evasion","attack.t1564.001"],"interval":"5m","description":"Detects usage of attrib with \"+s\" option to set suspicious script or executable as system files to hide them from users and make them unable to delete with simple rights. The rule limit the search to specific extensions and directories to avoid FP's","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.executable:/.*\\\\[Aa][Tt][Tt][Rr][Ii][Bb]\\.[Ee][Xx][Ee]/ AND process.command_line:/.*\\ \\+[Ss].*/ AND process.command_line:(/.*\\ %.*/ OR /.*\\\\[Uu][Ss][Ee][Rr][Ss]\\\\[Pp][Uu][Bb][Ll][Ii][Cc]\\\\.*/ OR /.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\.*/ OR /.*\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Dd][Aa][Tt][Aa]\\\\.*/ OR /.*\\\\[Dd][Oo][Ww][Nn][Ll][Oo][Aa][Dd][Ss]\\\\.*/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp]\\\\.*/) AND process.command_line:(/.*\\.[Bb][Aa][Tt].*/ OR /.*\\.[Pp][Ss]1.*/ OR /.*\\.[Vv][Bb][Ee].*/ OR /.*\\.[Vv][Bb][Ss].*/ OR /.*\\.[Ee][Xx][Ee].*/)) AND (NOT (process.command_line:/.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp]\\\\.*/ AND process.command_line:/.*\\.[Ee][Xx][Ee].*/)))","rule_id":"efec536f-72e8-4656-8960-5e85d091345b","timestamp_override":"event.ingested","references":["https://app.any.run/tasks/c28cabc8-a19f-40f3-a78b-cae506a5c0d4","https://app.any.run/tasks/cfc8870b-ccd7-4210-88cf-a8087476a6d0"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.executable:*\\\\attrib.exe AND process.command_line:*\\ \\+s* AND process.command_line:(*\\ %* OR *\\\\Users\\\\Public\\\\* OR *\\\\AppData\\\\Local\\\\* OR *\\\\ProgramData\\\\* OR *\\\\Downloads\\\\* OR *\\\\Windows\\\\Temp\\\\*) AND process.command_line:(*.bat* OR *.ps1* OR *.vbe* OR *.vbs* OR *.exe*)) AND (NOT (process.command_line:*\\\\Windows\\\\TEMP\\\\* AND process.command_line:*.exe*)))`"}
