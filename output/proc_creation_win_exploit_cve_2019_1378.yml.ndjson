{"id":"1c373b6d-76ce-4553-997d-8c1da9a6b5f5","created_by":"Florian Roth, oscd.community, Jonhnathan Ribeiro","name":"Exploiting SetupComplete.cmd CVE-2019-1378","tags":["attack.privilege_escalation","attack.t1068","attack.execution","attack.t1059.003","attack.t1574","cve.2019.1378"],"interval":"5m","description":"Detects exploitation attempt of privilege escalation vulnerability via SetupComplete.cmd and PartnerSetupComplete.cmd described in CVE-2019-1378","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.parent.command_line:/.*\\\\[Cc][Mm][Dd]\\.[Ee][Xx][Ee].*/ AND process.parent.command_line:/.*\\/[Cc].*/ AND process.parent.command_line:/.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Ee][Tt][Uu][Pp]\\\\[Ss][Cc][Rr][Ii][Pp][Tt][Ss]\\\\.*/ AND process.parent.command_line:(/.*[Ss][Ee][Tt][Uu][Pp][Cc][Oo][Mm][Pp][Ll][Ee][Tt][Ee]\\.[Cc][Mm][Dd]/ OR /.*[Pp][Aa][Rr][Tt][Nn][Ee][Rr][Ss][Ee][Tt][Uu][Pp][Cc][Oo][Mm][Pp][Ll][Ee][Tt][Ee]\\.[Cc][Mm][Dd]/)) AND (NOT (process.executable:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Ww][Oo][Ww]64\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ww][Ii][Nn][Ss][Xx][Ss]\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Ee][Tt][Uu][Pp]\\\\.*/))))","rule_id":"1c373b6d-76ce-4553-997d-8c1da9a6b5f5","timestamp_override":"event.ingested","references":["https://www.embercybersecurity.com/blog/cve-2019-1378-exploiting-an-access-control-privilege-escalation-vulnerability-in-windows-10-update-assistant-wua"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.parent.command_line:*\\\\cmd.exe* AND process.parent.command_line:*\\/c* AND process.parent.command_line:*C\\:\\\\Windows\\\\Setup\\\\Scripts\\\\* AND process.parent.command_line:(*SetupComplete.cmd OR *PartnerSetupComplete.cmd)) AND (NOT (process.executable:(C\\:\\\\Windows\\\\System32\\\\* OR C\\:\\\\Windows\\\\SysWOW64\\\\* OR C\\:\\\\Windows\\\\WinSxS\\\\* OR C\\:\\\\Windows\\\\Setup\\\\*))))`"}
