{"id":"032f5fb3-d959-41a5-9263-4173c802dc2b","created_by":"Florian Roth, oscd.community, Jonhnathan Ribeiro","name":"Formbook Process Creation","tags":["attack.develop_capabilities","attack.t1587.001"],"interval":"5m","description":"Detects Formbook like process executions that inject code into a set of files in the System32 folder, which executes a special command command line to delete the dropper from the AppData Temp folder. We avoid false positives by excluding all parent process with command line parameters.","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.parent.command_line:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\.*/ OR /[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Ww][Oo][Ww]64\\\\.*/) AND process.parent.command_line:/.*\\.[Ee][Xx][Ee]/) AND ((process.command_line:/.*\\/[Cc].*/ AND process.command_line:/.*[Dd][Ee][Ll].*/ AND process.command_line:/.*[Cc]\\:\\\\[Uu][Ss][Ee][Rr][Ss]\\\\.*/ AND process.command_line:/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\[Tt][Ee][Mm][Pp]\\\\.*/) OR (process.command_line:/.*\\/[Cc].*/ AND process.command_line:/.*[Dd][Ee][Ll].*/ AND process.command_line:/.*[Cc]\\:\\\\[Uu][Ss][Ee][Rr][Ss]\\\\.*/ AND process.command_line:/.*\\\\[Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\\\.*/) OR (process.command_line:/.*\\/[Cc].*/ AND process.command_line:/.*[Tt][Yy][Pp][Ee]\\ [Nn][Uu][Ll]\\ \\>.*/ AND process.command_line:/.*[Cc]\\:\\\\[Uu][Ss][Ee][Rr][Ss]\\\\.*/ AND process.command_line:/.*\\\\[Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\\\.*/)) AND process.command_line:/.*\\.[Ee][Xx][Ee]/)","rule_id":"032f5fb3-d959-41a5-9263-4173c802dc2b","timestamp_override":"event.ingested","references":["https://inquest.net/blog/2018/06/22/a-look-at-formbook-stealer","https://app.any.run/tasks/388d5802-aa48-4826-b069-250420504758/","https://app.any.run/tasks/8e22486b-5edc-4cef-821c-373e945f296c/","https://app.any.run/tasks/62bb01ae-25a4-4180-b278-8e464a90b8d7/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.parent.command_line:(C\\:\\\\Windows\\\\System32\\\\* OR C\\:\\\\Windows\\\\SysWOW64\\\\*) AND process.parent.command_line:*.exe) AND ((process.command_line:*\\/c* AND process.command_line:*del* AND process.command_line:*C\\:\\\\Users\\\\* AND process.command_line:*\\\\AppData\\\\Local\\\\Temp\\\\*) OR (process.command_line:*\\/c* AND process.command_line:*del* AND process.command_line:*C\\:\\\\Users\\\\* AND process.command_line:*\\\\Desktop\\\\*) OR (process.command_line:*\\/C* AND process.command_line:*type\\ nul\\ >* AND process.command_line:*C\\:\\\\Users\\\\* AND process.command_line:*\\\\Desktop\\\\*)) AND process.command_line:*.exe)`"}
