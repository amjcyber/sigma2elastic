{"id":"c3a99af4-35a9-4668-879e-c09aeb4f2bdf","created_by":"Tim Shelton, Florian Roth, Yassine Oukessou (fix + fp)","name":"Rundll32 Execution Without DLL File","tags":null,"interval":"5m","description":"Detects the execution of rundll32 with a command line that doesn't contain a .dll file","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(process.executable:/.*\\\\[Rr][Uu][Nn][Dd][Ll][Ll]32\\.[Ee][Xx][Ee]/ AND (NOT ((NOT _exists_:process.command_line) OR (process.command_line:/.*\\.[Dd][Ll][Ll].*/ OR process.command_line:\"\") OR (process.parent.executable:/.*\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Ii][Nn][Tt][Ee][Rr][Nn][Ee][Tt]\\ [Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\\\[Ii][Ee][Xx][Pp][Ll][Oo][Rr][Ee]\\.[Ee][Xx][Ee]/ AND process.command_line:/.*\\.[Cc][Pp][Ll].*/) OR (process.parent.executable:/.*\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Ww][Oo][Ww]64\\\\[Mm][Ss][Ii][Ee][Xx][Ee][Cc]\\.[Ee][Xx][Ee]/ AND process.parent.command_line:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Ww][Oo][Ww]64\\\\[Mm][Ss][Ii][Ee][Xx][Ee][Cc]\\.[Ee][Xx][Ee]\\ \\-[Ee][Mm][Bb][Ee][Dd][Dd][Ii][Nn][Gg].*/) OR (process.parent.executable:/.*\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Mm][Ss][Ii][Ee][Xx][Ee][Cc]\\.[Ee][Xx][Ee]/ AND process.parent.command_line:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Mm][Ss][Ii][Ee][Xx][Ee][Cc]\\.[Ee][Xx][Ee]\\ \\-[Ee][Mm][Bb][Ee][Dd][Dd][Ii][Nn][Gg].*/) OR (process.parent.executable:/.*\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Cc][Mm][Dd]\\.[Ee][Xx][Ee]/ AND process.parent.command_line:/.*\\ [Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Ss][Pp][Ll][Uu][Nn][Kk][Uu][Nn][Ii][Vv][Ee][Rr][Ss][Aa][Ll][Ff][Oo][Rr][Ww][Aa][Rr][Dd][Ee][Rr]\\\\.*/) OR (process.command_line:/.*\\ \\-[Ll][Oo][Cc][Aa][Ll][Ss][Ee][Rr][Vv][Ee][Rr]\\ .*/))))","rule_id":"c3a99af4-35a9-4668-879e-c09aeb4f2bdf","timestamp_override":"event.ingested","references":["https://twitter.com/mrd0x/status/1481630810495139841?s=12"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(process.executable:*\\\\rundll32.exe AND (NOT ((NOT _exists_:process.command_line) OR (process.command_line:*.dll* OR process.command_line:\"\") OR (process.parent.executable:*\\:\\\\Program\\ Files\\\\Internet\\ Explorer\\\\iexplore.exe AND process.command_line:*.cpl*) OR (process.parent.executable:*\\:\\\\Windows\\\\SysWOW64\\\\msiexec.exe AND process.parent.command_line:C\\:\\\\Windows\\\\syswow64\\\\MsiExec.exe\\ \\-Embedding*) OR (process.parent.executable:*\\:\\\\Windows\\\\System32\\\\msiexec.exe AND process.parent.command_line:C\\:\\\\Windows\\\\system32\\\\MsiExec.exe\\ \\-Embedding*) OR (process.parent.executable:*\\:\\\\Windows\\\\System32\\\\cmd.exe AND process.parent.command_line:*\\ C\\:\\\\Program\\ Files\\\\SplunkUniversalForwarder\\\\*) OR (process.command_line:*\\ \\-localserver\\ *))))`"}
