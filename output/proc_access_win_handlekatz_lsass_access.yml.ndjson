{"id":"b1bd3a59-c1fd-4860-9f40-4dd161a7d1f5","created_by":"Bhabesh Raj (rule), @thefLinkk","name":"HandleKatz Duplicating LSASS Handle","tags":["attack.execution","attack.t1106","attack.defense_evasion","attack.t1003.001"],"interval":"5m","description":"Detects HandleKatz opening LSASS to duplicate its handle to later dump the memory without opening any new handles","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(winlog.event_data.TargetImage:/.*\\\\[Ll][Ss][Aa][Ss][Ss]\\.[Ee][Xx][Ee]/ AND winlog.event_data.GrantedAccess:/0[Xx]1440/ AND winlog.event_data.CallTrace:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Nn][Tt][Dd][Ll][Ll]\\.[Dd][Ll][Ll]\\+.*/ AND winlog.event_data.CallTrace:/.*|[Uu][Nn][Kk][Nn][Oo][Ww][Nn]\\(.*/ AND winlog.event_data.CallTrace:/.*\\)/)","rule_id":"b1bd3a59-c1fd-4860-9f40-4dd161a7d1f5","timestamp_override":"event.ingested","references":["https://github.com/codewhitesec/HandleKatz"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(winlog.event_data.TargetImage:*\\\\lsass.exe AND winlog.event_data.GrantedAccess:0x1440 AND winlog.event_data.CallTrace:C\\:\\\\Windows\\\\System32\\\\ntdll.dll\\+* AND winlog.event_data.CallTrace:*|UNKNOWN\\(* AND winlog.event_data.CallTrace:*\\))`"}
