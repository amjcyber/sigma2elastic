{"id":"f26307d8-14cd-47e3-a26b-4b4769f24af6","created_by":"Florian Roth","name":"CrackMapExec Process Patterns","tags":["attack.credential_access","attack.t1003.001"],"interval":"5m","description":"Detects suspicious process patterns found in logs when CrackMapExec is used","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.command_line:/.*[Cc][Mm][Dd]\\.[Ee][Xx][Ee]\\ \\/[Cc]\\ .*/ AND process.command_line:/.*[Tt][Aa][Ss][Kk][Ll][Ii][Ss][Tt]\\ \\/[Ff][Ii]\\ .*/ AND process.command_line:/.*[Ii][Mm][Aa][Gg][Ee][Nn][Aa][Mm][Ee]\\ [Ee][Qq]\\ [Ll][Ss][Aa][Ss][Ss]\\.[Ee][Xx][Ee].*/ AND winlog.event_data.User:(/.*[Aa][Uu][Tt][Hh][Oo][Rr][Ii].*/ OR /.*[Aa][Uu][Tt][Oo][Rr][Ii].*/)) OR (process.command_line:/.*[Dd][Oo]\\ [Rr][Uu][Nn][Dd][Ll][Ll]32\\.[Ee][Xx][Ee]\\ [Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Cc][Oo][Mm][Ss][Vv][Cc][Ss]\\.[Dd][Ll][Ll],\\ [Mm][Ii][Nn][Ii][Dd][Uu][Mm][Pp].*/ AND process.command_line:/.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp]\\\\.*/ AND process.command_line:/.*\\ [Ff][Uu][Ll][Ll].*/ AND process.command_line:/.*%%[Bb].*/) OR (process.command_line:/.*[Tt][Aa][Ss][Kk][Ll][Ii][Ss][Tt]\\ \\/[Vv]\\ \\/[Ff][Oo]\\ [Cc][Ss][Vv].*/ AND process.command_line:/.*[Ff][Ii][Nn][Dd][Ss][Tt][Rr]\\ \\/[Ii]\\ \\\"[Ll][Ss][Aa][Ss][Ss]\\\".*/))","rule_id":"f26307d8-14cd-47e3-a26b-4b4769f24af6","timestamp_override":"event.ingested","references":["https://mpgn.gitbook.io/crackmapexec/smb-protocol/obtaining-credentials/dump-lsass"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.command_line:*cmd.exe\\ \\/c\\ * AND process.command_line:*tasklist\\ \\/fi\\ * AND process.command_line:*Imagename\\ eq\\ lsass.exe* AND winlog.event_data.User:(*AUTHORI* OR *AUTORI*)) OR (process.command_line:*do\\ rundll32.exe\\ C\\:\\\\windows\\\\System32\\\\comsvcs.dll,\\ MiniDump* AND process.command_line:*\\\\Windows\\\\Temp\\\\* AND process.command_line:*\\ full* AND process.command_line:*%%B*) OR (process.command_line:*tasklist\\ \\/v\\ \\/fo\\ csv* AND process.command_line:*findstr\\ \\/i\\ \\\"lsass\\\"*))`"}
