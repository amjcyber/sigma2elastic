{"id":"ca621ba5-54ab-4035-9942-d378e6fcde3c","created_by":"Florian Roth","name":"HandleKatz LSASS Dumper Usage","tags":["attack.credential_access","attack.t1003.001"],"interval":"5m","description":"Detects the use of HandleKatz, a tool that demonstrates the usage of cloned handles to Lsass in order to create an obfuscated memory dump of the same","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.pe.imphash:(/38[Dd]9[Ee]015591[Bb][Bb][Ff][Dd]4929[Ee]0[Dd]0[Ff]47[Ff][Aa]0055/ OR /0[Ee]2216679[Cc][Aa]6[Ee]1094[Dd]63322[Ee]3412[Dd]650/) OR related.hash:(/[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=38[Dd]9[Ee]015591[Bb][Bb][Ff][Dd]4929[Ee]0[Dd]0[Ff]47[Ff][Aa]0055/ OR /[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=0[Ee]2216679[Cc][Aa]6[Ee]1094[Dd]63322[Ee]3412[Dd]650/)) OR (process.command_line:/.*\\-\\-[Pp][Ii][Dd]\\:.*/ AND process.command_line:/.*\\-\\-[Oo][Uu][Tt][Ff][Ii][Ll][Ee]\\:.*/ AND process.command_line:(/.*\\.[Dd][Mm][Pp].*/ OR /.*[Ll][Ss][Aa][Ss][Ss].*/ OR /.*\\.[Oo][Bb][Ff].*/ OR /.*[Dd][Uu][Mm][Pp].*/)))","rule_id":"ca621ba5-54ab-4035-9942-d378e6fcde3c","timestamp_override":"event.ingested","references":["https://github.com/codewhitesec/HandleKatz"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.pe.imphash:(38d9e015591bbfd4929e0d0f47fa0055 OR 0e2216679ca6e1094d63322e3412d650) OR related.hash:(IMPHASH\\=38D9E015591BBFD4929E0D0F47FA0055 OR IMPHASH\\=0E2216679CA6E1094D63322E3412D650)) OR (process.command_line:*\\-\\-pid\\:* AND process.command_line:*\\-\\-outfile\\:* AND process.command_line:(*.dmp* OR *lsass* OR *.obf* OR *dump*)))`"}
