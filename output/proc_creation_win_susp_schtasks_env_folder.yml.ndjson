{"id":"81325ce1-be01-4250-944f-b4789644556f","created_by":"Florian Roth","name":"Suspicious Schtasks From Env Var Folder","tags":["attack.execution","attack.t1053.005"],"interval":"5m","description":"Detects Schtask creations that point to a suspicious folder or an environment variable often used by malware","risk_score":73,"enabled":true,"severity":"high","false_positives":["Benign scheduled tasks creations or executions that happen often during software installations","Software that uses the AppData folder and scheduled tasks to update the software in the AppData folders"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(((process.executable:/.*\\\\[Ss][Cc][Hh][Tt][Aa][Ss][Kk][Ss]\\.[Ee][Xx][Ee]/ AND process.command_line:/.*\\ \\/[Cc][Rr][Ee][Aa][Tt][Ee]\\ .*/ AND process.command_line:(/.*%[Aa][Pp][Pp][Dd][Aa][Tt][Aa]%.*/ OR /.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll]\\\\.*/ OR /.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Rr][Oo][Aa][Mm][Ii][Nn][Gg]\\\\.*/ OR /.*%[Pp][Uu][Bb][Ll][Ii][Cc]%.*/ OR /.*\\\\[Uu][Ss][Ee][Rr][Ss]\\\\[Pp][Uu][Bb][Ll][Ii][Cc].*/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp].*/ OR /.*[Cc]\\:\\\\[Pp][Ee][Rr][Ff][Ll][Oo][Gg][Ss].*/)) OR (process.parent.command_line:/.*\\\\[Ss][Vv][Cc][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]\\ \\-[Kk]\\ [Nn][Ee][Tt][Ss][Vv][Cc][Ss]\\ \\-[Pp]\\ \\-[Ss]\\ [Ss][Cc][Hh][Ee][Dd][Uu][Ll][Ee]/ AND process.command_line:(/.*%[Pp][Uu][Bb][Ll][Ii][Cc]%.*/ OR /.*\\\\[Uu][Ss][Ee][Rr][Ss]\\\\[Pp][Uu][Bb][Ll][Ii][Cc].*/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp].*/ OR /.*[Cc]\\:\\\\[Pp][Ee][Rr][Ff][Ll][Oo][Gg][Ss].*/))) AND (NOT ((process.command_line:/.*[Uu][Pp][Dd][Aa][Tt][Ee]_[Tt][Aa][Ss][Kk]\\.[Xx][Mm][Ll].*/ OR process.parent.command_line:/.*[Uu][Nn][Aa][Tt][Tt][Ee][Nn][Dd][Ee][Dd]\\.[Ii][Nn][Ii].*/))))","rule_id":"81325ce1-be01-4250-944f-b4789644556f","timestamp_override":"event.ingested","references":["https://www.welivesecurity.com/2022/01/18/donot-go-do-not-respawn/","https://www.joesandbox.com/analysis/514608/0/html#324415FF7D8324231381BAD48A052F85DF04"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(((process.executable:*\\\\schtasks.exe AND process.command_line:*\\ \\/create\\ * AND process.command_line:(*%AppData%* OR *\\\\AppData\\\\Local\\\\* OR *\\\\AppData\\\\Roaming\\\\* OR *%Public%* OR *\\\\Users\\\\Public* OR *C\\:\\\\Windows\\\\Temp* OR *C\\:\\\\Perflogs*)) OR (process.parent.command_line:*\\\\svchost.exe\\ \\-k\\ netsvcs\\ \\-p\\ \\-s\\ Schedule AND process.command_line:(*%Public%* OR *\\\\Users\\\\Public* OR *C\\:\\\\Windows\\\\Temp* OR *C\\:\\\\Perflogs*))) AND (NOT ((process.command_line:*update_task.xml* OR process.parent.command_line:*unattended.ini*))))`"}
