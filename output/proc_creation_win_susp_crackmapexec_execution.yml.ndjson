{"id":"058f4380-962d-40a5-afce-50207d36d7e2","created_by":"Thomas Patzke","name":"CrackMapExec Command Execution","tags":["attack.execution","attack.t1047","attack.t1053","attack.t1059.003","attack.t1059.001","attack.s0106"],"interval":"5m","description":"Detect various execution methods of the CrackMapExec pentesting framework","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(process.command_line:(/.*[Cc][Mm][Dd]\\.[Ee][Xx][Ee]\\ \\/[Qq]\\ \\/[Cc]\\ .*\\ 1\\>\\ \\\\\\\\.*\\\\.*\\\\.*\\ 2\\>\\&1/ OR /.*[Cc][Mm][Dd]\\.[Ee][Xx][Ee]\\ \\/[Cc]\\ .*\\ \\>\\ \\\\\\\\.*\\\\.*\\\\.*\\ 2\\>\\&1/ OR /.*[Cc][Mm][Dd]\\.[Ee][Xx][Ee]\\ \\/[Cc]\\ .*\\ \\>\\ .*\\\\[Tt][Ee][Mm][Pp]\\\\.*\\ 2\\>\\&1/) AND process.command_line:(/.*[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]\\ \\-[Ee][Xx][Ee][Cc]\\ [Bb][Yy][Pp][Aa][Ss][Ss]\\ \\-[Nn][Oo][Nn][Ii]\\ \\-[Nn][Oo][Pp]\\ \\-[Ww]\\ 1\\ \\-[Cc]\\ \\\".*/ OR /.*[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]\\ \\-[Nn][Oo][Nn][Ii]\\ \\-[Nn][Oo][Pp]\\ \\-[Ww]\\ 1\\ \\-[Ee][Nn][Cc]\\ .*/))","rule_id":"058f4380-962d-40a5-afce-50207d36d7e2","timestamp_override":"event.ingested","references":["https://github.com/byt3bl33d3r/CrackMapExec"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(process.command_line:(*cmd.exe\\ \\/Q\\ \\/c\\ *\\ 1>\\ \\\\\\\\*\\\\*\\\\*\\ 2>&1 OR *cmd.exe\\ \\/C\\ *\\ >\\ \\\\\\\\*\\\\*\\\\*\\ 2>&1 OR *cmd.exe\\ \\/C\\ *\\ >\\ *\\\\Temp\\\\*\\ 2>&1) AND process.command_line:(*powershell.exe\\ \\-exec\\ bypass\\ \\-noni\\ \\-nop\\ \\-w\\ 1\\ \\-C\\ \\\"* OR *powershell.exe\\ \\-noni\\ \\-nop\\ \\-w\\ 1\\ \\-enc\\ *))`"}
