{"id":"dcaa3f04-70c3-427a-80b4-b870d73c94c4","created_by":"Florian Roth","name":"Suspicious Csc.exe Source File Folder","tags":["attack.defense_evasion","attack.t1027.004"],"interval":"5m","description":"Detects a suspicious execution of csc.exe, which uses a source in a suspicious folder (e.g. AppData)","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Legitimate software from program files - https://twitter.com/gN3mes1s/status/1206874118282448897","Legitimate Microsoft software - https://twitter.com/gabriele_pippi/status/1206907900268072962"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.executable:/.*\\\\[Cc][Ss][Cc]\\.[Ee][Xx][Ee]/ AND process.command_line:(/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\.*/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp]\\\\.*/)) AND (NOT (process.parent.executable:/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss].*/ OR process.parent.executable:(/.*\\\\[Ss][Dd][Ii][Aa][Gg][Nn][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww]3[Ww][Pp]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Cc][Hh][Oo][Cc][Oo]\\.[Ee][Xx][Ee]/) OR process.parent.command_line:/.*\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Dd][Aa][Tt][Aa]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Dd][Ee][Ff][Ee][Nn][Dd][Ee][Rr]\\ [Aa][Dd][Vv][Aa][Nn][Cc][Ee][Dd]\\ [Tt][Hh][Rr][Ee][Aa][Tt]\\ [Pp][Rr][Oo][Tt][Ee][Cc][Tt][Ii][Oo][Nn].*/)))","rule_id":"dcaa3f04-70c3-427a-80b4-b870d73c94c4","timestamp_override":"event.ingested","references":["https://securityboulevard.com/2019/08/agent-tesla-evading-edr-by-removing-api-hooks/","https://www.clearskysec.com/wp-content/uploads/2018/11/MuddyWater-Operations-in-Lebanon-and-Oman.pdf","https://app.any.run/tasks/c6993447-d1d8-414e-b856-675325e5aa09/","https://twitter.com/gN3mes1s/status/1206874118282448897"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.executable:*\\\\csc.exe AND process.command_line:(*\\\\AppData\\\\* OR *\\\\Windows\\\\Temp\\\\*)) AND (NOT (process.parent.executable:C\\:\\\\Program\\ Files* OR process.parent.executable:(*\\\\sdiagnhost.exe OR *\\\\w3wp.exe OR *\\\\choco.exe) OR process.parent.command_line:*\\\\ProgramData\\\\Microsoft\\\\Windows\\ Defender\\ Advanced\\ Threat\\ Protection*)))`"}
