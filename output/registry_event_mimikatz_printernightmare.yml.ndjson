{"id":"ba6b9e43-1d45-4d3c-a504-1043a64c8469","created_by":"Markus Neis, @markus_neis, Florian Roth","name":"PrinterNightmare Mimimkatz Driver Name","tags":["attack.execution","attack.t1204","cve.2021.1675","cve.2021.34527"],"interval":"5m","description":"Detects static QMS 810 and mimikatz driver name used by Mimikatz as exploited in CVE-2021-1675 and CVE-2021-34527","risk_score":99,"enabled":true,"severity":"critical","false_positives":["Legitimate installation of printer driver QMS 810, Texas Instruments microLaser printer (unlikely)"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((registry.path:(/.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\\\[Pp][Rr][Ii][Nn][Tt]\\\\[Ee][Nn][Vv][Ii][Rr][Oo][Nn][Mm][Ee][Nn][Tt][Ss]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Xx]64\\\\[Dd][Rr][Ii][Vv][Ee][Rr][Ss]\\\\[Vv][Ee][Rr][Ss][Ii][Oo][Nn]\\-3\\\\[Qq][Mm][Ss]\\ 810\\\\.*/ OR /.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\\\[Pp][Rr][Ii][Nn][Tt]\\\\[Ee][Nn][Vv][Ii][Rr][Oo][Nn][Mm][Ee][Nn][Tt][Ss]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Xx]64\\\\[Dd][Rr][Ii][Vv][Ee][Rr][Ss]\\\\[Vv][Ee][Rr][Ss][Ii][Oo][Nn]\\-3\\\\[Mm][Ii][Mm][Ii][Kk][Aa][Tt][Zz].*/) OR (registry.path:/.*[Ll][Ee][Gg][Ii][Tt][Pp][Rr][Ii][Nn][Tt][Ee][Rr].*/ AND registry.path:/.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\\\[Pp][Rr][Ii][Nn][Tt]\\\\[Ee][Nn][Vv][Ii][Rr][Oo][Nn][Mm][Ee][Nn][Tt][Ss]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss].*/)) OR (registry.path:(/.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\\\[Pp][Rr][Ii][Nn][Tt]\\\\[Ee][Nn][Vv][Ii][Rr][Oo][Nn][Mm][Ee][Nn][Tt][Ss].*/ OR /.*\\\\[Cc][Uu][Rr][Rr][Ee][Nn][Tt][Vv][Ee][Rr][Ss][Ii][Oo][Nn]\\\\[Pp][Rr][Ii][Nn][Tt]\\\\[Pp][Rr][Ii][Nn][Tt][Ee][Rr][Ss].*/) AND registry.path:(/.*[Gg][Ee][Nn][Tt][Ii][Ll]\\ [Kk][Ii][Ww][Ii].*/ OR /.*[Mm][Ii][Mm][Ii][Kk][Aa][Tt][Zz]\\ [Pp][Rr][Ii][Nn][Tt][Ee][Rr].*/ OR /.*[Kk][Ii][Ww][Ii]\\ [Ll][Ee][Gg][Ii][Tt]\\ [Pp][Rr][Ii][Nn][Tt][Ee][Rr].*/)))","rule_id":"ba6b9e43-1d45-4d3c-a504-1043a64c8469","timestamp_override":"event.ingested","references":["https://github.com/gentilkiwi/mimikatz/commit/c21276072b3f2a47a21e215a46962a17d54b3760","https://www.lexjansen.com/sesug/1993/SESUG93035.pdf","https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/4464eaf0-f34f-40d5-b970-736437a21913"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((registry.path:(*\\\\Control\\\\Print\\\\Environments\\\\Windows\\ x64\\\\Drivers\\\\Version\\-3\\\\QMS\\ 810\\\\* OR *\\\\Control\\\\Print\\\\Environments\\\\Windows\\ x64\\\\Drivers\\\\Version\\-3\\\\mimikatz*) OR (registry.path:*legitprinter* AND registry.path:*\\\\Control\\\\Print\\\\Environments\\\\Windows*)) OR (registry.path:(*\\\\Control\\\\Print\\\\Environments* OR *\\\\CurrentVersion\\\\Print\\\\Printers*) AND registry.path:(*Gentil\\ Kiwi* OR *mimikatz\\ printer* OR *Kiwi\\ Legit\\ Printer*)))`"}
