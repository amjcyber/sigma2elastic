{"id":"679085d5-f427-4484-9f58-1dc30a7c426d","created_by":"Florian Roth","name":"WinDivert Driver Load","tags":["attack.collection","attack.defense_evasion","attack.t1599.001","attack.t1557.001"],"interval":"5m","description":"Detects the load of the Windiver driver, a powerful user-mode capture/sniffing/modification/blocking/re-injection package for Windows","risk_score":73,"enabled":true,"severity":"high","false_positives":["Legitimate WinDivert driver usage"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(file.path:(/.*\\\\[Ww][Ii][Nn][Dd][Ii][Vv][Ee][Rr][Tt]\\.[Ss][Yy][Ss].*/ OR /.*\\\\[Ww][Ii][Nn][Dd][Ii][Vv][Ee][Rr][Tt]64\\.[Ss][Yy][Ss].*/ OR /.*\\\\[Nn][Oo][Rr][Dd][Dd][Ii][Vv][Ee][Rr][Tt]\\.[Ss][Yy][Ss].*/ OR /.*\\\\[Ll][Ii][Nn][Gg][Tt][Ii][Ww][Ff][Pp]\\.[Ss][Yy][Ss].*/ OR /.*\\\\[Ee][Ss][Ww][Ff][Pp]\\.[Ss][Yy][Ss].*/) OR related.hash:(/.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=0604[Bb][Bb]7[Cc][Bb]4[Bb][Bb]851[Ee]2168[Dd]5[Cc]7[Dd]9399087.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=2[Ee]5[Ff]0[Ee]649[Dd]97[Ff]32[Bb]03[Cc]09[Ee]4686[Dd]0574[Ff].*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=52[Ff]8[Aa][Aa]269[Ff]69[Ff]0[Ee][Dd][Aa][Dd]9[Ee]8[Ff][Cc][Dd][Aa][Ee][Dd][Cc][Ee]276.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=[Cc]0[Ee]5[Dd]314[Dd][Aa]39[Dd][Bb][Ff]65[Aa]2[Dd][Bb][Ff][Ff]409[Cc][Cc]2[Cc]76.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=58623490691[Bb][Aa][Bb][Ee]8330[Aa][Dd][Cc]81[Cc][Dd]04[Aa]663.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=8[Ee][Ee]39[Bb]48656[Ee]4[Dd]6[Bb]8459[Dd]7[Bb][Aa]7[Dd][Aa]7438[Bb].*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=45[Ee][Ee]545[Aa][Ee]77[Ee]8[Dd]43[Ff][Cc]70[Ee][Dd][Ee]9[Ee][Ff][Cc][Dd]4[Cc]96.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=[Aa]1[Bb]2[Ee]245[Aa][Cc][Dd]47[Ee]4[Aa]348[Ee]1[Aa]552[Aa]02859[Aa].*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=2[Aa]5[Ff]85[Ff][Ee]4609461[Cc]6339637594[Ff][Aa]9[Bb]0[Aa].*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=6[Bb]2[Cc]6[Ff]95233[Cc]2914[Dd]1[Dd]488[Ee][Ee]27531[Aa][Cc][Cc].*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=9[Ff]2[Ff][Dd][Dd]3[Ff]9[Aa][Bb]922[Bb][Bb][Bb]0560[Aa]7[Dd][Ff]46[Ff]4342.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=[Dd]8[Aa]719865[Cc]448[Bb]1[Bb][Dd]2[Ee][Cc]241[Ee]46[Aa][Cc]1[Cc]88.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=0[Ee][Aa]54[Ff]8[Cc]9[Aa][Ff]4[Aa]2[Ff][Ee]8367[Ff][Aa]457[Ff]48[Ee][Dd]38.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=9[Dd]519[Aa][Ee]0[Aa]0864[Dd]6[Dd]6[Aa][Ee]3[Ff]8[Bb]6[Cc]9[Cc]70[Aa][Ff]6.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=[Aa]74929[Ee][Dd][Ff][Cc]3289895[Ee]3[Ff]2885278947[Aa][Ee].*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=[Aa]66[Bb]476[Cc]2[Dd]06[Cc]370[Ff]0[Aa]53[Bb]5537[Ff]2[Ff]11[Ee].*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=[Bb][Dd][Cc][Dd]836[Aa]46[Bb][Cc]2415773[Ff]6[Bb]5[Ee][Aa]77[Aa]46[Ee]4.*/ OR /.*[Ii][Mm][Pp][Hh][Aa][Ss][Hh]\\=[Cc]28[Cc][Dd]6[Cc][Cc][Dd]83179[Ee]79[Dd][Aa][Cc]132[Aa]553693[Dd]9.*/) OR IMPHASH:(/0604[Bb][Bb]7[Cc][Bb]4[Bb][Bb]851[Ee]2168[Dd]5[Cc]7[Dd]9399087/ OR /2[Ee]5[Ff]0[Ee]649[Dd]97[Ff]32[Bb]03[Cc]09[Ee]4686[Dd]0574[Ff]/ OR /52[Ff]8[Aa][Aa]269[Ff]69[Ff]0[Ee][Dd][Aa][Dd]9[Ee]8[Ff][Cc][Dd][Aa][Ee][Dd][Cc][Ee]276/ OR /[Cc]0[Ee]5[Dd]314[Dd][Aa]39[Dd][Bb][Ff]65[Aa]2[Dd][Bb][Ff][Ff]409[Cc][Cc]2[Cc]76/ OR /58623490691[Bb][Aa][Bb][Ee]8330[Aa][Dd][Cc]81[Cc][Dd]04[Aa]663/ OR /8[Ee][Ee]39[Bb]48656[Ee]4[Dd]6[Bb]8459[Dd]7[Bb][Aa]7[Dd][Aa]7438[Bb]/ OR /45[Ee][Ee]545[Aa][Ee]77[Ee]8[Dd]43[Ff][Cc]70[Ee][Dd][Ee]9[Ee][Ff][Cc][Dd]4[Cc]96/ OR /[Aa]1[Bb]2[Ee]245[Aa][Cc][Dd]47[Ee]4[Aa]348[Ee]1[Aa]552[Aa]02859[Aa]/ OR /2[Aa]5[Ff]85[Ff][Ee]4609461[Cc]6339637594[Ff][Aa]9[Bb]0[Aa]/ OR /6[Bb]2[Cc]6[Ff]95233[Cc]2914[Dd]1[Dd]488[Ee][Ee]27531[Aa][Cc][Cc]/ OR /9[Ff]2[Ff][Dd][Dd]3[Ff]9[Aa][Bb]922[Bb][Bb][Bb]0560[Aa]7[Dd][Ff]46[Ff]4342/ OR /[Dd]8[Aa]719865[Cc]448[Bb]1[Bb][Dd]2[Ee][Cc]241[Ee]46[Aa][Cc]1[Cc]88/ OR /0[Ee][Aa]54[Ff]8[Cc]9[Aa][Ff]4[Aa]2[Ff][Ee]8367[Ff][Aa]457[Ff]48[Ee][Dd]38/ OR /9[Dd]519[Aa][Ee]0[Aa]0864[Dd]6[Dd]6[Aa][Ee]3[Ff]8[Bb]6[Cc]9[Cc]70[Aa][Ff]6/ OR /[Aa]74929[Ee][Dd][Ff][Cc]3289895[Ee]3[Ff]2885278947[Aa][Ee]/ OR /[Aa]66[Bb]476[Cc]2[Dd]06[Cc]370[Ff]0[Aa]53[Bb]5537[Ff]2[Ff]11[Ee]/ OR /[Bb][Dd][Cc][Dd]836[Aa]46[Bb][Cc]2415773[Ff]6[Bb]5[Ee][Aa]77[Aa]46[Ee]4/ OR /[Cc]28[Cc][Dd]6[Cc][Cc][Dd]83179[Ee]79[Dd][Aa][Cc]132[Aa]553693[Dd]9/))","rule_id":"679085d5-f427-4484-9f58-1dc30a7c426d","timestamp_override":"event.ingested","references":["https://reqrypt.org/windivert-doc.html","https://rastamouse.me/ntlm-relaying-via-cobalt-strike/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(file.path:(*\\\\WinDivert.sys* OR *\\\\WinDivert64.sys* OR *\\\\NordDivert.sys* OR *\\\\lingtiwfp.sys* OR *\\\\eswfp.sys*) OR related.hash:(*IMPHASH\\=0604bb7cb4bb851e2168d5c7d9399087* OR *IMPHASH\\=2e5f0e649d97f32b03c09e4686d0574f* OR *IMPHASH\\=52f8aa269f69f0edad9e8fcdaedce276* OR *IMPHASH\\=c0e5d314da39dbf65a2dbff409cc2c76* OR *IMPHASH\\=58623490691babe8330adc81cd04a663* OR *IMPHASH\\=8ee39b48656e4d6b8459d7ba7da7438b* OR *IMPHASH\\=45ee545ae77e8d43fc70ede9efcd4c96* OR *IMPHASH\\=a1b2e245acd47e4a348e1a552a02859a* OR *IMPHASH\\=2a5f85fe4609461c6339637594fa9b0a* OR *IMPHASH\\=6b2c6f95233c2914d1d488ee27531acc* OR *IMPHASH\\=9f2fdd3f9ab922bbb0560a7df46f4342* OR *IMPHASH\\=d8a719865c448b1bd2ec241e46ac1c88* OR *IMPHASH\\=0ea54f8c9af4a2fe8367fa457f48ed38* OR *IMPHASH\\=9d519ae0a0864d6d6ae3f8b6c9c70af6* OR *IMPHASH\\=a74929edfc3289895e3f2885278947ae* OR *IMPHASH\\=a66b476c2d06c370f0a53b5537f2f11e* OR *IMPHASH\\=bdcd836a46bc2415773f6b5ea77a46e4* OR *IMPHASH\\=c28cd6ccd83179e79dac132a553693d9*) OR IMPHASH:(0604bb7cb4bb851e2168d5c7d9399087 OR 2e5f0e649d97f32b03c09e4686d0574f OR 52f8aa269f69f0edad9e8fcdaedce276 OR c0e5d314da39dbf65a2dbff409cc2c76 OR 58623490691babe8330adc81cd04a663 OR 8ee39b48656e4d6b8459d7ba7da7438b OR 45ee545ae77e8d43fc70ede9efcd4c96 OR a1b2e245acd47e4a348e1a552a02859a OR 2a5f85fe4609461c6339637594fa9b0a OR 6b2c6f95233c2914d1d488ee27531acc OR 9f2fdd3f9ab922bbb0560a7df46f4342 OR d8a719865c448b1bd2ec241e46ac1c88 OR 0ea54f8c9af4a2fe8367fa457f48ed38 OR 9d519ae0a0864d6d6ae3f8b6c9c70af6 OR a74929edfc3289895e3f2885278947ae OR a66b476c2d06c370f0a53b5537f2f11e OR bdcd836a46bc2415773f6b5ea77a46e4 OR c28cd6ccd83179e79dac132a553693d9))`"}
