{"id":"f59c3faf-50f3-464b-9f4c-1b67ab512d99","created_by":"Victor Sergeev, Daniil Yugoslavskiy, Gleb Sukhodolskiy, Timur Zinniatullin, oscd.community, Tim Shelton, frack113 (split), wagga (name)","name":"Common Autorun Keys Modification","tags":["attack.persistence","attack.t1547.001"],"interval":"5m","description":"Detects modification of autostart extensibility point (ASEP) in registry.","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Legitimate software automatically (mostly, during installation) sets up autorun keys for legitimate reason","Legitimate administrator sets up autorun keys for legitimate reason"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:(/.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Ww][Oo][Ww]6432[Nn][Oo][Dd][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Cc][Ee]\\ [Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\[Aa][Uu][Tt][Oo][Ss][Tt][Aa][Rr][Tt].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Ww][Oo][Ww]6432[Nn][Oo][Dd][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd]\\ [Pp][Rr][Oo][Cc][Ee][Ss][Ss][Oo][Rr]\\\\[Aa][Uu][Tt][Oo][Rr][Uu][Nn].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Ww][Oo][Ww]6432[Nn][Oo][Dd][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Aa][Cc][Tt][Ii][Vv][Ee]\\ [Ss][Ee][Tt][Uu][Pp]\\\\[Ii][Nn][Ss][Tt][Aa][Ll][Ll][Ee][Dd]\\ [Cc][Oo][Mm][Pp][Oo][Nn][Ee][Nn][Tt][Ss].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Cc][Ee]\\ [Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\[Aa][Uu][Tt][Oo][Ss][Tt][Aa][Rr][Tt][Oo][Nn][Dd][Ii][Ss][Cc][Oo][Nn][Nn][Ee][Cc][Tt].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Cc][Ee]\\ [Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\[Aa][Uu][Tt][Oo][Ss][Tt][Aa][Rr][Tt][Oo][Nn][Cc][Oo][Nn][Nn][Ee][Cc][Tt].*/ OR /.*\\\\[Ss][Yy][Ss][Tt][Ee][Mm]\\\\[Ss][Ee][Tt][Uu][Pp]\\\\[Cc][Mm][Dd][Ll][Ii][Nn][Ee].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Cc][Tt][Ff]\\\\[Ll][Aa][Nn][Gg][Bb][Aa][Rr][Aa][Dd][Dd][Ii][Nn].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd]\\ [Pp][Rr][Oo][Cc][Ee][Ss][Ss][Oo][Rr]\\\\[Aa][Uu][Tt][Oo][Rr][Uu][Nn].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Aa][Cc][Tt][Ii][Vv][Ee]\\ [Ss][Ee][Tt][Uu][Pp]\\\\[Ii][Nn][Ss][Tt][Aa][Ll][Ll][Ee][Dd]\\ [Cc][Oo][Mm][Pp][Oo][Nn][Ee][Nn][Tt][Ss].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Pp][Rr][Oo][Tt][Oo][Cc][Oo][Ll][Ss]\\\\[Hh][Aa][Nn][Dd][Ll][Ee][Rr].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Pp][Rr][Oo][Tt][Oo][Cc][Oo][Ll][Ss]\\\\[Ff][Ii][Ll][Tt][Ee][Rr].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Hh][Tt][Mm][Ll][Ff][Ii][Ll][Ee]\\\\[Ss][Hh][Ee][Ll][Ll]\\\\[Oo][Pp][Ee][Nn]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd]\\\\\\([Dd][Ee][Ff][Aa][Uu][Ll][Tt]\\).*/ OR /.*\\\\[Ee][Nn][Vv][Ii][Rr][Oo][Nn][Mm][Ee][Nn][Tt]\\\\[Uu][Ss][Ee][Rr][Ii][Nn][Ii][Tt][Mm][Pp][Rr][Ll][Oo][Gg][Oo][Nn][Ss][Cc][Rr][Ii][Pp][Tt].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Pp][Oo][Ll][Ii][Cc][Ii][Ee][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\ [Pp][Aa][Nn][Ee][Ll]\\\\[Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\\\[Ss][Cc][Rr][Nn][Ss][Aa][Vv][Ee]\\.[Ee][Xx][Ee].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ii][Nn][Tt][Ee][Rr][Nn][Ee][Tt]\\ [Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\\\[Uu][Rr][Ll][Ss][Ee][Aa][Rr][Cc][Hh][Hh][Oo][Oo][Kk][Ss].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ii][Nn][Tt][Ee][Rr][Nn][Ee][Tt]\\ [Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\\\[Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\\\[Cc][Oo][Mm][Pp][Oo][Nn][Ee][Nn][Tt][Ss].*/ OR /.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Cc][Ll][Ss][Ii][Dd]\\\\\\{[Aa][Bb]8902[Bb]4\\-09[Cc][Aa]\\-4[Bb][Bb]6\\-[Bb]78[Dd]\\-[Aa]8[Ff]59079[Aa]8[Dd]5\\}\\\\[Ii][Nn][Pp][Rr][Oo][Cc][Ss][Ee][Rr][Vv][Ee][Rr]32.*/ OR /.*\\\\[Cc][Oo][Nn][Tt][Rr][Oo][Ll]\\ [Pp][Aa][Nn][Ee][Ll]\\\\[Dd][Ee][Ss][Kk][Tt][Oo][Pp]\\\\[Ss][Cc][Rr][Nn][Ss][Aa][Vv][Ee]\\.[Ee][Xx][Ee].*/)) AND (NOT ((winlog.event_data.Details:/\\([Ee][Mm][Pp][Tt][Yy]\\)/) OR (registry.path:(/.*\\\\[Oo][Ff][Ff][Ii][Cc][Ee]\\\\[Cc][Ll][Ii][Cc][Kk][Tt][Oo][Rr][Uu][Nn]\\\\[Rr][Ee][Gg][Ii][Ss][Tt][Rr][Yy]\\\\[Mm][Aa][Cc][Hh][Ii][Nn][Ee]\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Pp][Rr][Oo][Tt][Oo][Cc][Oo][Ll][Ss]\\\\[Hh][Aa][Nn][Dd][Ll][Ee][Rr]\\\\.*/ OR /.*\\\\[Cc][Ll][Ii][Cc][Kk][Tt][Oo][Rr][Uu][Nn][Ss][Tt][Oo][Rr][Ee]\\\\[Hh][Kk][Mm][Uu]\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Pp][Rr][Oo][Tt][Oo][Cc][Oo][Ll][Ss]\\\\[Hh][Aa][Nn][Dd][Ll][Ee][Rr]\\\\.*/) OR winlog.event_data.Details:(/\\{314111[Cc]7\\-[Aa]502\\-11[Dd]2\\-[Bb][Bb][Cc][Aa]\\-00[Cc]04[Ff]8[Ee][Cc]294\\}/ OR /\\{3459[Bb]272\\-[Cc][Cc]19\\-4448\\-86[Cc]9\\-[Dd][Dd][Cc]3[Bb]4[Bb]2[Ff][Aa][Dd]3\\}/ OR /\\{42089[Dd]2[Dd]\\-912[Dd]\\-4018\\-9087\\-2[Bb]87803[Ee]93[Ff][Bb]\\}/ OR /\\{5504[Bb][Ee]45\\-[Aa]83[Bb]\\-4808\\-900[Aa]\\-3[Aa]5[Cc]36[Ee]7[Ff]77[Aa]\\}/ OR /\\{807583[Ee]5\\-5146\\-11[Dd]5\\-[Aa]672\\-00[Bb]0[Dd]022[Ee]945\\}/)) OR (registry.path:/.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Aa][Cc][Tt][Ii][Vv][Ee]\\ [Ss][Ee][Tt][Uu][Pp]\\\\[Ii][Nn][Ss][Tt][Aa][Ll][Ll][Ee][Dd]\\ [Cc][Oo][Mm][Pp][Oo][Nn][Ee][Nn][Tt][Ss]\\\\\\{8[Aa]69[Dd]345\\-[Dd]564\\-463[Cc]\\-[Aa][Ff][Ff]1\\-[Aa]69[Dd]9[Ee]530[Ff]96\\}\\\\.*/) OR (registry.path:/.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Aa][Cc][Tt][Ii][Vv][Ee]\\ [Ss][Ee][Tt][Uu][Pp]\\\\[Ii][Nn][Ss][Tt][Aa][Ll][Ll][Ee][Dd]\\ [Cc][Oo][Mm][Pp][Oo][Nn][Ee][Nn][Tt][Ss]\\\\\\{9459[Cc]573\\-[Bb]17[Aa]\\-45[Aa][Ee]\\-9[Ff]64\\-1857[Bb]5[Dd]58[Cc][Ee][Ee]\\}\\\\.*/) OR (registry.path:/.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Aa][Cc][Tt][Ii][Vv][Ee]\\ [Ss][Ee][Tt][Uu][Pp]\\\\[Ii][Nn][Ss][Tt][Aa][Ll][Ll][Ee][Dd]\\ [Cc][Oo][Mm][Pp][Oo][Nn][Ee][Nn][Tt][Ss]\\\\\\{89820200\\-[Ee][Cc][Bb][Dd]\\-11[Cc][Ff]\\-8[Bb]85\\-00[Aa][Aa]005[Bb]4383\\}\\\\.*/) OR (process.executable:(/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Pp][Oo][Qq][Ee][Xx][Ee][Cc]\\.[Ee][Xx][Ee]/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\ \\([Xx]86\\)\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Oo][Ff][Ff][Ii][Cc][Ee]\\\\[Rr][Oo][Oo][Tt]\\\\[Ii][Nn][Tt][Ee][Gg][Rr][Aa][Tt][Ii][Oo][Nn]\\\\[Ii][Nn][Tt][Ee][Gg][Rr][Aa][Tt][Oo][Rr]\\.[Ee][Xx][Ee]/)) OR (process.executable:(/[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Cc][Oo][Mm][Mm][Oo][Nn]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Ss][Hh][Aa][Rr][Ee][Dd]\\\\[Cc][Ll][Ii][Cc][Kk][Tt][Oo][Rr][Uu][Nn]\\\\.*/ OR /[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Cc][Oo][Mm][Mm][Oo][Nn]\\ [Ff][Ii][Ll][Ee][Ss]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Ss][Hh][Aa][Rr][Ee][Dd]\\\\[Cc][Ll][Ii][Cc][Kk][Tt][Oo][Rr][Uu][Nn]\\\\[Uu][Pp][Dd][Aa][Tt][Ee][Ss]\\\\.*/) AND process.executable:/.*\\\\[Oo][Ff][Ff][Ii][Cc][Ee][Cc][Ll][Ii][Cc][Kk][Tt][Oo][Rr][Uu][Nn]\\.[Ee][Xx][Ee]/))))","rule_id":"f59c3faf-50f3-464b-9f4c-1b67ab512d99","timestamp_override":"event.ingested","references":["https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1547.001/T1547.001.md","https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns","https://gist.github.com/GlebSukhodolskiy/0fc5fa5f482903064b448890db1eaf9d","https://persistence-info.github.io/Data/userinitmprlogonscript.html"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((winlog.event_data.EventType:SetValue AND registry.path:(*\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Windows\\ CE\\ Services\\\\AutoStart* OR *\\\\Software\\\\Wow6432Node\\\\Microsoft\\\\Command\\ Processor\\\\Autorun* OR *\\\\SOFTWARE\\\\Wow6432Node\\\\Microsoft\\\\Active\\ Setup\\\\Installed\\ Components* OR *\\\\SOFTWARE\\\\Microsoft\\\\Windows\\ CE\\ Services\\\\AutoStartOnDisconnect* OR *\\\\SOFTWARE\\\\Microsoft\\\\Windows\\ CE\\ Services\\\\AutoStartOnConnect* OR *\\\\SYSTEM\\\\Setup\\\\CmdLine* OR *\\\\Software\\\\Microsoft\\\\Ctf\\\\LangBarAddin* OR *\\\\Software\\\\Microsoft\\\\Command\\ Processor\\\\Autorun* OR *\\\\SOFTWARE\\\\Microsoft\\\\Active\\ Setup\\\\Installed\\ Components* OR *\\\\SOFTWARE\\\\Classes\\\\Protocols\\\\Handler* OR *\\\\SOFTWARE\\\\Classes\\\\Protocols\\\\Filter* OR *\\\\SOFTWARE\\\\Classes\\\\Htmlfile\\\\Shell\\\\Open\\\\Command\\\\\\(Default\\)* OR *\\\\Environment\\\\UserInitMprLogonScript* OR *\\\\SOFTWARE\\\\Policies\\\\Microsoft\\\\Windows\\\\Control\\ Panel\\\\Desktop\\\\Scrnsave.exe* OR *\\\\Software\\\\Microsoft\\\\Internet\\ Explorer\\\\UrlSearchHooks* OR *\\\\SOFTWARE\\\\Microsoft\\\\Internet\\ Explorer\\\\Desktop\\\\Components* OR *\\\\Software\\\\Classes\\\\Clsid\\\\\\{AB8902B4\\-09CA\\-4bb6\\-B78D\\-A8F59079A8D5\\}\\\\Inprocserver32* OR *\\\\Control\\ Panel\\\\Desktop\\\\Scrnsave.exe*)) AND (NOT ((winlog.event_data.Details:\\(Empty\\)) OR (registry.path:(*\\\\Office\\\\ClickToRun\\\\REGISTRY\\\\MACHINE\\\\Software\\\\Classes\\\\PROTOCOLS\\\\Handler\\\\* OR *\\\\ClickToRunStore\\\\HKMU\\\\SOFTWARE\\\\Classes\\\\PROTOCOLS\\\\Handler\\\\*) OR winlog.event_data.Details:(\\{314111c7\\-a502\\-11d2\\-bbca\\-00c04f8ec294\\} OR \\{3459B272\\-CC19\\-4448\\-86C9\\-DDC3B4B2FAD3\\} OR \\{42089D2D\\-912D\\-4018\\-9087\\-2B87803E93FB\\} OR \\{5504BE45\\-A83B\\-4808\\-900A\\-3A5C36E7F77A\\} OR \\{807583E5\\-5146\\-11D5\\-A672\\-00B0D022E945\\})) OR (registry.path:*\\\\SOFTWARE\\\\Microsoft\\\\Active\\ Setup\\\\Installed\\ Components\\\\\\{8A69D345\\-D564\\-463c\\-AFF1\\-A69D9E530F96\\}\\\\*) OR (registry.path:*\\\\SOFTWARE\\\\Microsoft\\\\Active\\ Setup\\\\Installed\\ Components\\\\\\{9459C573\\-B17A\\-45AE\\-9F64\\-1857B5D58CEE\\}\\\\*) OR (registry.path:*\\\\Software\\\\Microsoft\\\\Active\\ Setup\\\\Installed\\ Components\\\\\\{89820200\\-ECBD\\-11cf\\-8B85\\-00AA005B4383\\}\\\\*) OR (process.executable:(C\\:\\\\Windows\\\\System32\\\\poqexec.exe OR C\\:\\\\Program\\ Files\\ \\(x86\\)\\\\Microsoft\\ Office\\\\root\\\\integration\\\\integrator.exe)) OR (process.executable:(C\\:\\\\Program\\ Files\\\\Common\\ Files\\\\Microsoft\\ Shared\\\\ClickToRun\\\\* OR C\\:\\\\Program\\ Files\\\\Common\\ Files\\\\Microsoft\\ Shared\\\\ClickToRun\\\\Updates\\\\*) AND process.executable:*\\\\OfficeClickToRun.exe))))`"}
