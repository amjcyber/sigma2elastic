{"id":"d7326048-328b-4d5e-98af-86e84b17c765","created_by":"Roberto Rodriguez @Cyb3rWard0g","name":"Alternate PowerShell Hosts","tags":["attack.execution","attack.t1059.001"],"interval":"5m","description":"Detects alternate PowerShell hosts potentially bypassing detections looking for powershell.exe","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Programs using PowerShell directly without invocation of a dedicated interpreter","MSP Detection Searcher","Citrix ConfigSync.ps1"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(process.command_line:/.*/ AND (NOT (process.command_line:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss][Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\\\[Vv]1\\.0\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee].*/ OR winlog.event_data.ContextInfo:/.*[Cc][Ii][Tt][Rr][Ii][Xx]\\\\[Cc][Oo][Nn][Ff][Ii][Gg][Ss][Yy][Nn][Cc]\\\\[Cc][Oo][Nn][Ff][Ii][Gg][Ss][Yy][Nn][Cc]\\.[Pp][Ss]1.*/)))","rule_id":"d7326048-328b-4d5e-98af-86e84b17c765","timestamp_override":"event.ingested","references":["https://threathunterplaybook.com/notebooks/windows/02_execution/WIN-190815181010.html"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(process.command_line:* AND (NOT (process.command_line:C\\:\\\\WINDOWS\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe* OR winlog.event_data.ContextInfo:*Citrix\\\\ConfigSync\\\\ConfigSync.ps1*)))`"}
