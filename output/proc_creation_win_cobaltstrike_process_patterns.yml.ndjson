{"id":"f35c5d71-b489-4e22-a115-f003df287317","created_by":"Florian Roth","name":"CobaltStrike Process Patterns","tags":["attack.execution","attack.t1059"],"interval":"5m","description":"Detects process patterns found in Cobalt Strike beacon activity (see reference for more details) and also cases in which a China Chopper like webshell is used to run whoami","risk_score":73,"enabled":true,"severity":"high","false_positives":["Other programs that cause these patterns (please report)"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.command_line:/.*\\\\[Cc][Mm][Dd]\\.[Ee][Xx][Ee]\\ \\/[Cc]\\ [Ww][Hh][Oo][Aa][Mm][Ii].*/ AND process.parent.executable:/[Cc]\\:\\\\[Tt][Ee][Mm][Pp].*/) OR (process.command_line:/.*[Cc][Oo][Nn][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]\\ 0[Xx][Ff][Ff][Ff][Ff][Ff][Ff][Ff][Ff]\\ \\-[Ff][Oo][Rr][Cc][Ee][Vv]1.*/ AND process.parent.command_line:(/.*\\/[Cc]\\ [Ww][Hh][Oo][Aa][Mm][Ii].*/ OR /.*[Cc][Mm][Dd]\\.[Ee][Xx][Ee]\\ \\/[Cc]\\ [Ee][Cc][Hh][Oo].*/ OR /.*\\ \\>\\ \\\\\\\\\\.\\\\[Pp][Ii][Pp][Ee].*/)) OR (process.command_line:(/.*[Cc][Mm][Dd]\\.[Ee][Xx][Ee]\\ \\/[Cc]\\ [Ee][Cc][Hh][Oo].*/ OR /.*\\>\\ \\\\\\\\\\.\\\\[Pp][Ii][Pp][Ee].*/ OR /.*\\\\[Ww][Hh][Oo][Aa][Mm][Ii]\\.[Ee][Xx][Ee].*/) AND process.parent.executable:/.*\\\\[Dd][Ll][Ll][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/) OR (process.executable:/.*\\\\[Cc][Mm][Dd]\\.[Ee][Xx][Ee]/ AND process.parent.executable:/.*\\\\[Rr][Uu][Nn][Oo][Nn][Cc][Ee]\\.[Ee][Xx][Ee]/ AND process.parent.command_line:/.*\\\\[Rr][Uu][Nn][Oo][Nn][Cc][Ee]\\.[Ee][Xx][Ee]/))","rule_id":"f35c5d71-b489-4e22-a115-f003df287317","timestamp_override":"event.ingested","references":["https://hausec.com/2021/07/26/cobalt-strike-and-tradecraft/","https://thedfirreport.com/2021/08/29/cobalt-strike-a-defenders-guide/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.command_line:*\\\\cmd.exe\\ \\/C\\ whoami* AND process.parent.executable:C\\:\\\\Temp*) OR (process.command_line:*conhost.exe\\ 0xffffffff\\ \\-ForceV1* AND process.parent.command_line:(*\\/C\\ whoami* OR *cmd.exe\\ \\/C\\ echo* OR *\\ >\\ \\\\\\\\.\\\\pipe*)) OR (process.command_line:(*cmd.exe\\ \\/c\\ echo* OR *>\\ \\\\\\\\.\\\\pipe* OR *\\\\whoami.exe*) AND process.parent.executable:*\\\\dllhost.exe) OR (process.executable:*\\\\cmd.exe AND process.parent.executable:*\\\\runonce.exe AND process.parent.command_line:*\\\\runonce.exe))`"}
