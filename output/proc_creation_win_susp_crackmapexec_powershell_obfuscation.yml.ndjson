{"id":"6f8b3439-a203-45dc-a88b-abf57ea15ccf","created_by":"Thomas Patzke","name":"CrackMapExec PowerShell Obfuscation","tags":["attack.execution","attack.t1059.001","attack.defense_evasion","attack.t1027.005"],"interval":"5m","description":"The CrachMapExec pentesting framework implements a PowerShell obfuscation with some static strings detected by this rule.","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(process.command_line:(/.*[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee].*/ OR /.*[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee].*/) AND process.command_line:(/.*[Jj][Oo][Ii][Nn].*[Ss][Pp][Ll][Ii][Tt].*/ OR /.*\\(\\ $[Ss][Hh][Ee][Ll][Ll][Ii][Dd]\\[1\\]\\+$[Ss][Hh][Ee][Ll][Ll][Ii][Dd]\\[13\\]\\+'[Xx]'\\).*/ OR /.*\\(\\ $[Pp][Ss][Hh][Oo][Mm][Ee]\\[.*\\]\\+$[Pp][Ss][Hh][Oo][Mm][Ee]\\[.*\\]\\+.*/ OR /.*\\(\\ $[Ee][Nn][Vv]\\:[Pp][Uu][Bb][Ll][Ii][Cc]\\[13\\]\\+$[Ee][Nn][Vv]\\:[Pp][Uu][Bb][Ll][Ii][Cc]\\[5\\]\\+'[Xx]'\\).*/ OR /.*\\(\\ $[Ee][Nn][Vv]\\:[Cc][Oo][Mm][Ss][Pp][Ee][Cc]\\[4,.*,25\\]\\-[Jj][Oo][Ii][Nn]''\\).*/ OR /.*\\[1,3\\]\\+'[Xx]'\\-[Jj][Oo][Ii][Nn]''\\).*/))","rule_id":"6f8b3439-a203-45dc-a88b-abf57ea15ccf","timestamp_override":"event.ingested","references":["https://github.com/byt3bl33d3r/CrackMapExec","https://github.com/byt3bl33d3r/CrackMapExec/blob/0a49f75347b625e81ee6aa8c33d3970b5515ea9e/cme/helpers/powershell.py#L242"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(process.command_line:(*powershell.exe* OR *pwsh.exe*) AND process.command_line:(*join*split* OR *\\(\\ $ShellId\\[1\\]\\+$ShellId\\[13\\]\\+'x'\\)* OR *\\(\\ $PSHome\\[*\\]\\+$PSHOME\\[*\\]\\+* OR *\\(\\ $env\\:Public\\[13\\]\\+$env\\:Public\\[5\\]\\+'x'\\)* OR *\\(\\ $env\\:ComSpec\\[4,*,25\\]\\-Join''\\)* OR *\\[1,3\\]\\+'x'\\-Join''\\)*))`"}
