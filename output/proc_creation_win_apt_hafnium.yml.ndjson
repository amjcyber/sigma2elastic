{"id":"bbb2dedd-a0e3-46ab-ba6c-6c82ae7a9aa7","created_by":"Florian Roth","name":"Exchange Exploitation Activity","tags":["attack.persistence","attack.t1546","attack.t1053"],"interval":"5m","description":"Detects activity observed by different researchers to be HAFNIUM group activity (or related) on Exchange servers","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.command_line:/.*[Aa][Tt][Tt][Rr][Ii][Bb].*/ AND process.command_line:/.*\\ \\+[Hh]\\ .*/ AND process.command_line:/.*\\ \\+[Ss]\\ .*/ AND process.command_line:/.*\\ \\+[Rr]\\ .*/ AND process.command_line:/.*\\.[Aa][Ss][Pp][Xx].*/) OR (process.command_line:/.*[Ss][Cc][Hh][Tt][Aa][Ss][Kk][Ss].*/ AND process.command_line:/.*[Vv][Ss][Pp][Ee][Rr][Ff][Mm][Oo][Nn].*/) OR (process.command_line:/.*[Vv][Ss][Ss][Aa][Dd][Mm][Ii][Nn]\\ [Ll][Ii][Ss][Tt]\\ [Ss][Hh][Aa][Dd][Oo][Ww][Ss].*/ AND process.command_line:/.*[Tt][Ee][Mm][Pp]\\\\__[Oo][Uu][Tt][Pp][Uu][Tt].*/) OR process.command_line:/.*%[Tt][Ee][Mm][Pp]%\\\\[Ee][Xx][Ee][Cc][Uu][Tt][Ee]\\.[Bb][Aa][Tt].*/ OR process.executable:/.*[Uu][Ss][Ee][Rr][Ss]\\\\[Pp][Uu][Bb][Ll][Ii][Cc]\\\\[Oo][Pp][Ee][Rr][Aa]\\\\[Oo][Pp][Ee][Rr][Aa]_[Bb][Rr][Oo][Ww][Ss][Ee][Rr]\\.[Ee][Xx][Ee]/ OR (process.executable:/.*[Oo][Pp][Ee][Rr][Aa]_[Bb][Rr][Oo][Ww][Ss][Ee][Rr]\\.[Ee][Xx][Ee]/ AND process.parent.executable:(/.*\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Vv][Cc][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/)) OR process.executable:/.*\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Dd][Aa][Tt][Aa]\\\\[Vv][Ss][Pp][Ee][Rr][Ff][Mm][Oo][Nn]\\\\.*/ OR (process.command_line:/.*\\ \\-[Tt]7[Zz]\\ .*/ AND process.command_line:/.*[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Dd][Aa][Tt][Aa]\\\\[Pp][Ss][Tt].*/ AND process.command_line:/.*\\\\[Ii][Tt]\\.[Zz][Ii][Pp].*/) OR (process.executable:/.*\\\\[Mm][Aa][Kk][Ee][Cc][Aa][Bb]\\.[Ee][Xx][Ee]/ AND process.command_line:(/.*[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ee][Xx][Cc][Hh][Aa][Nn][Gg][Ee]\\ [Ss][Ee][Rr][Vv][Ee][Rr]\\\\.*/ OR /.*[Ii][Nn][Ee][Tt][Pp][Uu][Bb]\\\\[Ww][Ww][Ww][Rr][Oo][Oo][Tt].*/)) OR process.command_line:(/.*\\\\[Tt][Ee][Mm][Pp]\\\\[Xx][Xx]\\.[Bb][Aa][Tt].*/ OR /.*[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ww][Ww][Aa][Nn][Ss][Vv][Cc][Dd][Cc][Ss].*/ OR /.*[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp]\\\\[Cc][Ww]\\.[Ee][Xx][Ee].*/) OR (process.command_line:/.*\\\\[Cc][Oo][Mm][Ss][Vv][Cc][Ss]\\.[Dd][Ll][Ll].*/ AND process.command_line:/.*[Mm][Ii][Nn][Ii][Dd][Uu][Mm][Pp].*/ AND process.command_line:/.*\\\\[Ii][Nn][Ee][Tt][Pp][Uu][Bb]\\\\[Ww][Ww][Ww][Rr][Oo][Oo][Tt].*/) OR (process.command_line:/.*[Dd][Ss][Qq][Uu][Ee][Rr][Yy].*/ AND process.command_line:/.*\\ \\-[Uu][Cc][Oo]\\ .*/ AND process.command_line:/.*\\\\[Ii][Nn][Ee][Tt][Pp][Uu][Bb]\\\\[Ww][Ww][Ww][Rr][Oo][Oo][Tt].*/))","rule_id":"bbb2dedd-a0e3-46ab-ba6c-6c82ae7a9aa7","timestamp_override":"event.ingested","references":["https://blog.truesec.com/2021/03/07/exchange-zero-day-proxylogon-and-hafnium/","https://www.microsoft.com/security/blog/2021/03/02/hafnium-targeting-exchange-servers/","https://discuss.elastic.co/t/detection-and-response-for-hafnium-activity/266289/3","https://twitter.com/GadixCRK/status/1369313704869834753?s=20","https://twitter.com/BleepinComputer/status/1372218235949617161"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.command_line:*attrib* AND process.command_line:*\\ \\+h\\ * AND process.command_line:*\\ \\+s\\ * AND process.command_line:*\\ \\+r\\ * AND process.command_line:*.aspx*) OR (process.command_line:*schtasks* AND process.command_line:*VSPerfMon*) OR (process.command_line:*vssadmin\\ list\\ shadows* AND process.command_line:*Temp\\\\__output*) OR process.command_line:*%TEMP%\\\\execute.bat* OR process.executable:*Users\\\\Public\\\\opera\\\\Opera_browser.exe OR (process.executable:*Opera_browser.exe AND process.parent.executable:(*\\\\services.exe OR *\\\\svchost.exe)) OR process.executable:*\\\\ProgramData\\\\VSPerfMon\\\\* OR (process.command_line:*\\ \\-t7z\\ * AND process.command_line:*C\\:\\\\Programdata\\\\pst* AND process.command_line:*\\\\it.zip*) OR (process.executable:*\\\\makecab.exe AND process.command_line:(*Microsoft\\\\Exchange\\ Server\\\\* OR *inetpub\\\\wwwroot*)) OR process.command_line:(*\\\\Temp\\\\xx.bat* OR *Windows\\\\WwanSvcdcs* OR *Windows\\\\Temp\\\\cw.exe*) OR (process.command_line:*\\\\comsvcs.dll* AND process.command_line:*Minidump* AND process.command_line:*\\\\inetpub\\\\wwwroot*) OR (process.command_line:*dsquery* AND process.command_line:*\\ \\-uco\\ * AND process.command_line:*\\\\inetpub\\\\wwwroot*))`"}
