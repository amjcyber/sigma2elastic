{"id":"a54f842a-3713-4b45-8c84-5f136fdebd3c","created_by":"Andreas Hunkeler (@Karneades)","name":"PortProxy Registry Key","tags":["attack.lateral_movement","attack.defense_evasion","attack.command_and_control","attack.t1090"],"interval":"5m","description":"Detects the modification of PortProxy registry key which is used for port forwarding. For command execution see rule win_netsh_port_fwd.yml.","risk_score":47,"enabled":true,"severity":"medium","false_positives":["WSL2 network bridge PowerShell script used for WSL/Kubernetes/Docker (e.g. https://github.com/microsoft/WSL/issues/4150#issuecomment-504209723)","Synergy Software KVM (https://symless.com/synergy)"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"registry.path:/[Hh][Kk][Ll][Mm]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]\\\\[Cc][Uu][Rr][Rr][Ee][Nn][Tt][Cc][Oo][Nn][Tt][Rr][Oo][Ll][Ss][Ee][Tt]\\\\[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Ss]\\\\[Pp][Oo][Rr][Tt][Pp][Rr][Oo][Xx][Yy]\\\\[Vv]4[Tt][Oo][Vv]4\\\\[Tt][Cc][Pp]/","rule_id":"a54f842a-3713-4b45-8c84-5f136fdebd3c","timestamp_override":"event.ingested","references":["https://www.fireeye.com/blog/threat-research/2019/01/bypassing-network-restrictions-through-rdp-tunneling.html","https://adepts.of0x.cc/netsh-portproxy-code/","https://www.dfirnotes.net/portproxy_detection/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`registry.path:HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\PortProxy\\\\v4tov4\\\\tcp`"}
