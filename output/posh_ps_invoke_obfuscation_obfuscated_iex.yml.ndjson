{"id":"1b9dc62e-6e9e-42a3-8990-94d7a10007f7","created_by":"Daniel Bohannon (@Mandiant/@FireEye), oscd.community","name":"Invoke-Obfuscation Obfuscated IEX Invocation","tags":["attack.defense_evasion","attack.t1027","attack.execution","attack.t1059.001"],"interval":"5m","description":"Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the following code block \\u2014","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(powershell.file.script_block_text:/\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\[/ OR powershell.file.script_block_text:/\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\[/ OR powershell.file.script_block_text:/\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\[/ OR powershell.file.script_block_text:/\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}/ OR powershell.file.script_block_text:/\\\\\\\\*mdr\\\\\\\\*\\W\\s*\\)\\.Name/ OR powershell.file.script_block_text:/\\$VerbosePreference\\.ToString\\(/)","rule_id":"1b9dc62e-6e9e-42a3-8990-94d7a10007f7","timestamp_override":"event.ingested","references":["https://github.com/danielbohannon/Invoke-Obfuscation/blob/f20e7f843edd0a3a7716736e9eddfa423395dd26/Out-ObfuscatedStringCommand.ps1#L873-L888"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(powershell.file.script_block_text:/\\$PSHome\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$PSHome\\[/ OR powershell.file.script_block_text:/\\$ShellId\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$ShellId\\[/ OR powershell.file.script_block_text:/\\$env:Public\\[\\s*\\d{1,3}\\s*\\]\\s*\\+\\s*\\$env:Public\\[/ OR powershell.file.script_block_text:/\\$env:ComSpec\\[(\\s*\\d{1,3}\\s*,){2}/ OR powershell.file.script_block_text:/\\\\\\\\*mdr\\\\\\\\*\\W\\s*\\)\\.Name/ OR powershell.file.script_block_text:/\\$VerbosePreference\\.ToString\\(/)`"}
