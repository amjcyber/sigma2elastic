{"id":"f10ed525-97fe-4fed-be7c-2feecca941b1","created_by":"Nasreddine Bencherchali","name":"Persistence Via Hhctrl.ocx","tags":["attack.persistence"],"interval":"5m","description":"Detects when an attacker modifies the registry value of the \"hhctrl\" to point to a custom binary","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unlikely"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((winlog.event_data.EventType:/[Ss][Ee][Tt][Vv][Aa][Ll][Uu][Ee]/ AND registry.path:/.*\\\\[Cc][Ll][Ss][Ii][Dd]\\\\\\{52[Aa]2[Aa][Aa][Aa][Ee]\\-085[Dd]\\-4187\\-97[Ee][Aa]\\-8[Cc]30[Dd][Bb]990436\\}\\\\[Ii][Nn][Pp][Rr][Oo][Cc][Ss][Ee][Rr][Vv][Ee][Rr]32\\\\\\([Dd][Ee][Ff][Aa][Uu][Ll][Tt]\\).*/) AND (NOT (winlog.event_data.Details:/[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32\\\\[Hh][Hh][Cc][Tt][Rr][Ll]\\.[Oo][Cc][Xx]/)))","rule_id":"f10ed525-97fe-4fed-be7c-2feecca941b1","timestamp_override":"event.ingested","references":["https://persistence-info.github.io/Data/hhctrl.html","https://www.hexacorn.com/blog/2018/04/23/beyond-good-ol-run-key-part-77/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((winlog.event_data.EventType:SetValue AND registry.path:*\\\\CLSID\\\\\\{52A2AAAE\\-085D\\-4187\\-97EA\\-8C30DB990436\\}\\\\InprocServer32\\\\\\(Default\\)*) AND (NOT (winlog.event_data.Details:C\\:\\\\Windows\\\\System32\\\\hhctrl.ocx)))`"}
