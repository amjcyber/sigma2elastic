{"id":"dd3ee8cc-f751-41c9-ba53-5a32ed47e563","created_by":"frack113","name":"Suspicious Reg Add Open Command","tags":["attack.credential_access","attack.t1003"],"interval":"5m","description":"Threat actors performed dumping of SAM, SECURITY and SYSTEM registry hives using DelegateExecute key","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.command_line:/.*[Rr][Ee][Gg].*/ AND process.command_line:/.*[Aa][Dd][Dd].*/ AND process.command_line:/.*[Hh][Kk][Cc][Uu]\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Mm][Ss]\\-[Ss][Ee][Tt][Tt][Ii][Nn][Gg][Ss]\\\\[Ss][Hh][Ee][Ll][Ll]\\\\[Oo][Pp][Ee][Nn]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd].*/ AND process.command_line:/.*\\/[Vv][Ee]\\ .*/ AND process.command_line:/.*\\/[Dd].*/) OR (process.command_line:/.*[Rr][Ee][Gg].*/ AND process.command_line:/.*[Aa][Dd][Dd].*/ AND process.command_line:/.*[Hh][Kk][Cc][Uu]\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Mm][Ss]\\-[Ss][Ee][Tt][Tt][Ii][Nn][Gg][Ss]\\\\[Ss][Hh][Ee][Ll][Ll]\\\\[Oo][Pp][Ee][Nn]\\\\[Cc][Oo][Mm][Mm][Aa][Nn][Dd].*/ AND process.command_line:/.*\\/[Vv].*/ AND process.command_line:/.*[Dd][Ee][Ll][Ee][Gg][Aa][Tt][Ee][Ee][Xx][Ee][Cc][Uu][Tt][Ee].*/) OR (process.command_line:/.*[Rr][Ee][Gg].*/ AND process.command_line:/.*[Dd][Ee][Ll][Ee][Tt][Ee].*/ AND process.command_line:/.*[Hh][Kk][Cc][Uu]\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Cc][Ll][Aa][Ss][Ss][Ee][Ss]\\\\[Mm][Ss]\\-[Ss][Ee][Tt][Tt][Ii][Nn][Gg][Ss].*/))","rule_id":"dd3ee8cc-f751-41c9-ba53-5a32ed47e563","timestamp_override":"event.ingested","references":["https://thedfirreport.com/2021/12/13/diavol-ransomware/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.command_line:*reg* AND process.command_line:*add* AND process.command_line:*hkcu\\\\software\\\\classes\\\\ms\\-settings\\\\shell\\\\open\\\\command* AND process.command_line:*\\/ve\\ * AND process.command_line:*\\/d*) OR (process.command_line:*reg* AND process.command_line:*add* AND process.command_line:*hkcu\\\\software\\\\classes\\\\ms\\-settings\\\\shell\\\\open\\\\command* AND process.command_line:*\\/v* AND process.command_line:*DelegateExecute*) OR (process.command_line:*reg* AND process.command_line:*delete* AND process.command_line:*hkcu\\\\software\\\\classes\\\\ms\\-settings*))`"}
