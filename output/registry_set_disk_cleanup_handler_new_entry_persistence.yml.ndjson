{"id":"d4f4e0be-cf12-439f-9e25-4e2cdcf7df5a","created_by":"Nasreddine Bencherchali","name":"Persistence Via Disk Cleanup Handler - NewEntry","tags":["attack.persistence"],"interval":"5m","description":"Detects when an attacker modifies values of the Disk Cleanup Handler in the registry to achieve persistence.\nThe disk cleanup manager is part of the operating system. It displays the dialog box [â€¦] The user has the option of enabling or disabling individual handlers by selecting or clearing their check box in the disk cleanup manager's UI. Although Windows comes with a number of disk cleanup handlers, they aren't designed to handle files produced by other applications. Instead, the disk cleanup manager is designed to be flexible and extensible by enabling any developer to implement and register their own disk cleanup handler. Any developer can extend the available disk cleanup services by implementing and registering a disk cleanup handler.\n","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Legitimate new entry added by windows"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((winlog.event_data.EventType:/[Cc][Rr][Ee][Aa][Tt][Ee][Kk][Ee][Yy]/ AND registry.path:/.*\\\\[Ss][Oo][Ff][Tt][Ww][Aa][Rr][Ee]\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Cc][Uu][Rr][Rr][Ee][Nn][Tt][Vv][Ee][Rr][Ss][Ii][Oo][Nn]\\\\[Ee][Xx][Pp][Ll][Oo][Rr][Ee][Rr]\\\\[Vv][Oo][Ll][Uu][Mm][Ee][Cc][Aa][Cc][Hh][Ee][Ss]\\\\.*/) AND (NOT (registry.path:(/.*\\\\[Aa][Cc][Tt][Ii][Vv][Ee]\\ [Ss][Ee][Tt][Uu][Pp]\\ [Tt][Ee][Mm][Pp]\\ [Ff][Oo][Ll][Dd][Ee][Rr][Ss]/ OR /.*\\\\[Bb][Rr][Aa][Nn][Cc][Hh][Cc][Aa][Cc][Hh][Ee]/ OR /.*\\\\[Cc][Oo][Nn][Tt][Ee][Nn][Tt]\\ [Ii][Nn][Dd][Ee][Xx][Ee][Rr]\\ [Cc][Ll][Ee][Aa][Nn][Ee][Rr]/ OR /.*\\\\[Dd]3[Dd]\\ [Ss][Hh][Aa][Dd][Ee][Rr]\\ [Cc][Aa][Cc][Hh][Ee]/ OR /.*\\\\[Dd][Ee][Ll][Ii][Vv][Ee][Rr][Yy]\\ [Oo][Pp][Tt][Ii][Mm][Ii][Zz][Aa][Tt][Ii][Oo][Nn]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Dd][Ee][Vv][Ii][Cc][Ee]\\ [Dd][Rr][Ii][Vv][Ee][Rr]\\ [Pp][Aa][Cc][Kk][Aa][Gg][Ee][Ss]/ OR /.*\\\\[Dd][Ii][Aa][Gg][Nn][Oo][Ss][Tt][Ii][Cc]\\ [Dd][Aa][Tt][Aa]\\ [Vv][Ii][Ee][Ww][Ee][Rr]\\ [Dd][Aa][Tt][Aa][Bb][Aa][Ss][Ee]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Dd][Oo][Ww][Nn][Ll][Oo][Aa][Dd][Ee][Dd]\\ [Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Dd][Oo][Ww][Nn][Ll][Oo][Aa][Dd][Ss][Ff][Oo][Ll][Dd][Ee][Rr]/ OR /.*\\\\[Ff][Ee][Ee][Dd][Bb][Aa][Cc][Kk]\\ [Hh][Uu][Bb]\\ [Aa][Rr][Cc][Hh][Ii][Vv][Ee]\\ [Ll][Oo][Gg]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Ii][Nn][Tt][Ee][Rr][Nn][Ee][Tt]\\ [Cc][Aa][Cc][Hh][Ee]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Ll][Aa][Nn][Gg][Uu][Aa][Gg][Ee]\\ [Pp][Aa][Cc][Kk]/ OR /.*\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\ [Oo][Ff][Ff][Ii][Cc][Ee]\\ [Tt][Ee][Mm][Pp]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Oo][Ff][Ff][Ll][Ii][Nn][Ee]\\ [Pp][Aa][Gg][Ee][Ss]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Oo][Ll][Dd]\\ [Cc][Hh][Kk][Dd][Ss][Kk]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Pp][Rr][Ee][Vv][Ii][Oo][Uu][Ss]\\ [Ii][Nn][Ss][Tt][Aa][Ll][Ll][Aa][Tt][Ii][Oo][Nn][Ss]/ OR /.*\\\\[Rr][Ee][Cc][Yy][Cc][Ll][Ee]\\ [Bb][Ii][Nn]/ OR /.*\\\\[Rr][Ee][Tt][Aa][Ii][Ll][Dd][Ee][Mm][Oo]\\ [Oo][Ff][Ff][Ll][Ii][Nn][Ee]\\ [Cc][Oo][Nn][Tt][Ee][Nn][Tt]/ OR /.*\\\\[Ss][Ee][Tt][Uu][Pp]\\ [Ll][Oo][Gg]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Ss][Yy][Ss][Tt][Ee][Mm]\\ [Ee][Rr][Rr][Oo][Rr]\\ [Mm][Ee][Mm][Oo][Rr][Yy]\\ [Dd][Uu][Mm][Pp]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Ss][Yy][Ss][Tt][Ee][Mm]\\ [Ee][Rr][Rr][Oo][Rr]\\ [Mm][Ii][Nn][Ii][Dd][Uu][Mm][Pp]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Tt][Ee][Mm][Pp][Oo][Rr][Aa][Rr][Yy]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Tt][Ee][Mm][Pp][Oo][Rr][Aa][Rr][Yy]\\ [Ss][Ee][Tt][Uu][Pp]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Tt][Ee][Mm][Pp][Oo][Rr][Aa][Rr][Yy]\\ [Ss][Yy][Nn][Cc]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Tt][Hh][Uu][Mm][Bb][Nn][Aa][Ii][Ll]\\ [Cc][Aa][Cc][Hh][Ee]/ OR /.*\\\\[Uu][Pp][Dd][Aa][Tt][Ee]\\ [Cc][Ll][Ee][Aa][Nn][Uu][Pp]/ OR /.*\\\\[Uu][Pp][Gg][Rr][Aa][Dd][Ee]\\ [Dd][Ii][Ss][Cc][Aa][Rr][Dd][Ee][Dd]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Uu][Ss][Ee][Rr]\\ [Ff][Ii][Ll][Ee]\\ [Vv][Ee][Rr][Ss][Ii][Oo][Nn][Ss]/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Dd][Ee][Ff][Ee][Nn][Dd][Ee][Rr]/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Ee][Rr][Rr][Oo][Rr]\\ [Rr][Ee][Pp][Oo][Rr][Tt][Ii][Nn][Gg]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Ee][Ss][Dd]\\ [Ii][Nn][Ss][Tt][Aa][Ll][Ll][Aa][Tt][Ii][Oo][Nn]\\ [Ff][Ii][Ll][Ee][Ss]/ OR /.*\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\ [Uu][Pp][Gg][Rr][Aa][Dd][Ee]\\ [Ll][Oo][Gg]\\ [Ff][Ii][Ll][Ee][Ss]/))))","rule_id":"d4f4e0be-cf12-439f-9e25-4e2cdcf7df5a","timestamp_override":"event.ingested","references":["https://persistence-info.github.io/Data/diskcleanuphandler.html","https://www.hexacorn.com/blog/2018/09/02/beyond-good-ol-run-key-part-86/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((winlog.event_data.EventType:CreateKey AND registry.path:*\\\\SOFTWARE\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Explorer\\\\VolumeCaches\\\\*) AND (NOT (registry.path:(*\\\\Active\\ Setup\\ Temp\\ Folders OR *\\\\BranchCache OR *\\\\Content\\ Indexer\\ Cleaner OR *\\\\D3D\\ Shader\\ Cache OR *\\\\Delivery\\ Optimization\\ Files OR *\\\\Device\\ Driver\\ Packages OR *\\\\Diagnostic\\ Data\\ Viewer\\ database\\ files OR *\\\\Downloaded\\ Program\\ Files OR *\\\\DownloadsFolder OR *\\\\Feedback\\ Hub\\ Archive\\ log\\ files OR *\\\\Internet\\ Cache\\ Files OR *\\\\Language\\ Pack OR *\\\\Microsoft\\ Office\\ Temp\\ Files OR *\\\\Offline\\ Pages\\ Files OR *\\\\Old\\ ChkDsk\\ Files OR *\\\\Previous\\ Installations OR *\\\\Recycle\\ Bin OR *\\\\RetailDemo\\ Offline\\ Content OR *\\\\Setup\\ Log\\ Files OR *\\\\System\\ error\\ memory\\ dump\\ files OR *\\\\System\\ error\\ minidump\\ files OR *\\\\Temporary\\ Files OR *\\\\Temporary\\ Setup\\ Files OR *\\\\Temporary\\ Sync\\ Files OR *\\\\Thumbnail\\ Cache OR *\\\\Update\\ Cleanup OR *\\\\Upgrade\\ Discarded\\ Files OR *\\\\User\\ file\\ versions OR *\\\\Windows\\ Defender OR *\\\\Windows\\ Error\\ Reporting\\ Files OR *\\\\Windows\\ ESD\\ installation\\ files OR *\\\\Windows\\ Upgrade\\ Log\\ Files))))`"}
