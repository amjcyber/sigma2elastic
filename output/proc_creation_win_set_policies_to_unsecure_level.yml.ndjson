{"id":"87e3c4e8-a6a8-4ad9-bb4f-46e7ff99a180","created_by":"frack113","name":"Change PowerShell Policies to an Insecure Level","tags":["attack.execution","attack.t1059.001"],"interval":"5m","description":"Detects use of executionpolicy option to set insecure policies","risk_score":47,"enabled":true,"severity":"medium","false_positives":["Administrator script"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.command_line:(/.*\\ \\-[Ee][Xx][Ee][Cc][Uu][Tt][Ii][Oo][Nn][Pp][Oo][Ll][Ii][Cc][Yy]\\ .*/ OR /.*\\ \\-[Ee][Pp]\\ .*/ OR /.*\\ \\-[Ee][Xx][Ee][Cc]\\ .*/) AND process.command_line:(/.*[Uu][Nn][Rr][Ee][Ss][Tt][Rr][Ii][Cc][Tt][Ee][Dd].*/ OR /.*[Bb][Yy][Pp][Aa][Ss][Ss].*/ OR /.*[Rr][Ee][Mm][Oo][Tt][Ee][Ss][Ii][Gg][Nn][Ee][Dd].*/)) AND (NOT (process.command_line:(/.*[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm]\\ [Ff][Ii][Ll][Ee][Ss].*/ OR /.*[Cc]\\:\\\\[Pp][Rr][Oo][Gg][Rr][Aa][Mm][Dd][Aa][Tt][Aa].*/ OR /.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Rr][Oo][Aa][Mm][Ii][Nn][Gg]\\\\[Cc][Oo][Dd][Ee]\\\\.*/))))","rule_id":"87e3c4e8-a6a8-4ad9-bb4f-46e7ff99a180","timestamp_override":"event.ingested","references":["https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7.1","https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.1","https://adsecurity.org/?p=2604","https://thedfirreport.com/2021/11/01/from-zero-to-domain-admin/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.command_line:(*\\ \\-executionpolicy\\ * OR *\\ \\-ep\\ * OR *\\ \\-exec\\ *) AND process.command_line:(*Unrestricted* OR *bypass* OR *RemoteSigned*)) AND (NOT (process.command_line:(*C\\:\\\\Program\\ Files* OR *C\\:\\\\ProgramData* OR *\\\\AppData\\\\Roaming\\\\Code\\\\*))))`"}
