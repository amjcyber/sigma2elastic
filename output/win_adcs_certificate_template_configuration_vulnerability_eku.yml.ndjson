{"id":"bfbd3291-de87-4b7c-88a2-d6a5deb28668","created_by":"Orlinum , BlueDefenZer","name":"ADCS Certificate Template Configuration Vulnerability with Risky EKU","tags":["attack.privilege_escalation","attack.credential_access"],"interval":"5m","description":"Detects certificate creation with template allowing risk permission subject and risky EKU","risk_score":73,"enabled":true,"severity":"high","false_positives":["Administrator activity","Proxy SSL certificate with subject modification","Smart card enrollement"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(winlog.channel:Security AND ((event.code:4898 AND TemplateContent:(/.*1\\.3\\.6\\.1\\.5\\.5\\.7\\.3\\.2.*/ OR /.*1\\.3\\.6\\.1\\.5\\.2\\.3\\.4.*/ OR /.*1\\.3\\.6\\.1\\.4\\.1\\.311\\.20\\.2\\.2.*/ OR /.*2\\.5\\.29\\.37\\.0.*/) AND TemplateContent:/.*[Cc][Tt]_[Ff][Ll][Aa][Gg]_[Ee][Nn][Rr][Oo][Ll][Ll][Ee][Ee]_[Ss][Uu][Pp][Pp][Ll][Ii][Ee][Ss]_[Ss][Uu][Bb][Jj][Ee][Cc][Tt].*/) OR (event.code:4899 AND NewTemplateContent:(/.*1\\.3\\.6\\.1\\.5\\.5\\.7\\.3\\.2.*/ OR /.*1\\.3\\.6\\.1\\.5\\.2\\.3\\.4.*/ OR /.*1\\.3\\.6\\.1\\.4\\.1\\.311\\.20\\.2\\.2.*/ OR /.*2\\.5\\.29\\.37\\.0.*/) AND NewTemplateContent:/.*[Cc][Tt]_[Ff][Ll][Aa][Gg]_[Ee][Nn][Rr][Oo][Ll][Ll][Ee][Ee]_[Ss][Uu][Pp][Pp][Ll][Ii][Ee][Ss]_[Ss][Uu][Bb][Jj][Ee][Cc][Tt].*/)))","rule_id":"bfbd3291-de87-4b7c-88a2-d6a5deb28668","timestamp_override":"event.ingested","references":["https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(winlog.channel:Security AND ((event.code:4898 AND TemplateContent:(*1.3.6.1.5.5.7.3.2* OR *1.3.6.1.5.2.3.4* OR *1.3.6.1.4.1.311.20.2.2* OR *2.5.29.37.0*) AND TemplateContent:*CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT*) OR (event.code:4899 AND NewTemplateContent:(*1.3.6.1.5.5.7.3.2* OR *1.3.6.1.5.2.3.4* OR *1.3.6.1.4.1.311.20.2.2* OR *2.5.29.37.0*) AND NewTemplateContent:*CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT*)))`"}
