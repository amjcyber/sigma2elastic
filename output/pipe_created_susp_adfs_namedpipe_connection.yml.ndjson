{"id":"1ea13e8c-03ea-409b-877d-ce5c3d2c1cb3","created_by":"Roberto Rodriguez @Cyb3rWard0g","name":"ADFS Database Named Pipe Connection","tags":["attack.collection","attack.t1005"],"interval":"5m","description":"Detects suspicious local connections via a named pipe to the AD FS configuration database (Windows Internal Database). Used to access information such as the AD FS configuration settings which contains sensitive information used to sign SAML tokens.","risk_score":73,"enabled":true,"severity":"high","false_positives":["Processes in the filter condition"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(file.name:/\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]##[Ww][Ii][Dd]\\\\[Tt][Ss][Qq][Ll]\\\\[Qq][Uu][Ee][Rr][Yy]/ AND (NOT (process.executable:(/.*\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\.[Ii][Dd][Ee][Nn][Tt][Ii][Tt][Yy][Ss][Ee][Rr][Vv][Ee][Rr]\\.[Ss][Ee][Rr][Vv][Ii][Cc][Ee][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\.[Ii][Dd][Ee][Nn][Tt][Ii][Tt][Yy]\\.[Hh][Ee][Aa][Ll][Tt][Hh]\\.[Aa][Dd][Ff][Ss]\\.[Pp][Ss][Hh][Ss][Uu][Rr][Rr][Oo][Gg][Aa][Tt][Ee]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Aa][Zz][Uu][Rr][Ee][Aa][Dd][Cc][Oo][Nn][Nn][Ee][Cc][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Ii][Cc][Rr][Oo][Ss][Oo][Ff][Tt]\\.[Tt][Rr][Ii]\\.[Ss][Ee][Nn][Ss][Oo][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ww][Ss][Mm][Pp][Rr][Oo][Vv][Hh][Oo][Ss][Tt]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Mm][Mm][Cc]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Ss][Qq][Ll][Ss][Ee][Rr][Vv][Rr]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Tt][Ss][Ss][Dd][Ii][Ss]\\.[Ee][Xx][Ee]/))))","rule_id":"1ea13e8c-03ea-409b-877d-ce5c3d2c1cb3","timestamp_override":"event.ingested","references":["https://github.com/Azure/Azure-Sentinel/blob/f99542b94afe0ad2f19a82cc08262e7ac8e1428e/Detections/SecurityEvent/ADFSDBNamedPipeConnection.yaml","https://o365blog.com/post/adfs/","https://github.com/Azure/SimuLand"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(file.name:\\\\MICROSOFT##WID\\\\tsql\\\\query AND (NOT (process.executable:(*\\\\Microsoft.IdentityServer.ServiceHost.exe OR *\\\\Microsoft.Identity.Health.Adfs.PshSurrogate.exe OR *\\\\AzureADConnect.exe OR *\\\\Microsoft.Tri.Sensor.exe OR *\\\\wsmprovhost.exe OR *\\\\mmc.exe OR *\\\\sqlservr.exe OR *\\\\tssdis.exe))))`"}
