{"id":"e32f92d1-523e-49c3-9374-bdb13b46a3ba","created_by":"Florian Roth","name":"Suspicious MSHTA Process Patterns","tags":["attack.execution","attack.t1106"],"interval":"5m","description":"Detects suspicious mshta process patterns","risk_score":73,"enabled":true,"severity":"high","false_positives":["Unknown"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"(((process.executable:/.*\\\\[Mm][Ss][Hh][Tt][Aa]\\.[Ee][Xx][Ee]/ AND (process.parent.executable:(/.*\\\\[Cc][Mm][Dd]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Oo][Ww][Ee][Rr][Ss][Hh][Ee][Ll][Ll]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Pp][Ww][Ss][Hh]\\.[Ee][Xx][Ee]/) OR process.command_line:(/.*\\\\[Aa][Pp][Pp][Dd][Aa][Tt][Aa]\\\\[Ll][Oo][Cc][Aa][Ll].*/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Tt][Ee][Mm][Pp].*/ OR /.*[Cc]\\:\\\\[Uu][Ss][Ee][Rr][Ss]\\\\[Pp][Uu][Bb][Ll][Ii][Cc].*/))) OR (process.executable:/.*\\\\[Mm][Ss][Hh][Tt][Aa]\\.[Ee][Xx][Ee]/ AND (NOT (process.executable:(/.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Tt][Ee][Mm]32.*/ OR /.*[Cc]\\:\\\\[Ww][Ii][Nn][Dd][Oo][Ww][Ss]\\\\[Ss][Yy][Ss][Ww][Oo][Ww]64.*/))))) OR (process.executable:/.*\\\\[Mm][Ss][Hh][Tt][Aa]\\.[Ee][Xx][Ee]/ AND (NOT (process.command_line:(/.*\\.[Hh][Tt][Mm].*/ OR /.*\\.[Hh][Tt][Aa].*/) AND process.command_line:(/.*[Mm][Ss][Hh][Tt][Aa]\\.[Ee][Xx][Ee]/ OR /.*[Mm][Ss][Hh][Tt][Aa]/)))))","rule_id":"e32f92d1-523e-49c3-9374-bdb13b46a3ba","timestamp_override":"event.ingested","references":["https://en.wikipedia.org/wiki/HTML_Application","https://www.echotrail.io/insights/search/mshta.exe","https://app.any.run/tasks/34221348-072d-4b70-93f3-aa71f6ebecad/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`(((process.executable:*\\\\mshta.exe AND (process.parent.executable:(*\\\\cmd.exe OR *\\\\powershell.exe OR *\\\\pwsh.exe) OR process.command_line:(*\\\\AppData\\\\Local* OR *C\\:\\\\Windows\\\\Temp* OR *C\\:\\\\Users\\\\Public*))) OR (process.executable:*\\\\mshta.exe AND (NOT (process.executable:(*C\\:\\\\Windows\\\\System32* OR *C\\:\\\\Windows\\\\SysWOW64*))))) OR (process.executable:*\\\\mshta.exe AND (NOT (process.command_line:(*.htm* OR *.hta*) AND process.command_line:(*mshta.exe OR *mshta)))))`"}
