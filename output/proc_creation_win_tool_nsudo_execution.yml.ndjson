{"id":"771d1eb5-9587-4568-95fb-9ec44153a012","created_by":"Florian Roth, Nasreddine Bencherchali","name":"NSudo Tool Execution","tags":["attack.execution","attack.t1569.002","attack.s0029"],"interval":"5m","description":"Detects the use of NSudo tool for command execution","risk_score":73,"enabled":true,"severity":"high","false_positives":["Legitimate use by administrators"],"from":"now-720s","type":"query","language":"lucene","index":["winlogbeat-*","logs-*"],"query":"((process.executable:(/.*\\\\[Nn][Ss][Uu][Dd][Oo]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Nn][Ss][Uu][Dd][Oo][Ll][Cc]\\.[Ee][Xx][Ee]/ OR /.*\\\\[Nn][Ss][Uu][Dd][Oo][Ll][Gg]\\.[Ee][Xx][Ee]/) OR process.pe.original_file_name:(/[Nn][Ss][Uu][Dd][Oo]\\.[Ee][Xx][Ee]/ OR /[Nn][Ss][Uu][Dd][Oo][Ll][Cc]\\.[Ee][Xx][Ee]/ OR /[Nn][Ss][Uu][Dd][Oo][Ll][Gg]\\.[Ee][Xx][Ee]/)) AND process.command_line:(/.*\\-[Uu]\\:[Ss]\\ .*/ OR /.*\\-[Uu]\\:[Tt]\\ .*/ OR /.*\\-[Uu]\\:[Ee]\\ .*/ OR /.*\\-[Pp]\\:[Ee]\\ .*/ OR /.*\\-[Mm]\\:[Ss]\\ .*/ OR /.*\\-[Mm]\\:[Hh]\\ .*/ OR /.*\\-[Uu]\\=[Ss]\\ .*/ OR /.*\\-[Uu]\\=[Tt]\\ .*/ OR /.*\\-[Uu]\\=[Ee]\\ .*/ OR /.*\\-[Pp]\\=[Ee]\\ .*/ OR /.*\\-[Mm]\\=[Ss]\\ .*/ OR /.*\\-[Mm]\\=[Hh]\\ .*/))","rule_id":"771d1eb5-9587-4568-95fb-9ec44153a012","timestamp_override":"event.ingested","references":["https://nsudo.m2team.org/en-us/","https://www.winhelponline.com/blog/run-program-as-system-localsystem-account-windows/"],"note":"**Detection Rule without Regex for better understanding. Be careful, this way is case sensitive:**`((process.executable:(*\\\\NSudo.exe OR *\\\\NSudoLC.exe OR *\\\\NSudoLG.exe) OR process.pe.original_file_name:(NSudo.exe OR NSudoLC.exe OR NSudoLG.exe)) AND process.command_line:(*\\-U\\:S\\ * OR *\\-U\\:T\\ * OR *\\-U\\:E\\ * OR *\\-P\\:E\\ * OR *\\-M\\:S\\ * OR *\\-M\\:H\\ * OR *\\-U\\=S\\ * OR *\\-U\\=T\\ * OR *\\-U\\=E\\ * OR *\\-P\\=E\\ * OR *\\-M\\=S\\ * OR *\\-M\\=H\\ *))`"}
